<!DOCTYPE html>



<html lang="en" 
  
    mode="dark"
  
>

  <!--
  The Head
  v2.0
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2017-2019 Cotes Chung
  MIT License
-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="theme" content="Chirpy v2.7.2">

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="유니티 - 물리 기반 먼지 시뮬레이션" />
<meta name="author" content="Rito15" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="목표 수십만 ~ 백만 개의 먼지를 렌더링한다. 먼지들의 움직임을 물리 기반으로 직접 구현하여 시뮬레이션한다. 진공 청소기로 먼지들을 예쁘게 빨아들인다." />
<meta property="og:description" content="목표 수십만 ~ 백만 개의 먼지를 렌더링한다. 먼지들의 움직임을 물리 기반으로 직접 구현하여 시뮬레이션한다. 진공 청소기로 먼지들을 예쁘게 빨아들인다." />
<link rel="canonical" href="https://rito15.github.io/posts/unity-million-dust-simulation/" />
<meta property="og:url" content="https://rito15.github.io/posts/unity-million-dust-simulation/" />
<meta property="og:site_name" content="Rito15" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-09-27T17:00:00+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="유니티 - 물리 기반 먼지 시뮬레이션" />
<meta name="google-site-verification" content="google_meta_tag_verification" />
<script type="application/ld+json">
{"dateModified":"2021-10-28T00:14:13+09:00","description":"목표 수십만 ~ 백만 개의 먼지를 렌더링한다. 먼지들의 움직임을 물리 기반으로 직접 구현하여 시뮬레이션한다. 진공 청소기로 먼지들을 예쁘게 빨아들인다.","datePublished":"2021-09-27T17:00:00+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://rito15.github.io/posts/unity-million-dust-simulation/"},"headline":"유니티 - 물리 기반 먼지 시뮬레이션","url":"https://rito15.github.io/posts/unity-million-dust-simulation/","author":{"@type":"Person","name":"Rito15"},"@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <title>유니티 - 물리 기반 먼지 시뮬레이션 | Rito15
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://www.favicon-generator.org/
  v2.0
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2019 Cotes Chung
  Published under the MIT license
-->



<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon">
<link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon">

<link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png">
<link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png">
<link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png">

<link rel="icon" type="image/png" sizes="192x192"  href="/assets/img/favicons/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">

<link rel="manifest" href="/assets/img/favicons/manifest.json">
<meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'>
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">


  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">

  <!-- GA -->
  

  <!-- jsDelivr CDN -->
  <link rel="preconnect" href="cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="cdn.jsdelivr.net">

  <!-- Bootstrap -->
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
    integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous">

  <!-- Font Awesome -->
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"
    integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ="
    crossorigin="anonymous">

  <!--
  CSS selector for site.
  Chirpy v2.3
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2020 Cotes Chung
  MIT Licensed
-->






<link rel="preload" href="/assets/css/post.css" as="style">
<link rel="stylesheet" href="/assets/css/post.css">


  
    <link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css">
    <link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" />
  



  <!-- JavaScripts -->

  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>

  <script defer
    src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script>

  <!--
  JS selector for site.
  Chirpy v2.3
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2020 Cotes Chung
  MIT Licensed
-->





<script async src="/assets/js/post.min.js"></script>


  <!-- MathJax -->
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>





</head>


  <body data-spy="scroll" data-target="#toc">

    <!--
  The Side Bar
  v2.0
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2017-2019 Cotes Chung
  MIT License
-->

<div id="sidebar" class="d-flex flex-column align-items-end">

  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" alt="avatar" class="mx-auto">
        
        <img src="/assets/img/favicons/android-icon-192x192.png" alt="avatar" onerror="this.style.display='none'">
      </a>
    </div>

    <div class="site-title mt-3">
      <a href="/">Rito15</a>
    </div>

    <div class="site-subtitle font-italic">Unity Csharp Developer</div>

  </div><!-- .profile-wrapper -->

  <ul class="w-100">
    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs -->
    
    <li class="nav-item">
      <a href="/tabs/categories/" class="nav-link">
        <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i>
        <span>CATEGORIES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tabs/tags/" class="nav-link">
        <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i>
        <span>TAGS</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tabs/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i>
        <span>ARCHIVES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tabs/about/" class="nav-link">
        <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i>
        <span>ABOUT</span>
      </a>
    </li> <!-- .nav-item -->
    

  </ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center">

    
      

      
      <a href="https://github.com/rito15" aria-label="github"
        
        target="_blank" rel="noopener">
        <i class="fab fa-github-alt"></i>
      </a>
      

    
      

      
      <a href="
          javascript:location.href = 'mailto:' + ['ghdtkals15','gmail.com'].join('@')" aria-label="email"
        
        >
        <i class="fas fa-envelope"></i>
      </a>
      

    
      

      
      <a href="/feed.xml" aria-label="rss"
        
        >
        <i class="fas fa-rss"></i>
      </a>
      

    

    

  </div> <!-- .sidebar-bottom -->

</div><!-- #sidebar -->


    <!--
  The Top Bar
  v2.0
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2017-2019 Cotes Chung
  MIT License
-->
<div id="topbar-wrapper" class="row justify-content-center topbar-down">
  <div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between">
    <span id="breadcrumb">
      
        
        <span>
          <a href="/">
            Posts
          </a>
        </span>
        
      

      
        <span>유니티 - 물리 기반 먼지 시뮬레이션</span>
      

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" placeholder="Search...">
      <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i>
    </span>
    <span id="search-cancel" >Cancel</span>
  </div>

</div>


    <div id="main-wrapper">
      <div id="main">

        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->


<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->


<!-- Add attribute 'hide-bullet' to the checkbox list -->




  

  

  <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->
  
  

  

  



<!-- return -->
<div class="row">

  <div id="post-wrapper" class="col-12 col-lg-11 col-xl-8">

    <div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

      <h1 data-toc-skip>유니티 - 물리 기반 먼지 시뮬레이션</h1>

      <div class="post-meta text-muted d-flex flex-column">
        <!-- Published date and author -->
        <div>
          <!--
  Date format snippet

  v2.4.1
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2020 Cotes Chung
  MIT License
-->
<span class="timeago "
  
    data-toggle="tooltip"
    data-placement="bottom"
    title="Mon, Sep 27, 2021,  5:00 PM +0900"
  >

  
  

  
    Sep 27
  

  <i class="unloaded">2021-09-27T17:00:00+09:00</i>

</span>
          by
          <span class="author">
            Rito15
          </span>
        </div>

        <div>
          <!-- lastmod -->
          
          <span>
            Updated
            <!--
  Date format snippet

  v2.4.1
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2020 Cotes Chung
  MIT License
-->
<span class="timeago lastmod"
  
    data-toggle="tooltip"
    data-placement="bottom"
    title="Thu, Oct 28, 2021, 12:14 AM +0900"
  >

  
  

  
    Oct 28
  

  <i class="unloaded">2021-10-28T00:14:13+09:00</i>

</span>
          </span>
          

          <!-- read time -->
          <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->






<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom" title="21820 words">121 min</span>


          <!-- page views -->
          

          <!-- HITS -->
          &nbsp;
          <a href="https://hits.seeyoufarm.com"><img min-width="94" src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https://rito15.github.io/posts/unity-million-dust-simulation/%2F&count_bg=%23AC58FA&title_bg=%23555555&icon=&icon_color=%23E7E7E7&title=views&edge_flat=false"/></a> 

        </div>

      </div> <!-- .post-meta -->

      <div class="post-content">

        

        <h1 id="목표">목표</h1>
<hr />
<ul>
  <li>수십만 ~ 백만 개의 먼지를 렌더링한다.</li>
  <li>먼지들의 움직임을 물리 기반으로 직접 구현하여 시뮬레이션한다.</li>
  <li>진공 청소기로 먼지들을 예쁘게 빨아들인다.</li>
</ul>

<p><br /></p>

<!-- --------------------------------------------------------------------------- -->

<h1 id="주요-개념">주요 개념</h1>
<hr />

<h2 id="compute-buffer"><strong>Compute Buffer</strong></h2>
<ul>
  <li>큰 병렬 데이터를 GPU에 전달하거나 쉐이더끼리 공유하기 위해 사용한다.</li>
  <li>Vert/Frag, Compute Shader에서 <code class="language-plaintext highlighter-rouge">StructuredBuffer&lt;T&gt;</code> 타입 변수로 사용할 수 있다.</li>
</ul>

<h2 id="graphicsdrawmeshinstancedindirect"><strong>Graphics.DrawMeshInstancedIndirect()</strong></h2>
<ul>
  <li>컴퓨트 버퍼의 메시 데이터를 GPU Instancing을 적용하여 대규모로 렌더링할 수 있다.</li>
</ul>

<h2 id="compute-shader"><strong>Compute Shader</strong></h2>
<ul>
  <li>GPGPU를 통해 병렬적으로 연산을 적용할 수 있다.</li>
</ul>

<p><br /></p>

<!-- --------------------------------------------------------------------------- -->

<h1 id="1-10만개의-먼지-만들기">1. 10만개의 먼지 만들기</h1>
<hr />

<details>
  <summary> 
…
</summary>

  <p><br /></p>

  <p>GPU 인스턴싱을 통해 십만 단위의 오브젝트를 동시에 렌더링한다.</p>

  <p>렌더링될 메시의 버텍스 개수에 따라 성능 차이가 커지므로,</p>

  <p>일단 메시는 단순한 큐브 메시를 사용한다.</p>

  <p><br /></p>

  <h2 id="dustmanagercs"><strong>Dustmanager.cs</strong></h2>

  <ul>
    <li>먼지 생성 및 관리를 담당한다.</li>
  </ul>

  <details>
    <summary> 
Fields
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="k">private</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">TRUE</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
<span class="k">private</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">FALSE</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

<span class="k">private</span> <span class="k">struct</span> <span class="nc">Dust</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">Vector3</span> <span class="n">position</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">isAlive</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">[</span><span class="nf">Header</span><span class="p">(</span><span class="s">"Dust Options"</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">Mesh</span> <span class="n">DustMesh</span><span class="p">;</span>         <span class="c1">// 먼지 메시</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">Material</span> <span class="n">DustMaterial</span><span class="p">;</span> <span class="c1">// 먼지 마테리얼</span>

<span class="p">[</span><span class="n">Space</span><span class="p">]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">int</span> <span class="n">instanceNumber</span> <span class="p">=</span> <span class="m">100000</span><span class="p">;</span>    <span class="c1">// 생성할 먼지 개수</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">distributionRange</span> <span class="p">=</span> <span class="m">100f</span><span class="p">;</span> <span class="c1">// 먼지 분포 범위(정사각형 너비)</span>
<span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0.01f</span><span class="p">,</span> <span class="m">2f</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">DustScale</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>           <span class="c1">// 먼지 크기</span>

<span class="k">private</span> <span class="n">ComputeBuffer</span> <span class="n">dustBuffer</span><span class="p">;</span> <span class="c1">// 먼지 데이터 버퍼(위치, ...)</span>
<span class="k">private</span> <span class="n">ComputeBuffer</span> <span class="n">argsBuffer</span><span class="p">;</span> <span class="c1">// 먼지 렌더링 데이터 버퍼</span>

<span class="k">private</span> <span class="n">Bounds</span> <span class="n">frustumOverlapBounds</span><span class="p">;</span>
<span class="k">private</span> <span class="n">Dust</span><span class="p">[]</span> <span class="n">DustArray</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <details>
    <summary> 
Unity Event Methods
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="k">private</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nf">InitBuffers</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">DustMaterial</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"_Scale"</span><span class="p">,</span> <span class="n">DustScale</span><span class="p">);</span>
    <span class="n">Graphics</span><span class="p">.</span><span class="nf">DrawMeshInstancedIndirect</span><span class="p">(</span><span class="n">DustMesh</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">DustMaterial</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">argsBuffer</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">OnDestroy</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">dustBuffer</span><span class="p">.</span><span class="nf">Release</span><span class="p">();</span>
    <span class="n">argsBuffer</span><span class="p">.</span><span class="nf">Release</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">private</span> <span class="n">GUIStyle</span> <span class="n">boxStyle</span><span class="p">;</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">OnGUI</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">boxStyle</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">boxStyle</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">GUIStyle</span><span class="p">(</span><span class="n">GUI</span><span class="p">.</span><span class="n">skin</span><span class="p">.</span><span class="n">box</span><span class="p">);</span>
        <span class="n">boxStyle</span><span class="p">.</span><span class="n">fontSize</span> <span class="p">=</span> <span class="m">48</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">float</span> <span class="n">scWidth</span> <span class="p">=</span> <span class="n">Screen</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">scHeight</span> <span class="p">=</span> <span class="n">Screen</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
    <span class="n">Rect</span> <span class="n">r</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Rect</span><span class="p">(</span><span class="n">scWidth</span> <span class="p">*</span> <span class="m">0.04f</span><span class="p">,</span> <span class="n">scHeight</span> <span class="p">*</span> <span class="m">0.04f</span><span class="p">,</span> <span class="n">scWidth</span> <span class="p">*</span> <span class="m">0.25f</span><span class="p">,</span> <span class="n">scHeight</span> <span class="p">*</span> <span class="m">0.05f</span><span class="p">);</span>

    <span class="n">GUI</span><span class="p">.</span><span class="nf">Box</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">$"</span><span class="p">{</span><span class="n">aliveNumber</span><span class="p">:</span><span class="err">#</span><span class="p">,</span><span class="err">###</span><span class="p">,</span><span class="err">##</span><span class="m">0</span><span class="p">}</span><span class="s"> / </span><span class="p">{</span><span class="n">instanceNumber</span><span class="p">:</span><span class="err">#</span><span class="p">,</span><span class="err">###</span><span class="p">,</span><span class="err">##</span><span class="m">0</span><span class="p">}</span><span class="s">"</span><span class="p">,</span> <span class="n">boxStyle</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <details>
    <summary> 
Methods
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre><span class="c1">/// &lt;summary&gt; 컴퓨트 버퍼들 생성 &lt;/summary&gt;</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">InitBuffers</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Args Buffer</span>
    <span class="c1">// IndirectArguments로 사용되는 컴퓨트 버퍼의 stride는 20byte 이상이어야 한다.</span>
    <span class="c1">// 따라서 파라미터가 앞의 2개만 필요하지만, 뒤에 의미 없는 파라미터 3개를 더 넣어준다.</span>
    <span class="kt">uint</span><span class="p">[]</span> <span class="n">argsData</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">uint</span><span class="p">[]</span> <span class="p">{</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">DustMesh</span><span class="p">.</span><span class="nf">GetIndexCount</span><span class="p">(</span><span class="m">0</span><span class="p">),</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">instanceNumber</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span> <span class="p">};</span>
    <span class="n">aliveNumber</span> <span class="p">=</span> <span class="n">instanceNumber</span><span class="p">;</span>

    <span class="n">argsBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">5</span> <span class="p">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint</span><span class="p">),</span> <span class="n">ComputeBufferType</span><span class="p">.</span><span class="n">IndirectArguments</span><span class="p">);</span>
    <span class="n">argsBuffer</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="n">argsData</span><span class="p">);</span>

    <span class="nf">PopulateDusts</span><span class="p">();</span>

    <span class="c1">// Dust Buffer</span>
    <span class="n">dustBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="n">instanceNumber</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="p">*</span> <span class="m">3</span> <span class="p">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
    <span class="n">dustBuffer</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="n">DustArray</span><span class="p">);</span>
    <span class="n">DustMaterial</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="s">"_DustBuffer"</span><span class="p">,</span> <span class="n">dustBuffer</span><span class="p">);</span>

    <span class="c1">// 카메라 프러스텀이 이 영역과 겹치지 않으면 렌더링되지 않는다.</span>
    <span class="n">frustumOverlapBounds</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Bounds</span><span class="p">(</span><span class="n">Vector3</span><span class="p">.</span><span class="n">zero</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Vector3</span><span class="p">(</span><span class="n">distributionRange</span><span class="p">,</span> <span class="m">1f</span><span class="p">,</span> <span class="n">distributionRange</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">/// &lt;summary&gt; 먼지들을 영역 내의 무작위 위치에 생성한다. &lt;/summary&gt;</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">PopulateDusts</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">DustArray</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dust</span><span class="p">[</span><span class="n">instanceNumber</span><span class="p">];</span>

    <span class="kt">float</span> <span class="n">min</span> <span class="p">=</span> <span class="p">-</span><span class="m">0.5f</span> <span class="p">*</span> <span class="n">distributionRange</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">max</span> <span class="p">=</span> <span class="p">-</span><span class="n">min</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">instanceNumber</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="kt">float</span> <span class="n">x</span> <span class="p">=</span> <span class="n">UnityEngine</span><span class="p">.</span><span class="n">Random</span><span class="p">.</span><span class="nf">Range</span><span class="p">(</span><span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
        <span class="kt">float</span> <span class="n">z</span> <span class="p">=</span> <span class="n">UnityEngine</span><span class="p">.</span><span class="n">Random</span><span class="p">.</span><span class="nf">Range</span><span class="p">(</span><span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
        <span class="n">DustArray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vector3</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="m">0f</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
        <span class="n">DustArray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="p">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="dustshadershader"><strong>DustShader.shader</strong></h2>

  <ul>
    <li>
      <p>먼지 렌더링을 담당한다.</p>
    </li>
    <li>
      <p>먼지의 위치를 컴퓨트 버퍼에 저장하면, CPU가 아니라 쉐이더를 통해 GPU로 위치 변경사항을 적용한다.</p>
    </li>
  </ul>

  <details>
    <summary> 
…
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
</pre></td><td class="rouge-code"><pre><span class="n">Shader</span> <span class="s">"Rito/Dust"</span>
<span class="p">{</span>
    <span class="n">Properties</span>
    <span class="p">{</span>
        <span class="c1">//_MainTex ("Texture", 2D) = "white" {}</span>
        <span class="n">_Color</span><span class="p">(</span><span class="s">"Color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">SubShader</span>
    <span class="p">{</span>
        <span class="n">Tags</span> <span class="p">{</span> <span class="s">"RenderType"</span><span class="o">=</span><span class="s">"Opaque"</span> <span class="p">}</span>

        <span class="n">Pass</span>
        <span class="p">{</span>
            <span class="n">CGPROGRAM</span>
            <span class="cp">#pragma vertex vert
</span>            <span class="cp">#pragma fragment frag
</span>
            <span class="cp">#include "UnityCG.cginc"
</span>            <span class="cp">#define TRUE 1
</span>            <span class="cp">#define FALSE 0
</span>
            <span class="k">struct</span> <span class="n">v2f</span>
            <span class="p">{</span>
                <span class="kt">float4</span> <span class="n">pos</span> <span class="o">:</span> <span class="nb">SV_POSITION</span><span class="p">;</span>
                <span class="kt">float3</span> <span class="n">normal</span> <span class="o">:</span> <span class="nb">TEXCOORD0</span><span class="p">;</span>
                <span class="n">int</span> <span class="n">isAlive</span> <span class="o">:</span> <span class="nb">TEXCOORD1</span><span class="p">;</span>
            <span class="p">};</span>

            <span class="k">struct</span> <span class="n">Dust</span>
            <span class="p">{</span>
                <span class="kt">float3</span> <span class="n">position</span><span class="p">;</span>
                <span class="n">int</span> <span class="n">isAlive</span><span class="p">;</span>
            <span class="p">};</span>

            <span class="k">uniform</span> <span class="n">float</span> <span class="n">_Scale</span><span class="p">;</span>
            <span class="kt">StructuredBuffer</span><span class="o">&lt;</span><span class="n">Dust</span><span class="o">&gt;</span> <span class="n">_DustBuffer</span><span class="p">;</span>

            <span class="n">v2f</span> <span class="n">vert</span> <span class="p">(</span><span class="n">appdata_full</span> <span class="n">v</span><span class="p">,</span> <span class="n">uint</span> <span class="n">instanceID</span> <span class="o">:</span> <span class="n">SV_InstanceID</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>
                <span class="c1">// 먼지 생존 여부 받아와서 프래그먼트 쉐이더에 전달</span>
                <span class="n">o</span><span class="p">.</span><span class="n">isAlive</span> <span class="o">=</span> <span class="n">_DustBuffer</span><span class="p">[</span><span class="n">instanceID</span><span class="p">].</span><span class="n">isAlive</span><span class="p">;</span>

                <span class="c1">// 먼지 크기 결정</span>
                <span class="n">v</span><span class="p">.</span><span class="n">vertex</span> <span class="o">*=</span> <span class="n">_Scale</span><span class="p">;</span> 

                <span class="c1">// 먼지 위치 결정</span>
                <span class="kt">float3</span> <span class="n">instancePos</span> <span class="o">=</span> <span class="n">_DustBuffer</span><span class="p">[</span><span class="n">instanceID</span><span class="p">].</span><span class="n">position</span><span class="p">;</span>
                <span class="kt">float3</span> <span class="n">worldPos</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">vertex</span> <span class="o">+</span> <span class="n">instancePos</span><span class="p">;</span>

                <span class="n">o</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="nb">mul</span><span class="p">(</span><span class="n">UNITY_MATRIX_VP</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
                <span class="n">o</span><span class="p">.</span><span class="n">normal</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">;</span>
                <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">fixed4</span> <span class="n">_Color</span><span class="p">;</span>

            <span class="n">fixed4</span> <span class="n">frag</span> <span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_Target</span>
            <span class="p">{</span>
                <span class="c1">// 죽은 먼지는 렌더링 X</span>
                <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">isAlive</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">discard</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="n">_Color</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">ENDCG</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section"><strong>실행 결과</strong></h2>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/134875331-f70f4555-7b70-49a6-8049-ae35740165a0.gif" alt="2021_0927_Dust1" /></p>

  <p><br /></p>

</details>
<!-- --------------------------------------------------------------------------- -->

<h1 id="2-먼지-빨아들이기">2. 먼지 빨아들이기</h1>
<hr />

<details>
  <summary> 
…
</summary>

  <p><br /></p>

  <h2 id="section-1"><strong>진공 청소기 입구</strong></h2>

  <ul>
    <li>먼지를 빨아들이는 부분</li>
  </ul>

  <details>
    <summary> 
VacuumCleanerHead.cs
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">bool</span> <span class="n">run</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
<span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">50f</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">suctionForce</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>
<span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">1f</span><span class="p">,</span> <span class="m">20f</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">suctionRange</span> <span class="p">=</span> <span class="m">5f</span><span class="p">;</span>
<span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0.01f</span><span class="p">,</span> <span class="m">5f</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">deathRange</span> <span class="p">=</span> <span class="m">0.2f</span><span class="p">;</span>

<span class="k">public</span> <span class="kt">bool</span> <span class="n">Running</span> <span class="p">=&gt;</span> <span class="n">run</span><span class="p">;</span>
<span class="k">public</span> <span class="kt">float</span> <span class="n">SqrSuctionRange</span> <span class="p">=&gt;</span> <span class="n">suctionRange</span> <span class="p">*</span> <span class="n">suctionRange</span><span class="p">;</span>
<span class="k">public</span> <span class="kt">float</span> <span class="n">SuctionForce</span> <span class="p">=&gt;</span> <span class="n">suctionForce</span><span class="p">;</span>
<span class="k">public</span> <span class="kt">float</span> <span class="n">DeathRange</span> <span class="p">=&gt;</span> <span class="n">deathRange</span><span class="p">;</span>
<span class="k">public</span> <span class="n">Vector3</span> <span class="n">Position</span> <span class="p">=&gt;</span> <span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">;</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">OnDrawGizmosSelected</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Gizmos</span><span class="p">.</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">cyan</span><span class="p">;</span>
    <span class="n">Gizmos</span><span class="p">.</span><span class="nf">DrawWireSphere</span><span class="p">(</span><span class="n">Position</span><span class="p">,</span> <span class="n">suctionRange</span><span class="p">);</span>

    <span class="n">Gizmos</span><span class="p">.</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">red</span><span class="p">;</span>
    <span class="n">Gizmos</span><span class="p">.</span><span class="nf">DrawWireSphere</span><span class="p">(</span><span class="n">Position</span><span class="p">,</span> <span class="n">deathRange</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="cpu---"><strong>[1] CPU 단일 스레드 계산</strong></h2>

  <ul>
    <li>반복문을 통한 단순 계산을 통해 먼지들의 위치를 업데이트한다.</li>
    <li>성능이 매우 매우 좋지 않다.</li>
  </ul>

  <details>
    <summary> 
Dustmanager.cs
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre><span class="k">private</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nf">UpdateDustPositions</span><span class="p">();</span>
    <span class="n">DustMaterial</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"_Scale"</span><span class="p">,</span> <span class="n">DustScale</span><span class="p">);</span>
    <span class="n">Graphics</span><span class="p">.</span><span class="nf">DrawMeshInstancedIndirect</span><span class="p">(</span><span class="n">DustMesh</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">DustMaterial</span><span class="p">,</span> <span class="n">frustumOverlapBounds</span><span class="p">,</span> <span class="n">argsBuffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateDustPositions</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cleanerHead</span><span class="p">.</span><span class="n">Running</span> <span class="p">==</span> <span class="k">false</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="n">Vector3</span> <span class="n">headPos</span> <span class="p">=</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">Position</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">sqrRange</span> <span class="p">=</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">SqrSuctionRange</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">sqrDeathRange</span> <span class="p">=</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">DeathRange</span> <span class="p">*</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">DeathRange</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">force</span> <span class="p">=</span> <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span> <span class="p">*</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">SuctionForce</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">instanceNumber</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">DustArray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="p">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

        <span class="c1">// root 연산은 비싸기 때문에 제곱 상태로 거리 비교</span>
        <span class="kt">float</span> <span class="n">sqrDist</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="nf">SqrMagnitude</span><span class="p">(</span><span class="n">DustArray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="p">-</span> <span class="n">headPos</span><span class="p">);</span>
        
        <span class="c1">// 사망 범위</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sqrDist</span> <span class="p">&lt;</span> <span class="n">sqrDeathRange</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">DustArray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="p">=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">aliveNumber</span><span class="p">--;</span>
        <span class="p">}</span>
        <span class="c1">// 흡입 범위</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sqrDist</span> <span class="p">&lt;</span> <span class="n">sqrRange</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">DustArray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="nf">Lerp</span><span class="p">(</span><span class="n">DustArray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">,</span> <span class="n">headPos</span><span class="p">,</span> <span class="n">force</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">dustBuffer</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="n">DustArray</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/134880151-4068c99e-a84d-4cdb-8f49-5e88eb31ea89.gif" alt="2021_0927_DustUpdate1" /></p>

  <p><br /></p>

  <h2 id="cpu--"><strong>[2] CPU 병렬 계산</strong></h2>

  <ul>
    <li>
      <p><code class="language-plaintext highlighter-rouge">Parallel</code>을 통한 멀티스레딩으로 CPU 연산을 적용한다.</p>
    </li>
    <li>
      <p>그리고 먼지가 단순히 <code class="language-plaintext highlighter-rouge">Vector3.Lerp()</code>를 통해 이동하는 대신, 거리가 가까울수록 빠르게 이동하도록 계산 방식을 변경한다.</p>
    </li>
  </ul>

  <details>
    <summary> 
Dustmanager.cs
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateDustPositions</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cleanerHead</span><span class="p">.</span><span class="n">Running</span> <span class="p">==</span> <span class="k">false</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="n">Vector3</span> <span class="n">headPos</span> <span class="p">=</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">Position</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">sqrRange</span> <span class="p">=</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">SqrSuctionRange</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">sqrDeathRange</span> <span class="p">=</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">DeathRange</span> <span class="p">*</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">DeathRange</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">sqrForce</span> <span class="p">=</span> <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span> <span class="p">*</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">SuctionForce</span> <span class="p">*</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">SuctionForce</span><span class="p">;</span>

    <span class="c1">// 병렬 처리(동기)</span>
    <span class="n">Parallel</span><span class="p">.</span><span class="nf">For</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">instanceNumber</span><span class="p">,</span> <span class="n">i</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">DustArray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="p">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

        <span class="kt">float</span> <span class="n">sqrDist</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="nf">SqrMagnitude</span><span class="p">(</span><span class="n">headPos</span> <span class="p">-</span> <span class="n">DustArray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">);</span>

        <span class="c1">// 사망 범위</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sqrDist</span> <span class="p">&lt;</span> <span class="n">sqrDeathRange</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">DustArray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="p">=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Interlocked</span><span class="p">.</span><span class="nf">Decrement</span><span class="p">(</span><span class="k">ref</span> <span class="n">aliveNumber</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// 흡입 범위</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sqrDist</span> <span class="p">&lt;</span> <span class="n">sqrRange</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Vector3</span> <span class="n">dir</span> <span class="p">=</span> <span class="p">(</span><span class="n">headPos</span> <span class="p">-</span> <span class="n">DustArray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">).</span><span class="n">normalized</span><span class="p">;</span>
            <span class="kt">float</span> <span class="n">weightedForce</span> <span class="p">=</span> <span class="n">sqrForce</span> <span class="p">/</span> <span class="n">sqrDist</span><span class="p">;</span>
            <span class="n">DustArray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="p">+=</span> <span class="n">dir</span> <span class="p">*</span> <span class="n">weightedForce</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="n">dustBuffer</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="n">DustArray</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/134881462-c07f57ba-097c-41fd-87f6-f2639c53f463.gif" alt="2021_0927_DustUpdate2" /></p>

  <p><br /></p>

  <h2 id="section-2"><strong>[3] 컴퓨트 쉐이더 병렬 연산</strong></h2>

  <ul>
    <li>먼지 이동 연산을 컴퓨트 쉐이더로 넘겨서 처리한다.</li>
    <li>컴퓨트 쉐이더의 연산 결과를 다시 CPU로 가져오는 작업이 없고, 대신 컴퓨트 버퍼를 Vert/Frag 쉐이더에서 바로 참조하여 적용하므로 매우 빠르다.</li>
  </ul>

  <details>
    <summary> 
DustCompute.compute
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre><span class="cp">#pragma kernel CSMain
</span>
<span class="cp">#define TRUE 1
#define FALSE 0
</span>
<span class="k">struct</span> <span class="n">Dust</span>
<span class="p">{</span>
    <span class="kt">float3</span> <span class="n">position</span><span class="p">;</span>
    <span class="n">int</span> <span class="n">isAlive</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">Dust</span><span class="o">&gt;</span> <span class="n">dustBuffer</span><span class="p">;</span>
<span class="kt">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">uint</span><span class="o">&gt;</span> <span class="n">aliveNumberBuffer</span><span class="p">;</span> <span class="c1">// 생존한 먼지 개수</span>

<span class="kt">float3</span> <span class="n">headPos</span><span class="p">;</span>
<span class="n">float</span> <span class="n">sqrRange</span><span class="p">;</span>
<span class="n">float</span> <span class="n">sqrDeathRange</span><span class="p">;</span>
<span class="n">float</span> <span class="n">sqrForce</span><span class="p">;</span>

<span class="p">[</span><span class="nb">numthreads</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
<span class="kt">void</span> <span class="nf">CSMain</span> <span class="p">(</span><span class="n">uint3</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">DustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    
    <span class="c1">// 제곱 상태로 연산</span>
    <span class="kt">float3</span> <span class="n">offs</span> <span class="o">=</span> <span class="p">(</span><span class="n">headPos</span> <span class="o">-</span> <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">);</span>
    <span class="n">float</span> <span class="n">sqrDist</span> <span class="o">=</span> <span class="p">(</span><span class="n">offs</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">offs</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">offs</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">offs</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">offs</span><span class="p">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">offs</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>

    <span class="c1">// 사망 범위</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sqrDist</span> <span class="o">&lt;</span> <span class="n">sqrDeathRange</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="nb">InterlockedAdd</span><span class="p">(</span><span class="n">aliveNumberBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// 흡입 범위</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sqrDist</span> <span class="o">&lt;</span> <span class="n">sqrRange</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">float3</span> <span class="n">dir</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">headPos</span> <span class="o">-</span> <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">);</span>
        <span class="n">float</span> <span class="n">weightedForce</span> <span class="o">=</span> <span class="n">sqrForce</span> <span class="o">/</span> <span class="n">sqrDist</span><span class="p">;</span>
        <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="o">+=</span> <span class="n">dir</span> <span class="o">*</span> <span class="n">weightedForce</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <details>
    <summary> 
Dustmanager.cs
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
</pre></td><td class="rouge-code"><pre><span class="cm">/* 기타 필드 생략 */</span>

<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">ComputeShader</span> <span class="n">DustCompute</span><span class="p">;</span>
<span class="k">private</span> <span class="n">ComputeBuffer</span> <span class="n">dustBuffer</span><span class="p">;</span> <span class="c1">// 먼지 데이터 버퍼(위치, ...)</span>
<span class="k">private</span> <span class="n">ComputeBuffer</span> <span class="n">argsBuffer</span><span class="p">;</span> <span class="c1">// 먼지 렌더링 데이터 버퍼</span>
<span class="k">private</span> <span class="n">ComputeBuffer</span> <span class="n">aliveNumberBuffer</span><span class="p">;</span> <span class="c1">// 생존 먼지 개수 RW</span>

<span class="k">private</span> <span class="n">Bounds</span> <span class="n">frustumOverlapBounds</span><span class="p">;</span>
<span class="k">private</span> <span class="n">Dust</span><span class="p">[]</span> <span class="n">DustArray</span><span class="p">;</span>

<span class="k">private</span> <span class="kt">uint</span><span class="p">[]</span> <span class="n">aliveNumberArray</span><span class="p">;</span>
<span class="k">private</span> <span class="kt">int</span> <span class="n">aliveNumber</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">kernelGroupSizeX</span><span class="p">;</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nf">InitBuffers</span><span class="p">();</span>
    <span class="nf">InitComputeShader</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nf">UpdateDustPositionsGPU</span><span class="p">();</span>
    <span class="n">DustMaterial</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"_Scale"</span><span class="p">,</span> <span class="n">DustScale</span><span class="p">);</span>
    <span class="n">Graphics</span><span class="p">.</span><span class="nf">DrawMeshInstancedIndirect</span><span class="p">(</span><span class="n">DustMesh</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">DustMaterial</span><span class="p">,</span> <span class="n">frustumOverlapBounds</span><span class="p">,</span> <span class="n">argsBuffer</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">OnDestroy</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">dustBuffer</span><span class="p">.</span><span class="nf">Release</span><span class="p">();</span>
    <span class="n">argsBuffer</span><span class="p">.</span><span class="nf">Release</span><span class="p">();</span>
    <span class="n">aliveNumberBuffer</span><span class="p">.</span><span class="nf">Release</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">/// &lt;summary&gt; 컴퓨트 버퍼들 생성 &lt;/summary&gt;</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">InitBuffers</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Args Buffer</span>
    <span class="c1">// IndirectArguments로 사용되는 컴퓨트 버퍼의 stride는 20byte 이상이어야 한다.</span>
    <span class="c1">// 따라서 파라미터가 앞의 2개만 필요하지만, 뒤에 의미 없는 파라미터 3개를 더 넣어준다.</span>
    <span class="kt">uint</span><span class="p">[]</span> <span class="n">argsData</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">uint</span><span class="p">[]</span> <span class="p">{</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">DustMesh</span><span class="p">.</span><span class="nf">GetIndexCount</span><span class="p">(</span><span class="m">0</span><span class="p">),</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">instanceNumber</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span> <span class="p">};</span>
    <span class="n">aliveNumber</span> <span class="p">=</span> <span class="n">instanceNumber</span><span class="p">;</span>

    <span class="n">argsBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">5</span> <span class="p">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint</span><span class="p">),</span> <span class="n">ComputeBufferType</span><span class="p">.</span><span class="n">IndirectArguments</span><span class="p">);</span>
    <span class="n">argsBuffer</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="n">argsData</span><span class="p">);</span>

    <span class="nf">PopulateDusts</span><span class="p">();</span>

    <span class="c1">// Dust Buffer</span>
    <span class="n">dustBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="n">instanceNumber</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="p">*</span> <span class="m">3</span> <span class="p">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
    <span class="n">dustBuffer</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="n">DustArray</span><span class="p">);</span>
    <span class="n">DustMaterial</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="s">"_DustBuffer"</span><span class="p">,</span> <span class="n">dustBuffer</span><span class="p">);</span>

    <span class="c1">// Alive Number Buffer</span>
    <span class="c1">// 단순 입력용이 아니라 RW이므로 컴퓨트 버퍼를 사용한다.</span>
    <span class="n">aliveNumberBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint</span><span class="p">));</span>
    <span class="n">aliveNumberArray</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">uint</span><span class="p">[]</span> <span class="p">{</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">instanceNumber</span> <span class="p">};</span>
    <span class="n">aliveNumberBuffer</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="n">aliveNumberArray</span><span class="p">);</span>

    <span class="c1">// 카메라 프러스텀이 이 영역과 겹치지 않으면 렌더링되지 않는다.</span>
    <span class="n">frustumOverlapBounds</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Bounds</span><span class="p">(</span><span class="n">Vector3</span><span class="p">.</span><span class="n">zero</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Vector3</span><span class="p">(</span><span class="n">distributionRange</span><span class="p">,</span> <span class="m">1f</span><span class="p">,</span> <span class="n">distributionRange</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">/// &lt;summary&gt; 컴퓨트 쉐이더 초기화 &lt;/summary&gt;</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">InitComputeShader</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="s">"DustBuffer"</span><span class="p">,</span> <span class="n">dustBuffer</span><span class="p">);</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="s">"aliveNumberBuffer"</span><span class="p">,</span> <span class="n">aliveNumberBuffer</span><span class="p">);</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">GetKernelThreadGroupSizes</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="k">out</span> <span class="kt">uint</span> <span class="n">tx</span><span class="p">,</span> <span class="k">out</span> <span class="n">_</span><span class="p">,</span> <span class="k">out</span> <span class="n">_</span><span class="p">);</span>
    <span class="n">kernelGroupSizeX</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">CeilToInt</span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="n">instanceNumber</span> <span class="p">/</span> <span class="n">tx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateDustPositionsGPU</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cleanerHead</span><span class="p">.</span><span class="n">Running</span> <span class="p">==</span> <span class="k">false</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="n">Vector3</span> <span class="n">headPos</span> <span class="p">=</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">Position</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">sqrRange</span> <span class="p">=</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">SqrSuctionRange</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">sqrDeathRange</span> <span class="p">=</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">DeathRange</span> <span class="p">*</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">DeathRange</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">sqrForce</span> <span class="p">=</span> <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span> <span class="p">*</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">SuctionForce</span> <span class="p">*</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">SuctionForce</span><span class="p">;</span>

    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetVector</span><span class="p">(</span><span class="s">"headPos"</span><span class="p">,</span> <span class="n">headPos</span><span class="p">);</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"sqrRange"</span><span class="p">,</span> <span class="n">sqrRange</span><span class="p">);</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"sqrDeathRange"</span><span class="p">,</span> <span class="n">sqrDeathRange</span><span class="p">);</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"sqrForce"</span><span class="p">,</span> <span class="n">sqrForce</span><span class="p">);</span>

    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">Dispatch</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">kernelGroupSizeX</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>

    <span class="n">aliveNumberBuffer</span><span class="p">.</span><span class="nf">GetData</span><span class="p">(</span><span class="n">aliveNumberArray</span><span class="p">);</span>
    <span class="n">aliveNumber</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">aliveNumberArray</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/134906449-5b7787aa-a7f6-44cd-a151-c1b460fc6c7c.gif" alt="2021_0927_DustUpdate3" /></p>

  <p><br /></p>

</details>
<!-- --------------------------------------------------------------------------- -->

<h1 id="3-먼지-생성-최적화">3. 먼지 생성 최적화</h1>
<hr />

<details>
  <summary> 
…
</summary>

  <p><br /></p>

  <p>난수를 발생시켜 먼지를 무작위 위치에 생성하던 부분을 CPU가 아니라 컴퓨트 쉐이더 내에서 연산하도록 한다.</p>

  <p>그리고 평면이 아닌, 공간에서 큐브 형태로 분포할 수 있도록 변경한다.</p>

  <p><br /></p>

  <h2 id="section-3"><strong>[1] 컴퓨트 쉐이더</strong></h2>

  <ul>
    <li>기존 커널의 이름을 <code class="language-plaintext highlighter-rouge">Update</code>로 변경하고, 새로운 커널 함수 <code class="language-plaintext highlighter-rouge">Populate</code>를 작성한다.</li>
  </ul>

  <details>
    <summary> 
DustCompute.compute
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
</pre></td><td class="rouge-code"><pre><span class="cp">#pragma kernel Populate
#pragma kernel Update
</span>
<span class="cp">#define TRUE 1
#define FALSE 0
</span>
<span class="k">struct</span> <span class="n">Dust</span>
<span class="p">{</span>
    <span class="kt">float3</span> <span class="n">position</span><span class="p">;</span>
    <span class="n">int</span> <span class="n">isAlive</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*************************************************
/*                     Methods
/*************************************************/</span>
<span class="n">float</span> <span class="nf">Random</span><span class="p">(</span><span class="kt">float2</span> <span class="n">seed</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nb">frac</span><span class="p">(</span><span class="nb">sin</span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="kt">float2</span><span class="p">(</span><span class="mi">73</span><span class="p">.</span><span class="mi">867</span><span class="p">,</span> <span class="mi">25</span><span class="p">.</span><span class="mi">241</span><span class="p">)))</span> <span class="o">*</span> <span class="mi">39482</span><span class="p">.</span><span class="mi">17593</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">float</span> <span class="nf">RandomRange</span><span class="p">(</span><span class="kt">float2</span> <span class="n">seed</span><span class="p">,</span> <span class="n">float</span> <span class="nb">min</span><span class="p">,</span> <span class="n">float</span> <span class="nb">max</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nb">lerp</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="n">Random</span><span class="p">(</span><span class="n">seed</span><span class="p">));</span> 
<span class="p">}</span>
<span class="kt">float3</span> <span class="nf">RandomRange3</span><span class="p">(</span><span class="kt">float2</span> <span class="n">seed</span><span class="p">,</span> <span class="kt">float3</span> <span class="nb">min</span><span class="p">,</span> <span class="kt">float3</span> <span class="nb">max</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">float3</span> <span class="n">vec</span><span class="p">;</span>
    <span class="n">vec</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">RandomRange</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="nb">min</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="nb">max</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
    <span class="n">vec</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">RandomRange</span><span class="p">(</span><span class="n">seed</span> <span class="o">+</span> <span class="mi">7</span><span class="p">.</span><span class="mi">219</span><span class="p">,</span> <span class="nb">min</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="nb">max</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
    <span class="n">vec</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">RandomRange</span><span class="p">(</span><span class="n">seed</span> <span class="o">+</span> <span class="mi">79</span><span class="p">.</span><span class="mi">714</span><span class="p">,</span> <span class="nb">min</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="nb">max</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">vec</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*************************************************
/*                     Variables
/*************************************************/</span>
<span class="kt">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">Dust</span><span class="o">&gt;</span> <span class="n">dustBuffer</span><span class="p">;</span>
<span class="kt">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">uint</span><span class="o">&gt;</span> <span class="n">aliveNumberBuffer</span><span class="p">;</span> <span class="c1">// 생존한 먼지 개수</span>

<span class="kt">float3</span> <span class="n">boundsMin</span><span class="p">;</span> <span class="c1">// 먼지 생성 영역 - 최소 지점</span>
<span class="kt">float3</span> <span class="n">boundsMax</span><span class="p">;</span> <span class="c1">// 먼지 생성 영역 - 최대 지점</span>

<span class="kt">float3</span> <span class="n">headPos</span><span class="p">;</span>
<span class="n">float</span> <span class="n">sqrRange</span><span class="p">;</span>
<span class="n">float</span> <span class="n">sqrDeathRange</span><span class="p">;</span>
<span class="n">float</span> <span class="n">sqrForce</span><span class="p">;</span>

<span class="cm">/*************************************************
/*                     Kernels
/*************************************************/</span>

<span class="c1">// 0 - 초기 생성</span>
<span class="p">[</span><span class="nb">numthreads</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
<span class="kt">void</span> <span class="nf">Populate</span> <span class="p">(</span><span class="n">uint3</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

    <span class="n">float</span> <span class="n">width</span> <span class="o">=</span> <span class="n">boundsMax</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">boundsMin</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">f</span> <span class="o">=</span> <span class="n">float</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="kt">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="kt">float2</span><span class="p">(</span><span class="n">f</span> <span class="o">%</span> <span class="n">width</span><span class="p">,</span> <span class="n">f</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span> <span class="o">/</span> <span class="n">width</span><span class="p">;</span>
    
    <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="o">=</span> <span class="n">RandomRange3</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">boundsMin</span><span class="p">,</span> <span class="n">boundsMax</span><span class="p">);</span>
    <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 1 - 실시간 업데이트</span>
<span class="p">[</span><span class="nb">numthreads</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
<span class="kt">void</span> <span class="nf">Update</span> <span class="p">(</span><span class="n">uint3</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">DustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    
    <span class="kt">float3</span> <span class="n">offs</span> <span class="o">=</span> <span class="p">(</span><span class="n">headPos</span> <span class="o">-</span> <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">);</span>
    <span class="n">float</span> <span class="n">sqrDist</span> <span class="o">=</span> <span class="p">(</span><span class="n">offs</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">offs</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">offs</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">offs</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">offs</span><span class="p">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">offs</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">sqrDist</span> <span class="o">&lt;</span> <span class="n">sqrDeathRange</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="nb">InterlockedAdd</span><span class="p">(</span><span class="n">aliveNumberBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sqrDist</span> <span class="o">&lt;</span> <span class="n">sqrRange</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">float3</span> <span class="n">dir</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">headPos</span> <span class="o">-</span> <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">);</span>
        <span class="n">float</span> <span class="n">weightedForce</span> <span class="o">=</span> <span class="n">sqrForce</span> <span class="o">/</span> <span class="n">sqrDist</span><span class="p">;</span>
        <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="o">+=</span> <span class="n">dir</span> <span class="o">*</span> <span class="n">weightedForce</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-4"><strong>[2] 먼지 관리 컴포넌트</strong></h2>

  <ul>
    <li>커널 함수들의 인덱스를 필드로 저장한다.</li>
    <li>먼지들에 대한 CPU 작업은 더이상 필요하지 않으므로, <code class="language-plaintext highlighter-rouge">DustArray</code> 필드는 제거하고 모두 <code class="language-plaintext highlighter-rouge">DustBuffer</code>를 통해 GPU에서 작업한다.</li>
  </ul>

  <details>
    <summary> 
DustManager.cs
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">distributionHeight</span> <span class="p">=</span> <span class="m">5f</span><span class="p">;</span>  <span class="c1">// 먼지 분포 높이</span>

<span class="k">private</span> <span class="kt">int</span> <span class="n">kernelPopulateID</span><span class="p">;</span>
<span class="k">private</span> <span class="kt">int</span> <span class="n">kernelUpdateID</span><span class="p">;</span>
<span class="k">private</span> <span class="kt">int</span> <span class="n">kernelGroupSizeX</span><span class="p">;</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nf">InitBuffers</span><span class="p">();</span>
    <span class="nf">InitComputeShader</span><span class="p">();</span>
    <span class="nf">PopulateDusts</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nf">UpdateDustPositionsGPU</span><span class="p">();</span>

    <span class="n">DustMaterial</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"_Scale"</span><span class="p">,</span> <span class="n">DustScale</span><span class="p">);</span>
    <span class="n">Graphics</span><span class="p">.</span><span class="nf">DrawMeshInstancedIndirect</span><span class="p">(</span><span class="n">DustMesh</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">DustMaterial</span><span class="p">,</span> <span class="n">frustumOverlapBounds</span><span class="p">,</span> <span class="n">argsBuffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">/// &lt;summary&gt; 컴퓨트 버퍼들 생성 &lt;/summary&gt;</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">InitBuffers</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">uint</span><span class="p">[]</span> <span class="n">argsData</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">uint</span><span class="p">[]</span> <span class="p">{</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">DustMesh</span><span class="p">.</span><span class="nf">GetIndexCount</span><span class="p">(</span><span class="m">0</span><span class="p">),</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">instanceNumber</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span> <span class="p">};</span>
    <span class="n">aliveNumber</span> <span class="p">=</span> <span class="n">instanceNumber</span><span class="p">;</span>

    <span class="n">argsBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">5</span> <span class="p">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint</span><span class="p">),</span> <span class="n">ComputeBufferType</span><span class="p">.</span><span class="n">IndirectArguments</span><span class="p">);</span>
    <span class="n">argsBuffer</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="n">argsData</span><span class="p">);</span>

    <span class="c1">// Dust Buffer =&gt; DustArray는 완전히 제거</span>
    <span class="n">dustBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="n">instanceNumber</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="p">*</span> <span class="m">3</span> <span class="p">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
    <span class="n">DustMaterial</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="s">"_DustBuffer"</span><span class="p">,</span> <span class="n">dustBuffer</span><span class="p">);</span>

    <span class="n">aliveNumberBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint</span><span class="p">));</span>
    <span class="n">aliveNumberArray</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">uint</span><span class="p">[]</span> <span class="p">{</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">instanceNumber</span> <span class="p">};</span>
    <span class="n">aliveNumberBuffer</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="n">aliveNumberArray</span><span class="p">);</span>

    <span class="n">frustumOverlapBounds</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Bounds</span><span class="p">(</span><span class="n">Vector3</span><span class="p">.</span><span class="n">zero</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Vector3</span><span class="p">(</span><span class="n">distributionRange</span><span class="p">,</span> <span class="m">1f</span><span class="p">,</span> <span class="n">distributionRange</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">/// &lt;summary&gt; 컴퓨트 쉐이더 초기화 &lt;/summary&gt;</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">InitComputeShader</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// 커널 인덱스 찾아 가져오기</span>
    <span class="n">kernelPopulateID</span> <span class="p">=</span> <span class="n">DustCompute</span><span class="p">.</span><span class="nf">FindKernel</span><span class="p">(</span><span class="s">"Populate"</span><span class="p">);</span>
    <span class="n">kernelUpdateID</span>   <span class="p">=</span> <span class="n">DustCompute</span><span class="p">.</span><span class="nf">FindKernel</span><span class="p">(</span><span class="s">"Update"</span><span class="p">);</span>

    <span class="c1">// 버퍼는 커널마다 각각 할당해주어야 한다.</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernelPopulateID</span><span class="p">,</span> <span class="s">"DustBuffer"</span><span class="p">,</span> <span class="n">dustBuffer</span><span class="p">);</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernelUpdateID</span><span class="p">,</span> <span class="s">"DustBuffer"</span><span class="p">,</span> <span class="n">dustBuffer</span><span class="p">);</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernelUpdateID</span><span class="p">,</span> <span class="s">"aliveNumberBuffer"</span><span class="p">,</span> <span class="n">aliveNumberBuffer</span><span class="p">);</span>

    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">GetKernelThreadGroupSizes</span><span class="p">(</span><span class="n">kernelUpdateID</span><span class="p">,</span> <span class="k">out</span> <span class="kt">uint</span> <span class="n">tx</span><span class="p">,</span> <span class="k">out</span> <span class="n">_</span><span class="p">,</span> <span class="k">out</span> <span class="n">_</span><span class="p">);</span>
    <span class="n">kernelGroupSizeX</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">CeilToInt</span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="n">instanceNumber</span> <span class="p">/</span> <span class="n">tx</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">/// &lt;summary&gt; 먼지들을 영역 내의 무작위 위치에 생성한다. &lt;/summary&gt;</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">PopulateDusts</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Vector3</span> <span class="n">boundsMin</span><span class="p">,</span> <span class="n">boundsMax</span><span class="p">;</span>
    <span class="n">boundsMin</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="n">boundsMin</span><span class="p">.</span><span class="n">z</span> <span class="p">=</span> <span class="p">-</span><span class="m">0.5f</span> <span class="p">*</span> <span class="n">distributionRange</span><span class="p">;</span>
    <span class="n">boundsMax</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="n">boundsMax</span><span class="p">.</span><span class="n">z</span> <span class="p">=</span> <span class="p">-</span><span class="n">boundsMin</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="n">boundsMin</span><span class="p">.</span><span class="n">y</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
    <span class="n">boundsMax</span><span class="p">.</span><span class="n">y</span> <span class="p">=</span> <span class="n">distributionHeight</span><span class="p">;</span>

    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetVector</span><span class="p">(</span><span class="s">"boundsMin"</span><span class="p">,</span> <span class="n">boundsMin</span><span class="p">);</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetVector</span><span class="p">(</span><span class="s">"boundsMax"</span><span class="p">,</span> <span class="n">boundsMax</span><span class="p">);</span>

    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">GetKernelThreadGroupSizes</span><span class="p">(</span><span class="n">kernelPopulateID</span><span class="p">,</span> <span class="k">out</span> <span class="kt">uint</span> <span class="n">tx</span><span class="p">,</span> <span class="k">out</span> <span class="n">_</span><span class="p">,</span> <span class="k">out</span> <span class="n">_</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">groupSizeX</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">CeilToInt</span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="n">instanceNumber</span> <span class="p">/</span> <span class="n">tx</span><span class="p">);</span>

    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">Dispatch</span><span class="p">(</span><span class="n">kernelPopulateID</span><span class="p">,</span> <span class="n">groupSizeX</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateDustPositionsGPU</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// 생략</span>
    
    <span class="c1">// Dispatch(0, ...) =&gt; Dispatch(kernelUpdateID, ...) 변경</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">Dispatch</span><span class="p">(</span><span class="n">kernelUpdateID</span><span class="p">,</span> <span class="n">kernelGroupSizeX</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-5"><strong>[3] 진공 청소기 컴포넌트</strong></h2>

  <ul>
    <li>임시 이동을 구현한다.</li>
  </ul>

  <details>
    <summary> 
VacuumCleanerHead.cs
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0.01f</span><span class="p">,</span> <span class="m">100f</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">moveSpeed</span> <span class="p">=</span> <span class="m">50f</span><span class="p">;</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// On/Off</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="nf">GetKeyDown</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">Space</span><span class="p">))</span>
        <span class="n">run</span> <span class="p">^=</span> <span class="k">true</span><span class="p">;</span>

    <span class="c1">// Move</span>
    <span class="kt">float</span> <span class="n">x</span> <span class="p">=</span> <span class="n">Input</span><span class="p">.</span><span class="nf">GetAxisRaw</span><span class="p">(</span><span class="s">"Horizontal"</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">z</span> <span class="p">=</span> <span class="n">Input</span><span class="p">.</span><span class="nf">GetAxisRaw</span><span class="p">(</span><span class="s">"Vertical"</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">y</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="nf">GetKey</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">E</span><span class="p">))</span> <span class="n">y</span> <span class="p">+=</span> <span class="m">1f</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="nf">GetKey</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">Q</span><span class="p">))</span> <span class="n">y</span> <span class="p">-=</span> <span class="m">1f</span><span class="p">;</span>

    <span class="n">Vector3</span> <span class="n">moveVec</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vector3</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">).</span><span class="n">normalized</span> <span class="p">*</span> <span class="n">moveSpeed</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="nf">GetKey</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">LeftShift</span><span class="p">))</span>
        <span class="n">moveVec</span> <span class="p">*=</span> <span class="m">2f</span><span class="p">;</span>

    <span class="n">transform</span><span class="p">.</span><span class="nf">Translate</span><span class="p">(</span><span class="n">moveVec</span> <span class="p">*</span> <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span><span class="p">,</span> <span class="n">Space</span><span class="p">.</span><span class="n">World</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-6"><strong>[4] 실행 결과</strong></h2>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135104033-6303ab1b-15fe-412d-9c64-05dc61cb09d3.gif" alt="2021_0927_Dust_3D" /></p>

  <p><br /></p>

</details>
<!-- --------------------------------------------------------------------------- -->

<h1 id="4-원뿔-영역-흡수-구현">4. 원뿔 영역 흡수 구현</h1>
<hr />

<details>
  <summary> 
…
</summary>

  <p><br /></p>

  <p>구형 범위에서 흡수하는 것은 블랙홀이나 마찬가지이므로,</p>

  <p>방향을 지정하여 해당 방향에서 원뿔 범위로 흡수할 수 있게 변경한다.</p>

  <p><br /></p>

  <p>1차로 단순히 거리 계산을 통해 구형 범위로 검사하는 것은 동일하다.</p>

  <blockquote>
    <p>R : 구형 범위<br />
C : 청소기 입구 위치<br />
D : 각 먼지의 위치</p>
  </blockquote>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135222916-27124d3e-bc37-451b-b7bc-c78f844382e0.png" alt="image" /></p>

  <p><br /></p>

  <p>2차로 내적을 이용해 원뿔(밑면이 평면이 아닌 구의 일부) 범위로 검사할 수 있다.</p>

  <blockquote>
    <p>C : 청소기 입구 위치<br />
D : 각 먼지의 위치<br />
E : 원뿔 밑단 외곽의 한 점<br />
F : 원뿔 밑단 중심점</p>
  </blockquote>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135745973-26191c8b-5779-4d96-8abd-0446d8c3ddee.png" alt="image" /></p>

  <p><br /></p>

  <h2 id="section-7"><strong>[1] 컴퓨트 쉐이더</strong></h2>

  <ul>
    <li>내적을 이용하여 원뿔 범위 흡수를 구현한다.</li>
  </ul>

  <details>
    <summary> 
DustCompute.compute
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre></td><td class="rouge-code"><pre><span class="cm">/* 관련 없는 코드는 생략 */</span>

<span class="cm">/*************************************************
/*                     Variables
/*************************************************/</span>
<span class="kt">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">Dust</span><span class="o">&gt;</span> <span class="n">dustBuffer</span><span class="p">;</span>

<span class="kt">float3</span> <span class="n">headPos</span><span class="p">;</span>    <span class="c1">// 진공 청소기 입구 위치</span>
<span class="n">float</span> <span class="n">sqrRange</span><span class="p">;</span>      <span class="c1">// 먼지 흡입 범위(반지름)</span>
<span class="n">float</span> <span class="n">sqrDeathRange</span><span class="p">;</span> <span class="c1">// 먼지 소멸 범위(반지름)</span>
<span class="n">float</span> <span class="n">sqrForce</span><span class="p">;</span>

<span class="kt">float3</span> <span class="n">forward</span><span class="p">;</span>     <span class="c1">// 진공 청소기 전방 벡터</span>
<span class="n">float</span> <span class="n">dotThreshold</span><span class="p">;</span> <span class="c1">// 진공 청소기 원뿔 영역 내적 범위</span>

<span class="cm">/*************************************************
/*                     Methods
/*************************************************/</span>
<span class="n">float</span> <span class="nf">SqrMagnitude</span><span class="p">(</span><span class="kt">float3</span> <span class="n">vec</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">vec</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">vec</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">vec</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">vec</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">vec</span><span class="p">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">vec</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 먼지 파괴</span>
<span class="kt">void</span> <span class="nf">DestroyDust</span><span class="p">(</span><span class="n">uint</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="nb">InterlockedAdd</span><span class="p">(</span><span class="n">aliveNumberBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*************************************************
/*                     Kernels
/*************************************************/</span>
<span class="c1">// 1 - 실시간 업데이트</span>
<span class="p">[</span><span class="nb">numthreads</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
<span class="kt">void</span> <span class="nf">Update</span> <span class="p">(</span><span class="n">uint3</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">DustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    
    <span class="kt">float3</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">;</span>
    <span class="kt">float3</span> <span class="n">offs</span> <span class="o">=</span> <span class="p">(</span><span class="n">headPos</span> <span class="o">-</span> <span class="n">pos</span><span class="p">);</span>
    <span class="n">float</span> <span class="n">sqrDist</span> <span class="o">=</span> <span class="n">SqrMagnitude</span><span class="p">(</span><span class="n">offs</span><span class="p">);</span>

    <span class="c1">// 입구 주변 - 먼지 소멸</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sqrDist</span> <span class="o">&lt;</span> <span class="n">sqrDeathRange</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">DestroyDust</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 먼지 이동</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sqrDist</span> <span class="o">&lt;</span> <span class="n">sqrRange</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">float3</span> <span class="n">dir</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">offs</span><span class="p">);</span> <span class="c1">// 먼지 -&gt; 청소기 입구 방향</span>
        <span class="n">float</span> <span class="n">dotValue</span> <span class="o">=</span> <span class="nb">dot</span><span class="p">(</span><span class="n">forward</span><span class="p">,</span> <span class="o">-</span><span class="n">dir</span><span class="p">);</span>

        <span class="c1">// 원뿔 범위 내에 있을 경우 빨아들이기</span>
        <span class="k">if</span><span class="p">(</span><span class="n">dotValue</span> <span class="o">&gt;</span> <span class="n">dotThreshold</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">float</span> <span class="n">weightedForce</span> <span class="o">=</span> <span class="n">sqrForce</span> <span class="o">/</span> <span class="n">sqrDist</span><span class="p">;</span>
            <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="o">+=</span> <span class="n">dir</span> <span class="o">*</span> <span class="n">weightedForce</span> <span class="o">*</span> <span class="n">dotValue</span><span class="p">;</span>

            <span class="c1">// 청소기 뒤편으로 넘어가면 먼지 소멸</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">headPos</span> <span class="o">-</span> <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">,</span> <span class="n">dir</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">DestroyDust</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-8"><strong>[2] 먼지 관리 컴포넌트</strong></h2>

  <ul>
    <li>미리 내적 기준값을 계산하여 컴퓨트 쉐이더에 전달한다.</li>
  </ul>

  <details>
    <summary> 
DustManager.cs
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateDustPositionsGPU</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="k">ref</span> <span class="kt">var</span> <span class="n">head</span> <span class="p">=</span> <span class="k">ref</span> <span class="n">cleanerHead</span><span class="p">;</span>
    
    <span class="c1">// 청소기 전방 벡터(+Z)</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetVector</span><span class="p">(</span><span class="s">"forward"</span><span class="p">,</span> <span class="n">head</span><span class="p">.</span><span class="n">Forward</span><span class="p">);</span>
    
    <span class="c1">// Dot(A, B) = |A||B|cos(t) 일 때, A와 B가 정규 벡터이면</span>
    <span class="c1">// Dot(A, B) = cos(t) 이므로</span>
    <span class="c1">// 원뿔 각도 t를 이용해 미리 계산한 cos(t)를 컴퓨트 쉐이더에 전달한다.</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"dotThreshold"</span><span class="p">,</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Cos</span><span class="p">(</span><span class="n">head</span><span class="p">.</span><span class="n">SuctionAngleRad</span><span class="p">));</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-9"><strong>[3] 진공 청소기 컴포넌트</strong></h2>

  <ul>
    <li>숄더뷰 이동/회전을 구현한다.</li>
    <li>이동과 좌우 회전은 부모 오브젝트가 담당하고, 상하 회전은 이 컴포넌트가 있는 게임오브젝트가 담당한다.</li>
    <li>마우스 우클릭에 따라 마우스를 숨기고 드러낼 수 있도록 구현한다.</li>
    <li>원뿔 기즈모를 그린다.</li>
  </ul>

  <details>
    <summary> 
VacuumCleanerHead.cs
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">bool</span> <span class="n">run</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>

<span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">100f</span><span class="p">),</span> <span class="nf">Tooltip</span><span class="p">(</span><span class="s">"빨아들이는 힘"</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">suctionForce</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>

<span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">1f</span><span class="p">,</span> <span class="m">50f</span><span class="p">),</span> <span class="nf">Tooltip</span><span class="p">(</span><span class="s">"빨아들이는 범위(거리)"</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">suctionRange</span> <span class="p">=</span> <span class="m">5f</span><span class="p">;</span>

<span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0.01f</span><span class="p">,</span> <span class="m">90f</span><span class="p">),</span> <span class="nf">Tooltip</span><span class="p">(</span><span class="s">"빨아들이는 원뿔 각도"</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">suctionAngle</span> <span class="p">=</span> <span class="m">45f</span><span class="p">;</span>

<span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0.01f</span><span class="p">,</span> <span class="m">5f</span><span class="p">),</span> <span class="nf">Tooltip</span><span class="p">(</span><span class="s">"먼지가 사망하는 영역 반지름"</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">deathRange</span> <span class="p">=</span> <span class="m">0.2f</span><span class="p">;</span>

<span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0.01f</span><span class="p">,</span> <span class="m">100f</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">moveSpeed</span> <span class="p">=</span> <span class="m">50f</span><span class="p">;</span>

<span class="k">private</span> <span class="n">Transform</span> <span class="n">parent</span><span class="p">;</span>
<span class="k">private</span> <span class="kt">float</span> <span class="n">deltaTime</span><span class="p">;</span>
<span class="k">private</span> <span class="kt">bool</span> <span class="n">mouseLocked</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

<span class="k">public</span> <span class="kt">bool</span> <span class="n">Running</span> <span class="p">=&gt;</span> <span class="n">run</span><span class="p">;</span>
<span class="k">public</span> <span class="kt">float</span> <span class="n">SqrSuctionRange</span> <span class="p">=&gt;</span> <span class="n">suctionRange</span> <span class="p">*</span> <span class="n">suctionRange</span><span class="p">;</span>
<span class="k">public</span> <span class="kt">float</span> <span class="n">SuctionForce</span> <span class="p">=&gt;</span> <span class="n">suctionForce</span><span class="p">;</span>
<span class="k">public</span> <span class="kt">float</span> <span class="n">DeathRange</span> <span class="p">=&gt;</span> <span class="n">deathRange</span><span class="p">;</span>
<span class="k">public</span> <span class="kt">float</span> <span class="n">SuctionAngleRad</span> <span class="p">=&gt;</span> <span class="n">suctionAngle</span> <span class="p">*</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">Deg2Rad</span><span class="p">;</span>

<span class="k">public</span> <span class="n">Vector3</span> <span class="n">Position</span> <span class="p">=&gt;</span> <span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">;</span>
<span class="k">public</span> <span class="n">Vector3</span> <span class="n">Forward</span> <span class="p">=&gt;</span> <span class="n">transform</span><span class="p">.</span><span class="n">forward</span><span class="p">;</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Awake</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">parent</span> <span class="p">=</span> <span class="n">transform</span><span class="p">.</span><span class="n">parent</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">OnDrawGizmos</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Gizmos</span><span class="p">.</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">blue</span><span class="p">;</span>
    <span class="nf">DrawConeGizmo</span><span class="p">(</span><span class="n">Position</span><span class="p">,</span> <span class="n">suctionRange</span><span class="p">,</span> <span class="n">suctionAngle</span><span class="p">);</span>

    <span class="c1">//Gizmos.color = Color.red;</span>
    <span class="c1">//Gizmos.DrawWireSphere(Position, deathRange);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">deltaTime</span> <span class="p">=</span> <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span><span class="p">;</span>

    <span class="nf">MouseControl</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">mouseLocked</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nf">Move</span><span class="p">();</span>
        <span class="nf">Rotate</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">MouseControl</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// On/Off</span>
    <span class="n">run</span> <span class="p">=</span> <span class="n">Input</span><span class="p">.</span><span class="nf">GetMouseButton</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>

    <span class="c1">// 마우스 보이기/숨기기</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="nf">GetMouseButtonDown</span><span class="p">(</span><span class="m">1</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">mouseLocked</span> <span class="p">^=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">Cursor</span><span class="p">.</span><span class="n">lockState</span> <span class="p">=</span> <span class="n">mouseLocked</span> <span class="p">?</span> <span class="n">CursorLockMode</span><span class="p">.</span><span class="n">Locked</span> <span class="p">:</span> <span class="n">CursorLockMode</span><span class="p">.</span><span class="n">None</span><span class="p">;</span>
        <span class="n">Cursor</span><span class="p">.</span><span class="n">visible</span> <span class="p">=</span> <span class="p">!</span><span class="n">mouseLocked</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Move</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">x</span> <span class="p">=</span> <span class="n">Input</span><span class="p">.</span><span class="nf">GetAxisRaw</span><span class="p">(</span><span class="s">"Horizontal"</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">z</span> <span class="p">=</span> <span class="n">Input</span><span class="p">.</span><span class="nf">GetAxisRaw</span><span class="p">(</span><span class="s">"Vertical"</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">y</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="nf">GetKey</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">Space</span><span class="p">))</span> <span class="n">y</span> <span class="p">+=</span> <span class="p">.</span><span class="m">5f</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="nf">GetKey</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">LeftControl</span><span class="p">))</span> <span class="n">y</span> <span class="p">-=</span> <span class="p">.</span><span class="m">5f</span><span class="p">;</span>

    <span class="n">Vector3</span> <span class="n">moveVec</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vector3</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">).</span><span class="n">normalized</span> <span class="p">*</span> <span class="n">moveSpeed</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="nf">GetKey</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">LeftShift</span><span class="p">))</span>
        <span class="n">moveVec</span> <span class="p">*=</span> <span class="m">2f</span><span class="p">;</span>

    <span class="n">parent</span><span class="p">.</span><span class="nf">Translate</span><span class="p">(</span><span class="n">moveVec</span> <span class="p">*</span> <span class="n">deltaTime</span><span class="p">,</span> <span class="n">Space</span><span class="p">.</span><span class="n">Self</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Rotate</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">v</span> <span class="p">=</span> <span class="n">Input</span><span class="p">.</span><span class="nf">GetAxisRaw</span><span class="p">(</span><span class="s">"Mouse X"</span><span class="p">)</span> <span class="p">*</span> <span class="n">deltaTime</span> <span class="p">*</span> <span class="m">100f</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">h</span> <span class="p">=</span> <span class="n">Input</span><span class="p">.</span><span class="nf">GetAxisRaw</span><span class="p">(</span><span class="s">"Mouse Y"</span><span class="p">)</span> <span class="p">*</span> <span class="n">deltaTime</span> <span class="p">*</span> <span class="m">100f</span><span class="p">;</span>

    <span class="c1">// 부모 : 좌우 회전</span>
    <span class="n">parent</span><span class="p">.</span><span class="n">localRotation</span> <span class="p">*=</span> <span class="n">Quaternion</span><span class="p">.</span><span class="nf">Euler</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>

    <span class="c1">// 상하 회전</span>
    <span class="n">Vector3</span> <span class="n">eRot</span> <span class="p">=</span> <span class="n">transform</span><span class="p">.</span><span class="n">localEulerAngles</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">nextX</span> <span class="p">=</span> <span class="n">eRot</span><span class="p">.</span><span class="n">x</span> <span class="p">-</span> <span class="n">h</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="m">0f</span> <span class="p">&lt;</span> <span class="n">nextX</span> <span class="p">&amp;&amp;</span> <span class="n">nextX</span> <span class="p">&lt;</span> <span class="m">90f</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">eRot</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="n">nextX</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">transform</span><span class="p">.</span><span class="n">localEulerAngles</span> <span class="p">=</span> <span class="n">eRot</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// origin : 원뿔 꼭대기</span>
<span class="c1">// height : 원뿔 높이</span>
<span class="c1">// angle  : 원뿔 각도</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">DrawConeGizmo</span><span class="p">(</span><span class="n">Vector3</span> <span class="n">origin</span><span class="p">,</span> <span class="kt">float</span> <span class="n">height</span><span class="p">,</span> <span class="kt">float</span> <span class="n">angle</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sample</span> <span class="p">=</span> <span class="m">24</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">deltaRad</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">PI</span> <span class="p">*</span> <span class="m">2f</span> <span class="p">/</span> <span class="n">sample</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">circleRadius</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Tan</span><span class="p">(</span><span class="n">angle</span> <span class="p">*</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">Deg2Rad</span><span class="p">)</span> <span class="p">*</span> <span class="n">height</span><span class="p">;</span>
    <span class="n">Vector3</span> <span class="n">forward</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">forward</span> <span class="p">*</span> <span class="n">height</span><span class="p">;</span>

    <span class="n">Vector3</span> <span class="n">prevPoint</span> <span class="p">=</span> <span class="k">default</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;=</span> <span class="n">sample</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="kt">float</span> <span class="n">delta</span> <span class="p">=</span> <span class="n">deltaRad</span> <span class="p">*</span> <span class="n">i</span><span class="p">;</span>
        <span class="n">Vector3</span> <span class="n">circlePoint</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vector3</span><span class="p">(</span><span class="n">Mathf</span><span class="p">.</span><span class="nf">Cos</span><span class="p">(</span><span class="n">delta</span><span class="p">),</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Sin</span><span class="p">(</span><span class="n">delta</span><span class="p">),</span> <span class="m">0f</span><span class="p">)</span> <span class="p">*</span> <span class="n">circleRadius</span><span class="p">;</span>
        <span class="n">circlePoint</span> <span class="p">+=</span> <span class="n">forward</span><span class="p">;</span>
        <span class="n">circlePoint</span> <span class="p">=</span> <span class="n">circlePoint</span><span class="p">.</span><span class="n">normalized</span> <span class="p">*</span> <span class="n">height</span><span class="p">;</span>

        <span class="n">circlePoint</span> <span class="p">=</span> <span class="n">transform</span><span class="p">.</span><span class="nf">TransformPoint</span><span class="p">(</span><span class="n">circlePoint</span><span class="p">);</span>

        <span class="n">Gizmos</span><span class="p">.</span><span class="nf">DrawLine</span><span class="p">(</span><span class="n">circlePoint</span><span class="p">,</span> <span class="n">origin</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
            <span class="n">Gizmos</span><span class="p">.</span><span class="nf">DrawLine</span><span class="p">(</span><span class="n">circlePoint</span><span class="p">,</span> <span class="n">prevPoint</span><span class="p">);</span>
        <span class="n">prevPoint</span> <span class="p">=</span> <span class="n">circlePoint</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-10"><strong>[4] 실행 결과</strong></h2>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135104053-80e78eea-bd33-4ea5-8990-29f7d43c1f61.gif" alt="2021_0927_Dust_3D_Cone" /></p>

  <p><br /></p>

</details>
<!-- --------------------------------------------------------------------------- -->

<h1 id="5-물리-계산">5. 물리 계산</h1>
<hr />

<details>
  <summary> 
…
</summary>

  <p><br /></p>

  <p>먼지의 속도를 새로운 컴퓨트 버퍼에 저장한다.</p>

  <p>기존의 <code class="language-plaintext highlighter-rouge">Dust</code> 구조체에 속도를 포함시키지 않고 새로운 버퍼를 만들어 저장하는 이유는</p>

  <p>컴퓨트 쉐이더 내에서만 기록하는 용도로 사용되며, 다른 쉐이더(Vert/Frag)에서는 참조할 필요가 없기 때문이다.</p>

  <p>기존의 계산을 속도, 가속도, 힘 기반으로 변경하고, 중력과 공기저항력을 계산한다.</p>

  <p>그리고 현재 위치와 다음 위치 벡터를 이용해 기본적인 충돌(Plane)을 구현한다.</p>

  <p><br /></p>

  <h2 id="section-11"><strong>[1] 컴퓨트 쉐이더</strong></h2>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">velocityBuffer</code> 변수 선언</li>
    <li>물리 계산에 필요한 변수들 선언</li>
    <li>청소기 흡수 계산을 단순 위치 변동 대신 힘 계산으로 변경</li>
    <li>힘, 가속도, 속도 계산 적용</li>
    <li>원뿔 영역 교차, Plane 충돌 구현</li>
  </ul>

  <details>
    <summary> 
DustCompute.compute
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
</pre></td><td class="rouge-code"><pre><span class="kt">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">Dust</span><span class="o">&gt;</span> <span class="n">dustBuffer</span><span class="p">;</span>        <span class="c1">// 먼지 위치, 생존 여부</span>
<span class="kt">RWStructuredBuffer</span><span class="o">&lt;</span><span class="kt">float3</span><span class="o">&gt;</span> <span class="n">velocityBuffer</span><span class="p">;</span>  <span class="c1">// 먼지 속도</span>
<span class="kt">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">uint</span><span class="o">&gt;</span> <span class="n">aliveNumberBuffer</span><span class="p">;</span> <span class="c1">// 생존한 먼지 개수</span>

<span class="n">int</span> <span class="n">isRunning</span><span class="p">;</span>    <span class="c1">// 청소기 가동 여부</span>
<span class="n">float</span> <span class="n">deltaTime</span><span class="p">;</span>

<span class="kt">float3</span> <span class="n">boundsMin</span><span class="p">;</span> <span class="c1">// 먼지 생성 영역 - 최소 지점</span>
<span class="kt">float3</span> <span class="n">boundsMax</span><span class="p">;</span> <span class="c1">// 먼지 생성 영역 - 최대 지점</span>

<span class="kt">float3</span> <span class="n">headPos</span><span class="p">;</span>      <span class="c1">// 진공 청소기 입구 위치</span>
<span class="n">float</span> <span class="n">sqrRange</span><span class="p">;</span>      <span class="c1">// 먼지 흡입 범위(반지름) - 제곱</span>
<span class="n">float</span> <span class="n">sqrDeathRange</span><span class="p">;</span> <span class="c1">// 먼지 소멸 범위(반지름) - 제곱</span>
<span class="n">float</span> <span class="n">sqrForce</span><span class="p">;</span>      <span class="c1">// 빨아들이는 힘 - 제곱</span>

<span class="kt">float3</span> <span class="n">headForwardDir</span><span class="p">;</span> <span class="c1">// 진공 청소기 전방 벡터</span>
<span class="n">float</span> <span class="n">dotThreshold</span><span class="p">;</span>    <span class="c1">// 진공 청소기 원뿔 영역 내적 범위</span>

<span class="n">float</span> <span class="n">mass</span><span class="p">;</span>          <span class="c1">// 질량</span>
<span class="n">float</span> <span class="n">gravityForce</span><span class="p">;</span>  <span class="c1">// -Y 방향 중력 강도</span>
<span class="n">float</span> <span class="n">airResistance</span><span class="p">;</span> <span class="c1">// 공기 저항력</span>

<span class="p">[</span><span class="nb">numthreads</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
<span class="kt">void</span> <span class="nf">Update</span> <span class="p">(</span><span class="n">uint3</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="n">bool</span> <span class="n">sucking</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="kt">float3</span> <span class="n">F</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 힘 합 벡터</span>
    <span class="kt">float3</span> <span class="n">A</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 가속도 합 벡터</span>
    
    <span class="c1">// ===================================================</span>
    <span class="c1">//                  청소기로 먼지 흡수</span>
    <span class="c1">// ===================================================</span>
    <span class="kt">float3</span> <span class="n">currPos</span> <span class="o">=</span> <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">;</span>  <span class="c1">// 현재 프레임 먼지 위치</span>
    <span class="kt">float3</span> <span class="n">currToHead</span> <span class="o">=</span> <span class="p">(</span><span class="n">headPos</span> <span class="o">-</span> <span class="n">currPos</span><span class="p">);</span>  <span class="c1">// 청소기 입구 -&gt; 먼지</span>
    <span class="n">float</span> <span class="n">sqrDist</span> <span class="o">=</span> <span class="n">SqrMagnitude</span><span class="p">(</span><span class="n">currToHead</span><span class="p">);</span> <span class="c1">// 청소기 입구 &lt;-&gt; 먼지 사이 거리 제곱</span>

    <span class="c1">// 먼지 이동</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isRunning</span> <span class="o">==</span> <span class="n">TRUE</span> <span class="o">&amp;&amp;</span> <span class="n">sqrDist</span> <span class="o">&lt;</span> <span class="n">sqrRange</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">float3</span> <span class="n">dustToHeadDir</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">currToHead</span><span class="p">);</span> <span class="c1">// 먼지 -&gt; 청소기 입구 방향</span>
        <span class="n">float</span> <span class="n">dotValue</span> <span class="o">=</span> <span class="nb">dot</span><span class="p">(</span><span class="n">headForwardDir</span><span class="p">,</span> <span class="o">-</span><span class="n">dustToHeadDir</span><span class="p">);</span>

        <span class="c1">// 원뿔 범위 내에 있을 경우 빨아들이기</span>
        <span class="k">if</span><span class="p">(</span><span class="n">dotValue</span> <span class="o">&gt;</span> <span class="n">dotThreshold</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">float</span> <span class="n">suctionForce</span> <span class="o">=</span> <span class="n">sqrForce</span> <span class="o">/</span> <span class="n">sqrDist</span><span class="p">;</span>

            <span class="c1">// 빨아들이는 힘</span>
            <span class="n">F</span> <span class="o">+=</span> <span class="n">dustToHeadDir</span> <span class="o">*</span> <span class="n">suctionForce</span> <span class="o">*</span> <span class="n">dotValue</span><span class="p">;</span>

            <span class="n">sucking</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// F = m * a</span>
    <span class="c1">// v = a * t</span>

    <span class="c1">// ===================================================</span>
    <span class="c1">//                    가속도 계산</span>
    <span class="c1">// ===================================================</span>
    <span class="c1">// [1] 외력</span>
    <span class="n">A</span> <span class="o">+=</span> <span class="n">F</span> <span class="o">/</span> <span class="n">mass</span><span class="p">;</span>

    <span class="c1">// [2] 중력</span>
    <span class="n">A</span> <span class="o">+=</span> <span class="kt">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">gravityForce</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="c1">// [3] 공기 저항</span>
    <span class="n">A</span> <span class="o">-=</span> <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">airResistance</span><span class="p">;</span>

    <span class="c1">// 속도 적용 : V = A * t</span>
    <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">A</span> <span class="o">*</span> <span class="n">deltaTime</span><span class="p">;</span>
    
    <span class="c1">// ===================================================</span>
    <span class="c1">//              이동 시뮬레이션, 충돌 검사</span>
    <span class="c1">// ===================================================</span>
    <span class="c1">// 다음 프레임 위치 계산 : S = S0 + V * t</span>
    <span class="kt">float3</span> <span class="n">nextPos</span> <span class="o">=</span> <span class="n">currPos</span> <span class="o">+</span> <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">deltaTime</span><span class="p">;</span>

    <span class="c1">// 교차 지점에서 충돌 검사</span>
    <span class="c1">// [1] Plane (Y = 0)</span>
    <span class="n">nextPos</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nextPos</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>

    <span class="c1">// [2] 입구로 완전히 빨아들인 경우, 먼지 파괴</span>
    <span class="k">if</span><span class="p">(</span><span class="n">sucking</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">float3</span> <span class="n">headToNext</span> <span class="o">=</span> <span class="n">nextPos</span> <span class="o">-</span> <span class="n">headPos</span><span class="p">;</span>

        <span class="kt">float3</span> <span class="n">headToCurrDir</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="o">-</span><span class="n">currToHead</span><span class="p">);</span>
        <span class="kt">float3</span> <span class="n">headToNextDir</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">headToNext</span><span class="p">);</span>

        <span class="c1">// 현재 프레임에 먼지가 원뿔 범위 내에 있었다면</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">headForwardDir</span><span class="p">,</span> <span class="n">headToCurrDir</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">dotThreshold</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 다음 프레임에 원뿔 밖으로 나가거나 입구에 근접하면 파괴</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">headForwardDir</span><span class="p">,</span> <span class="n">headToNextDir</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">dotThreshold</span> <span class="o">||</span>
               <span class="n">SqrMagnitude</span><span class="p">(</span><span class="n">headToNext</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">sqrDeathRange</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">DestroyDust</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// 다음 위치 적용</span>
    <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="o">=</span> <span class="n">nextPos</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-12"><strong>[2] 먼지 관리 컴포넌트</strong></h2>

  <ul>
    <li>먼지의 속도를 저장하기 위한 새로운 컴퓨트 버퍼 <code class="language-plaintext highlighter-rouge">dustVelocityBuffer</code>를 만들고 컴퓨트 쉐이더에 할당한다.</li>
    <li>물리 시뮬레이션에 필요한 변수들을 추가하고 컴퓨트 쉐이더에 전달한다.</li>
    <li>메소드 구조를 더 깔끔하게 변경한다.</li>
  </ul>

  <details>
    <summary> 
DustManager.cs
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="nf">Header</span><span class="p">(</span><span class="s">"Physics Options"</span><span class="p">)]</span>
<span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">20f</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">mass</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>           <span class="c1">// 먼지 질량</span>
<span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">20f</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">gravityForce</span> <span class="p">=</span> <span class="m">9.8f</span><span class="p">;</span> <span class="c1">// 중력 강도</span>
<span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">100f</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">airResistance</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>  <span class="c1">// 공기 저항력</span>

<span class="k">private</span> <span class="n">ComputeBuffer</span> <span class="n">dustVelocityBuffer</span><span class="p">;</span> <span class="c1">// 먼지 현재 속도 버퍼</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">InitBuffers</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="c1">// Dust Velocity Buffer</span>
    <span class="n">dustVelocityBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="n">instanceNumber</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="p">*</span> <span class="m">3</span><span class="p">);</span>

    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="c1">/// &lt;summary&gt; 컴퓨트 쉐이더 초기화 &lt;/summary&gt;</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">InitComputeShader</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernelUpdateID</span><span class="p">,</span> <span class="s">"velocityBuffer"</span><span class="p">,</span> <span class="n">dustVelocityBuffer</span><span class="p">);</span>
    
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">OnDestroy</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="n">dustVelocityBuffer</span><span class="p">.</span><span class="nf">Release</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateDustPositionsGPU</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">ref</span> <span class="kt">var</span> <span class="n">head</span> <span class="p">=</span> <span class="k">ref</span> <span class="n">cleanerHead</span><span class="p">;</span>

    <span class="n">Vector3</span> <span class="n">headPos</span> <span class="p">=</span> <span class="n">head</span><span class="p">.</span><span class="n">Position</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">sqrRange</span> <span class="p">=</span> <span class="n">head</span><span class="p">.</span><span class="n">SqrSuctionRange</span><span class="p">;</span>
    <span class="c1">//float sqrDeathRange = head.DeathRange * head.DeathRange;</span>
    <span class="kt">float</span> <span class="n">sqrForce</span>      <span class="p">=</span> <span class="n">head</span><span class="p">.</span><span class="n">SuctionForce</span> <span class="p">*</span> <span class="n">head</span><span class="p">.</span><span class="n">SuctionForce</span><span class="p">;</span>

    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetInt</span><span class="p">(</span><span class="s">"isRunning"</span><span class="p">,</span> <span class="n">head</span><span class="p">.</span><span class="n">Running</span> <span class="p">?</span> <span class="n">TRUE</span> <span class="p">:</span> <span class="n">FALSE</span><span class="p">);</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"deltaTime"</span><span class="p">,</span> <span class="n">deltaTime</span><span class="p">);</span>

    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetVector</span><span class="p">(</span><span class="s">"headPos"</span><span class="p">,</span> <span class="n">headPos</span><span class="p">);</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"sqrRange"</span><span class="p">,</span> <span class="n">sqrRange</span><span class="p">);</span>
    <span class="c1">//dustCompute.SetFloat("sqrDeathRange", sqrDeathRange);</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"sqrForce"</span><span class="p">,</span> <span class="n">sqrForce</span><span class="p">);</span>

    <span class="c1">// 원뿔</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetVector</span><span class="p">(</span><span class="s">"headForwardDir"</span><span class="p">,</span> <span class="n">head</span><span class="p">.</span><span class="n">Forward</span><span class="p">);</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"dotThreshold"</span><span class="p">,</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Cos</span><span class="p">(</span><span class="n">head</span><span class="p">.</span><span class="n">SuctionAngleRad</span><span class="p">));</span>

    <span class="c1">// 물리</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"mass"</span><span class="p">,</span> <span class="n">mass</span><span class="p">);</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"gravityForce"</span><span class="p">,</span> <span class="n">gravityForce</span><span class="p">);</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"airResistance"</span><span class="p">,</span> <span class="n">airResistance</span><span class="p">);</span>

    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">Dispatch</span><span class="p">(</span><span class="n">kernelUpdateID</span><span class="p">,</span> <span class="n">kernelGroupSizeX</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>

    <span class="n">aliveNumberBuffer</span><span class="p">.</span><span class="nf">GetData</span><span class="p">(</span><span class="n">aliveNumberArray</span><span class="p">);</span>
    <span class="n">aliveNumber</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">aliveNumberArray</span><span class="p">[</span><span class="m">0</span><span class="p">];</span> 
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <details>
    <summary> 
DustManager.cs - 메소드 구조 변경
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="rouge-code"><pre><span class="k">private</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nf">Init</span><span class="p">();</span>
    <span class="nf">InitBuffers</span><span class="p">();</span>
    <span class="nf">SetBuffersToShaders</span><span class="p">();</span>
    <span class="nf">PopulateDusts</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Init</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">aliveNumber</span> <span class="p">=</span> <span class="n">instanceNumber</span><span class="p">;</span>

    <span class="n">kernelPopulateID</span> <span class="p">=</span> <span class="n">dustCompute</span><span class="p">.</span><span class="nf">FindKernel</span><span class="p">(</span><span class="s">"Populate"</span><span class="p">);</span>
    <span class="n">kernelUpdateID</span> <span class="p">=</span> <span class="n">dustCompute</span><span class="p">.</span><span class="nf">FindKernel</span><span class="p">(</span><span class="s">"Update"</span><span class="p">);</span>

    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">GetKernelThreadGroupSizes</span><span class="p">(</span><span class="n">kernelUpdateID</span><span class="p">,</span> <span class="k">out</span> <span class="kt">uint</span> <span class="n">tx</span><span class="p">,</span> <span class="k">out</span> <span class="n">_</span><span class="p">,</span> <span class="k">out</span> <span class="n">_</span><span class="p">);</span>
    <span class="n">kernelGroupSizeX</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">CeilToInt</span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="n">instanceNumber</span> <span class="p">/</span> <span class="n">tx</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">/// &lt;summary&gt; 컴퓨트 버퍼들 생성 &lt;/summary&gt;</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">InitBuffers</span><span class="p">()</span>
<span class="p">{</span>
    <span class="cm">/* [Note]
     * 
     * argsBuffer
     * - IndirectArguments로 사용되는 컴퓨트 버퍼의 stride는 20byte 이상이어야 한다.
     * - 따라서 파라미터가 앞의 2개만 필요하지만, 뒤에 의미 없는 파라미터 3개를 더 넣어준다.
     */</span>

    <span class="c1">// Args Buffer</span>
    <span class="kt">uint</span><span class="p">[]</span> <span class="n">argsData</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">uint</span><span class="p">[]</span> <span class="p">{</span> <span class="n">dustMesh</span><span class="p">.</span><span class="nf">GetIndexCount</span><span class="p">(</span><span class="m">0</span><span class="p">),</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">instanceNumber</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span> <span class="p">};</span>
    <span class="n">argsBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">5</span> <span class="p">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint</span><span class="p">),</span> <span class="n">ComputeBufferType</span><span class="p">.</span><span class="n">IndirectArguments</span><span class="p">);</span>
    <span class="n">argsBuffer</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="n">argsData</span><span class="p">);</span>

    <span class="c1">// Dust Buffer</span>
    <span class="n">dustBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="n">instanceNumber</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="p">*</span> <span class="m">3</span> <span class="p">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>

    <span class="c1">// Dust Velocity Buffer</span>
    <span class="n">dustVelocityBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="n">instanceNumber</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="p">*</span> <span class="m">3</span><span class="p">);</span>

    <span class="c1">// Alive Number Buffer</span>
    <span class="n">aliveNumberBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint</span><span class="p">));</span>
    <span class="n">aliveNumberArray</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">uint</span><span class="p">[]</span> <span class="p">{</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">instanceNumber</span> <span class="p">};</span>
    <span class="n">aliveNumberBuffer</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="n">aliveNumberArray</span><span class="p">);</span>

    <span class="c1">// 카메라 프러스텀이 이 영역과 겹치지 않으면 렌더링되지 않는다.</span>
    <span class="n">frustumOverlapBounds</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Bounds</span><span class="p">(</span>
        <span class="n">Vector3</span><span class="p">.</span><span class="n">zero</span><span class="p">,</span> 
        <span class="k">new</span> <span class="nf">Vector3</span><span class="p">(</span><span class="n">distributionRange</span><span class="p">,</span> <span class="n">distributionHeight</span><span class="p">,</span> <span class="n">distributionRange</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">/// &lt;summary&gt; 컴퓨트 버퍼들을 쉐이더에 할당 &lt;/summary&gt;</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">SetBuffersToShaders</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">dustMaterial</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="s">"_DustBuffer"</span><span class="p">,</span> <span class="n">dustBuffer</span><span class="p">);</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernelPopulateID</span><span class="p">,</span> <span class="s">"dustBuffer"</span><span class="p">,</span> <span class="n">dustBuffer</span><span class="p">);</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernelUpdateID</span><span class="p">,</span> <span class="s">"dustBuffer"</span><span class="p">,</span> <span class="n">dustBuffer</span><span class="p">);</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernelUpdateID</span><span class="p">,</span> <span class="s">"aliveNumberBuffer"</span><span class="p">,</span> <span class="n">aliveNumberBuffer</span><span class="p">);</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernelUpdateID</span><span class="p">,</span> <span class="s">"velocityBuffer"</span><span class="p">,</span> <span class="n">dustVelocityBuffer</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-13"><strong>[3] 실행 결과</strong></h2>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135263865-39b67857-42ec-42e3-b521-e03e8f7fd47f.gif" alt="2021_0929_Dust_Physics1" /></p>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135263875-3c8238ee-9ed3-49c4-9366-4bab7619118d.gif" alt="2021_0929_Dust_Physics2" /></p>

  <p><br /></p>

</details>
<!-- --------------------------------------------------------------------------- -->

<h1 id="6-메시-변경-쉐이더-수정">6. 메시 변경, 쉐이더 수정</h1>
<hr />

<details>
  <summary> 
…
</summary>

  <p><br /></p>

  <p>Cube 메시 대신 Quad 메시를 사용한다.</p>

  <p>렌더 타입을 Transparent로 바꾸고, 먼지 텍스쳐를 적용한다.</p>

  <p>그리고 Billboard 효과를 적용한다.</p>

  <p>GPU 인스턴싱을 이용해 그리며, 하나의 트랜스폼을 기반으로 하므로 보통의 빌보드 쉐이더와는 다른 연산을 적용해야 한다.</p>

  <p><br /></p>

  <h2 id="section-14"><strong>[1] 먼지 쉐이더</strong></h2>

  <details>
    <summary> 
DustShader.shader
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
</pre></td><td class="rouge-code"><pre><span class="n">Properties</span>
<span class="p">{</span>
    <span class="n">_MainTex</span> <span class="p">(</span><span class="s">"Texture"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="n">_Color</span><span class="p">(</span><span class="s">"Color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">SubShader</span>
<span class="p">{</span>
    <span class="n">Tags</span> <span class="p">{</span> <span class="s">"Queue"</span><span class="o">=</span><span class="s">"Geometry"</span> <span class="s">"RenderType"</span><span class="o">=</span><span class="s">"Transparent"</span> <span class="s">"IgnoreProjector"</span><span class="o">=</span><span class="s">"True"</span> <span class="p">}</span>
    <span class="n">ZWrite</span> <span class="n">Off</span>
    <span class="n">Lighting</span> <span class="n">Off</span>
    <span class="n">Fog</span> <span class="p">{</span> <span class="n">Mode</span> <span class="n">Off</span> <span class="p">}</span>
    <span class="n">Blend</span> <span class="n">SrcAlpha</span> <span class="n">OneMinusSrcAlpha</span> 

    <span class="n">Pass</span>
    <span class="p">{</span>
        <span class="n">CGPROGRAM</span>
        <span class="cp">#pragma vertex vert
</span>        <span class="cp">#pragma fragment frag
</span>
        <span class="cp">#include "UnityCG.cginc"
</span>        <span class="cp">#define TRUE 1
</span>        <span class="cp">#define FALSE 0
</span>
        <span class="k">struct</span> <span class="n">v2f</span>
        <span class="p">{</span>
            <span class="kt">float4</span> <span class="n">pos</span>    <span class="o">:</span> <span class="nb">SV_POSITION</span><span class="p">;</span>
            <span class="kt">float3</span> <span class="n">uv</span>     <span class="o">:</span> <span class="nb">TEXCOORD0</span><span class="p">;</span>
            <span class="n">int</span> <span class="n">isAlive</span>   <span class="o">:</span> <span class="nb">TEXCOORD1</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="k">struct</span> <span class="n">Dust</span>
        <span class="p">{</span>
            <span class="kt">float3</span> <span class="n">position</span><span class="p">;</span>
            <span class="n">int</span> <span class="n">isAlive</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="c1">// ========================================================================================</span>
        <span class="c1">//                                  Vertex Shader</span>
        <span class="c1">// ========================================================================================</span>
        <span class="k">uniform</span> <span class="n">float</span> <span class="n">_Scale</span><span class="p">;</span>
        <span class="kt">StructuredBuffer</span><span class="o">&lt;</span><span class="n">Dust</span><span class="o">&gt;</span> <span class="n">_DustBuffer</span><span class="p">;</span>

        <span class="kt">float4</span> <span class="n">CalculateVertex</span><span class="p">(</span><span class="kt">float4</span> <span class="n">vertex</span><span class="p">,</span> <span class="kt">float3</span> <span class="n">worldPos</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">float3</span> <span class="n">camUpVec</span>      <span class="o">=</span>  <span class="nb">normalize</span><span class="p">(</span> <span class="n">UNITY_MATRIX_V</span><span class="p">.</span><span class="n">_m10_m11_m12</span> <span class="p">);</span>
            <span class="kt">float3</span> <span class="n">camForwardVec</span> <span class="o">=</span> <span class="o">-</span><span class="nb">normalize</span><span class="p">(</span> <span class="n">UNITY_MATRIX_V</span><span class="p">.</span><span class="n">_m20_m21_m22</span> <span class="p">);</span>
            <span class="kt">float3</span> <span class="n">camRightVec</span>   <span class="o">=</span>  <span class="nb">normalize</span><span class="p">(</span> <span class="n">UNITY_MATRIX_V</span><span class="p">.</span><span class="n">_m00_m01_m02</span> <span class="p">);</span>
            <span class="kt">float4x4</span> <span class="n">camRotMat</span>   <span class="o">=</span> <span class="kt">float4x4</span><span class="p">(</span> <span class="n">camRightVec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">camUpVec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">camForwardVec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>

            <span class="n">vertex</span> <span class="o">=</span> <span class="nb">mul</span><span class="p">(</span><span class="n">vertex</span><span class="p">,</span> <span class="n">camRotMat</span><span class="p">);</span> <span class="c1">// Billboard</span>
            <span class="n">vertex</span><span class="p">.</span><span class="n">xyz</span> <span class="o">*=</span> <span class="n">_Scale</span><span class="p">;</span>   <span class="c1">// Scale</span>
            <span class="n">vertex</span><span class="p">.</span><span class="n">xyz</span> <span class="o">+=</span> <span class="n">worldPos</span><span class="p">;</span> <span class="c1">// Instance Position</span>

            <span class="c1">// World =&gt; VP =&gt; Clip</span>
            <span class="k">return</span> <span class="nb">mul</span><span class="p">(</span><span class="n">UNITY_MATRIX_VP</span><span class="p">,</span> <span class="n">vertex</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">v2f</span> <span class="n">vert</span> <span class="p">(</span><span class="n">appdata_full</span> <span class="n">v</span><span class="p">,</span> <span class="n">uint</span> <span class="n">instanceID</span> <span class="o">:</span> <span class="n">SV_InstanceID</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>

            <span class="n">o</span><span class="p">.</span><span class="n">isAlive</span> <span class="o">=</span> <span class="n">_DustBuffer</span><span class="p">[</span><span class="n">instanceID</span><span class="p">].</span><span class="n">isAlive</span><span class="p">;</span>
            <span class="n">o</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">CalculateVertex</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">,</span> <span class="n">_DustBuffer</span><span class="p">[</span><span class="n">instanceID</span><span class="p">].</span><span class="n">position</span><span class="p">);</span>
            <span class="n">o</span><span class="p">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">texcoord</span><span class="p">;</span>

            <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="c1">// ========================================================================================</span>
        <span class="c1">//                                  Fragment Shader</span>
        <span class="c1">// ========================================================================================</span>
        <span class="n">sampler2D</span> <span class="n">_MainTex</span><span class="p">;</span>
        <span class="n">fixed4</span> <span class="n">_Color</span><span class="p">;</span>

        <span class="n">fixed4</span> <span class="n">frag</span> <span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_Target</span>
        <span class="p">{</span>
            <span class="c1">// 죽은 먼지는 렌더링 X</span>
            <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">isAlive</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">discard</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">fixed4</span> <span class="n">col</span> <span class="o">=</span> <span class="nb">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
            <span class="n">col</span><span class="p">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">_Color</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span> <span class="n">col</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>

            <span class="k">return</span> <span class="n">col</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">ENDCG</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-15"><strong>[2] 실행 결과</strong></h2>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135460485-cbca4440-de7e-4bac-89a9-702f57410af9.png" alt="image" /></p>

  <p>빌보드 효과는 성공적으로 적용되었으나</p>

  <p>각 먼지의 충돌 반경이 고려되지 않았으므로,</p>

  <p>다른 오브젝트와 겹치면 위와 같이 잘려 보일 수밖에 없다.</p>

  <p><br /></p>

</details>
<!-- --------------------------------------------------------------------------- -->

<h1 id="7-충돌-반경-적용">7. 충돌 반경 적용</h1>
<hr />

<details>
  <summary> 
…
</summary>

  <p><br /></p>

  <p>충돌 시 먼지의 반지름을 고려하여, 다른 오브젝트에 겹치지 않도록 한다.</p>

  <p>앞으로 각 먼지들은 점이 아닌, 반경을 가진 구체(Sphere)로 취급되어야 한다.</p>

  <p><br /></p>

  <h2 id="section-16"><strong>[1] 컴퓨트 쉐이더</strong></h2>

  <details>
    <summary> 
DustCompute.compute
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="n">float</span> <span class="n">radius</span><span class="p">;</span>        <span class="c1">// 먼지 반지름</span>

<span class="p">[</span><span class="nb">numthreads</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
<span class="kt">void</span> <span class="nf">Update</span> <span class="p">(</span><span class="n">uint3</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="c1">// 교차 지점에서 충돌 검사</span>
    <span class="c1">// [1] Plane (Y = 0)</span>
    <span class="n">nextPos</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">nextPos</span><span class="p">.</span><span class="n">y</span><span class="p">);</span> <span class="c1">// 반지름 고려</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-17"><strong>[2] 먼지 관리 컴포넌트</strong></h2>

  <details>
    <summary> 
DustManager.cs
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateDustPositionsGPU</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"radius"</span><span class="p">,</span> <span class="n">dustScale</span><span class="p">);</span>
    
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-18"><strong>[3] 실행 결과</strong></h2>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135573568-cf529963-eec0-4da1-b044-38f47bde139f.png" alt="image" /></p>

  <p><br /></p>

</details>
<!-- --------------------------------------------------------------------------- -->

<h1 id="추가--원뿔-영역-메시-구현">추가 : 원뿔 영역 메시 구현</h1>
<hr />

<details>
  <summary> 
…
</summary>

  <p>기즈모는 다른 물체보다 항상 위에 보이므로 영역을 정확히 확인하기가 어렵다.</p>

  <p>따라서 영역을 정확히 파악할 수 있도록 메시를 만들어 렌더링한다.</p>

  <p><br /></p>

  <h2 id="section-19"><strong>진공 청소기 컴포넌트</strong></h2>

  <details>
    <summary> 
VacuumCleanerHead.cs
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
</pre></td><td class="rouge-code"><pre><span class="k">private</span> <span class="n">Transform</span> <span class="n">childConeTr</span><span class="p">;</span>
<span class="p">[</span><span class="n">Space</span><span class="p">]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">Material</span> <span class="n">coneMaterial</span><span class="p">;</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Awake</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">parent</span> <span class="p">=</span> <span class="n">transform</span><span class="p">.</span><span class="n">parent</span><span class="p">;</span>
    <span class="nf">CreateChildCone</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">deltaTime</span> <span class="p">=</span> <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span><span class="p">;</span>

    <span class="nf">ChangeConeScale</span><span class="p">();</span>
    <span class="nf">MouseControl</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mouseLocked</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nf">Move</span><span class="p">();</span>
        <span class="nf">Rotate</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">/// &lt;summary&gt; 자식 게임오브젝트 생성하여 메시 렌더러, 필터 추가 &lt;/summary&gt;</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">CreateChildCone</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">GameObject</span> <span class="n">go</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">GameObject</span><span class="p">(</span><span class="s">"Cone Mesh"</span><span class="p">);</span>
    <span class="n">childConeTr</span> <span class="p">=</span> <span class="n">go</span><span class="p">.</span><span class="n">transform</span><span class="p">;</span>
    <span class="n">childConeTr</span><span class="p">.</span><span class="nf">SetParent</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>

    <span class="n">MeshRenderer</span> <span class="n">mr</span> <span class="p">=</span> <span class="n">go</span><span class="p">.</span><span class="n">AddComponent</span><span class="p">&lt;</span><span class="n">MeshRenderer</span><span class="p">&gt;();</span>
    <span class="n">mr</span><span class="p">.</span><span class="n">material</span> <span class="p">=</span> <span class="n">coneMaterial</span><span class="p">;</span>
    <span class="n">mr</span><span class="p">.</span><span class="n">shadowCastingMode</span> <span class="p">=</span> <span class="n">UnityEngine</span><span class="p">.</span><span class="n">Rendering</span><span class="p">.</span><span class="n">ShadowCastingMode</span><span class="p">.</span><span class="n">Off</span><span class="p">;</span>
    <span class="n">mr</span><span class="p">.</span><span class="n">receiveShadows</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

    <span class="n">MeshFilter</span> <span class="n">mf</span> <span class="p">=</span> <span class="n">go</span><span class="p">.</span><span class="n">AddComponent</span><span class="p">&lt;</span><span class="n">MeshFilter</span><span class="p">&gt;();</span>
    <span class="n">mf</span><span class="p">.</span><span class="n">sharedMesh</span> <span class="p">=</span> <span class="nf">CreateConeMesh</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">/// &lt;summary&gt; 원뿔 모양 메시 생성 &lt;/summary&gt;</span>
<span class="k">private</span> <span class="n">Mesh</span> <span class="nf">CreateConeMesh</span><span class="p">(</span><span class="kt">int</span> <span class="n">sample</span> <span class="p">=</span> <span class="m">24</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Mesh</span> <span class="n">mesh</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Mesh</span><span class="p">();</span>
    <span class="n">Vector3</span><span class="p">[]</span> <span class="n">verts</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector3</span><span class="p">[</span><span class="n">sample</span> <span class="p">+</span> <span class="m">1</span><span class="p">];</span>
    <span class="kt">int</span><span class="p">[]</span> <span class="n">tris</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="n">sample</span> <span class="p">*</span> <span class="m">3</span><span class="p">];</span>

    <span class="n">verts</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">zero</span><span class="p">;</span> <span class="c1">// 꼭짓점</span>
    <span class="kt">float</span> <span class="n">deltaRad</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">PI</span> <span class="p">*</span> <span class="m">2f</span> <span class="p">/</span> <span class="n">sample</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;=</span> <span class="n">sample</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="kt">float</span> <span class="n">r</span> <span class="p">=</span> <span class="n">i</span> <span class="p">*</span> <span class="n">deltaRad</span><span class="p">;</span>
        <span class="n">verts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vector3</span><span class="p">(</span><span class="n">Mathf</span><span class="p">.</span><span class="nf">Cos</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Sin</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="m">1f</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">t</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">sample</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="n">tris</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="n">tris</span><span class="p">[</span><span class="n">t</span> <span class="p">+</span> <span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="n">i</span> <span class="p">+</span> <span class="m">1</span><span class="p">;</span>
        <span class="n">tris</span><span class="p">[</span><span class="n">t</span> <span class="p">+</span> <span class="m">2</span><span class="p">]</span> <span class="p">=</span> <span class="n">i</span><span class="p">;</span>
        <span class="n">t</span> <span class="p">+=</span> <span class="m">3</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">tris</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="n">tris</span><span class="p">[</span><span class="n">t</span> <span class="p">+</span> <span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
    <span class="n">tris</span><span class="p">[</span><span class="n">t</span> <span class="p">+</span> <span class="m">2</span><span class="p">]</span> <span class="p">=</span> <span class="n">sample</span><span class="p">;</span>

    <span class="n">mesh</span><span class="p">.</span><span class="n">vertices</span> <span class="p">=</span> <span class="n">verts</span><span class="p">;</span>
    <span class="n">mesh</span><span class="p">.</span><span class="n">triangles</span> <span class="p">=</span> <span class="n">tris</span><span class="p">;</span>
    <span class="n">mesh</span><span class="p">.</span><span class="nf">RecalculateNormals</span><span class="p">();</span>
    <span class="n">mesh</span><span class="p">.</span><span class="nf">RecalculateBounds</span><span class="p">();</span>

    <span class="k">return</span> <span class="n">mesh</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">/// &lt;summary&gt; 옵션 변경에 따라 자식 스케일 변경 &lt;/summary&gt;</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">ChangeConeScale</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">r</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Tan</span><span class="p">(</span><span class="n">suctionAngle</span> <span class="p">*</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">Deg2Rad</span><span class="p">)</span> <span class="p">*</span> <span class="n">suctionRange</span> <span class="p">*</span> <span class="m">0.5f</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">z</span> <span class="p">=</span> <span class="n">suctionRange</span> <span class="p">*</span> <span class="m">0.5f</span><span class="p">;</span>

    <span class="n">childConeTr</span><span class="p">.</span><span class="n">localScale</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vector3</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135713799-d07fba9d-b17c-4d2d-81b6-47ee3b73cc02.png" alt="image" /> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135713803-d67c22e0-bb4e-4b5a-a0f2-ffb22af8a97d.png" alt="image" /></p>

  <p>기본 PBR 쉐이더를 Transparent로 설정하고 적용하면 위와 같이 다른 오브젝트와 겹치는 부분이 명확하게 보이지 않는다.</p>

  <p>따라서 다음과 같은 쉐이더를 작성하여 적용한다.</p>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135714616-c3cf790e-62a9-45ef-bfc7-f9002c0f333d.png" alt="image" /></p>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135714621-aa2bc222-bbd8-4624-bdab-78b7edffd8b7.gif" alt="2021_1002_DepthIntersection" /></p>

  <p>이제 다른 오브젝트와 맞닿는 부분이 더 또렷하게 보이는 것을 확인할 수 있다.</p>

  <p><br /></p>

</details>
<!-- --------------------------------------------------------------------------- -->

<h1 id="추가--다양한-난수-생성-함수들">추가 : 다양한 난수 생성 함수들</h1>
<hr />

<details>
  <summary> 
…
</summary>

  <p>기존에는 단순히 2D 시드값을 통해 <code class="language-plaintext highlighter-rouge">float</code> 값, <code class="language-plaintext highlighter-rouge">float3</code> 값의 난수를 생성하는 함수들만 있었지만,</p>

  <p>앞으로 여러 차원의 입력 및 출력에 대응할 수 있도록 다양한 함수들을 작성한다.</p>

  <p><br /></p>

  <details>
    <summary> 
Random functions
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
</pre></td><td class="rouge-code"><pre><span class="cp">#define RM 39482.17593
#define RD1 7.8671
#define RD2 3.3419
#define RD3 5.8912
#define RP1 2.1759
#define RP2 4.7921
</span>
<span class="n">float</span> <span class="nf">Random11</span><span class="p">(</span><span class="n">float</span> <span class="n">seed</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nb">frac</span><span class="p">(</span><span class="nb">sin</span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="kt">float2</span><span class="p">(</span><span class="n">RD1</span><span class="p">,</span> <span class="n">seed</span><span class="p">),</span> <span class="kt">float2</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">RD2</span><span class="p">)))</span> <span class="o">*</span> <span class="n">RM</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">float2</span> <span class="nf">Random12</span><span class="p">(</span><span class="n">float</span> <span class="n">seed</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="kt">float2</span><span class="p">(</span>
        <span class="nb">frac</span><span class="p">(</span><span class="nb">sin</span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="kt">float2</span><span class="p">(</span><span class="n">RD1</span><span class="p">,</span> <span class="n">seed</span><span class="p">),</span> <span class="kt">float2</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">RD2</span><span class="p">)))</span> <span class="o">*</span> <span class="n">RM</span><span class="p">),</span>
        <span class="nb">frac</span><span class="p">(</span><span class="nb">sin</span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="kt">float2</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">RD2</span><span class="p">),</span> <span class="kt">float2</span><span class="p">(</span><span class="n">RD3</span><span class="p">,</span> <span class="n">seed</span><span class="p">)))</span> <span class="o">*</span> <span class="n">RM</span><span class="p">)</span>
    <span class="p">);</span>
<span class="p">}</span>
<span class="kt">float3</span> <span class="nf">Random13</span><span class="p">(</span><span class="n">float</span> <span class="n">seed</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="kt">float3</span><span class="p">(</span>
        <span class="nb">frac</span><span class="p">(</span><span class="nb">sin</span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="kt">float2</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">RD1</span><span class="p">),</span> <span class="kt">float2</span><span class="p">(</span><span class="n">RD2</span><span class="p">,</span> <span class="n">seed</span><span class="p">)))</span> <span class="o">*</span> <span class="n">RM</span><span class="p">),</span>
        <span class="nb">frac</span><span class="p">(</span><span class="nb">sin</span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="kt">float2</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">RD2</span><span class="p">),</span> <span class="kt">float2</span><span class="p">(</span><span class="n">RD3</span><span class="p">,</span> <span class="n">seed</span><span class="p">)))</span> <span class="o">*</span> <span class="n">RM</span><span class="p">),</span>
        <span class="nb">frac</span><span class="p">(</span><span class="nb">sin</span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="kt">float2</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">RD3</span><span class="p">),</span> <span class="kt">float2</span><span class="p">(</span><span class="n">RD1</span><span class="p">,</span> <span class="n">seed</span><span class="p">)))</span> <span class="o">*</span> <span class="n">RM</span><span class="p">)</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="n">float</span> <span class="nf">RandomRange11</span><span class="p">(</span><span class="n">float</span> <span class="n">seed</span><span class="p">,</span> <span class="n">float</span> <span class="nb">min</span><span class="p">,</span> <span class="n">float</span> <span class="nb">max</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nb">lerp</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="n">Random11</span><span class="p">(</span><span class="n">seed</span><span class="p">));</span> 
<span class="p">}</span>
<span class="kt">float2</span> <span class="nf">RandomRange12</span><span class="p">(</span><span class="n">float</span> <span class="n">seed</span><span class="p">,</span> <span class="kt">float2</span> <span class="nb">min</span><span class="p">,</span> <span class="kt">float2</span> <span class="nb">max</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">float2</span> <span class="n">vec</span><span class="p">;</span>
    <span class="n">vec</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">RandomRange11</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span>       <span class="nb">min</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="nb">max</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
    <span class="n">vec</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">RandomRange11</span><span class="p">(</span><span class="n">seed</span> <span class="o">+</span> <span class="n">RP1</span><span class="p">,</span> <span class="nb">min</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="nb">max</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">vec</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">float3</span> <span class="nf">RandomRange13</span><span class="p">(</span><span class="n">float</span> <span class="n">seed</span><span class="p">,</span> <span class="kt">float3</span> <span class="nb">min</span><span class="p">,</span> <span class="kt">float3</span> <span class="nb">max</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">float3</span> <span class="n">vec</span><span class="p">;</span>
    <span class="n">vec</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">RandomRange11</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span>       <span class="nb">min</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="nb">max</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
    <span class="n">vec</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">RandomRange11</span><span class="p">(</span><span class="n">seed</span> <span class="o">+</span> <span class="n">RP1</span><span class="p">,</span> <span class="nb">min</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="nb">max</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
    <span class="n">vec</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">RandomRange11</span><span class="p">(</span><span class="n">seed</span> <span class="o">+</span> <span class="n">RP2</span><span class="p">,</span> <span class="nb">min</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="nb">max</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">vec</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">float</span> <span class="nf">Random21</span><span class="p">(</span><span class="kt">float2</span> <span class="n">seed</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nb">frac</span><span class="p">(</span><span class="nb">sin</span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="kt">float2</span><span class="p">(</span><span class="n">RD1</span><span class="p">,</span> <span class="n">RD2</span><span class="p">)))</span> <span class="o">*</span> <span class="n">RM</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">float2</span> <span class="nf">Random22</span><span class="p">(</span><span class="kt">float2</span> <span class="n">seed</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="kt">float2</span><span class="p">(</span>
        <span class="nb">frac</span><span class="p">(</span><span class="nb">sin</span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span>                    <span class="kt">float2</span><span class="p">(</span><span class="n">RD1</span><span class="p">,</span> <span class="n">RD2</span><span class="p">)))</span> <span class="o">*</span> <span class="n">RM</span><span class="p">),</span>
        <span class="nb">frac</span><span class="p">(</span><span class="nb">sin</span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">seed</span> <span class="o">+</span> <span class="kt">float2</span><span class="p">(</span><span class="n">RP1</span><span class="p">,</span> <span class="n">RP2</span><span class="p">),</span> <span class="kt">float2</span><span class="p">(</span><span class="n">RD2</span><span class="p">,</span> <span class="n">RD3</span><span class="p">)))</span> <span class="o">*</span> <span class="n">RM</span><span class="p">)</span>
    <span class="p">);</span>
<span class="p">}</span>
<span class="kt">float3</span> <span class="nf">Random23</span><span class="p">(</span><span class="kt">float2</span> <span class="n">seed</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="kt">float3</span><span class="p">(</span>
        <span class="nb">frac</span><span class="p">(</span><span class="nb">sin</span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span>                    <span class="kt">float2</span><span class="p">(</span><span class="n">RD1</span><span class="p">,</span> <span class="n">RD2</span><span class="p">)))</span> <span class="o">*</span> <span class="n">RM</span><span class="p">),</span>
        <span class="nb">frac</span><span class="p">(</span><span class="nb">sin</span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">seed</span> <span class="o">+</span> <span class="kt">float2</span><span class="p">(</span><span class="n">RP1</span><span class="p">,</span> <span class="n">RP2</span><span class="p">),</span> <span class="kt">float2</span><span class="p">(</span><span class="n">RD2</span><span class="p">,</span> <span class="n">RD3</span><span class="p">)))</span> <span class="o">*</span> <span class="n">RM</span><span class="p">),</span>
        <span class="nb">frac</span><span class="p">(</span><span class="nb">sin</span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">seed</span> <span class="o">+</span> <span class="kt">float2</span><span class="p">(</span><span class="n">RP2</span><span class="p">,</span> <span class="n">RP1</span><span class="p">),</span> <span class="kt">float2</span><span class="p">(</span><span class="n">RD3</span><span class="p">,</span> <span class="n">RD1</span><span class="p">)))</span> <span class="o">*</span> <span class="n">RM</span><span class="p">)</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="n">float</span> <span class="nf">RandomRange21</span><span class="p">(</span><span class="kt">float2</span> <span class="n">seed</span><span class="p">,</span> <span class="n">float</span> <span class="nb">min</span><span class="p">,</span> <span class="n">float</span> <span class="nb">max</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nb">lerp</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="n">Random21</span><span class="p">(</span><span class="n">seed</span><span class="p">));</span> 
<span class="p">}</span>
<span class="kt">float2</span> <span class="nf">RandomRange22</span><span class="p">(</span><span class="kt">float2</span> <span class="n">seed</span><span class="p">,</span> <span class="kt">float2</span> <span class="nb">min</span><span class="p">,</span> <span class="kt">float2</span> <span class="nb">max</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">float2</span> <span class="n">vec</span><span class="p">;</span>
    <span class="n">vec</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">RandomRange21</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span>                    <span class="nb">min</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="nb">max</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
    <span class="n">vec</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">RandomRange21</span><span class="p">(</span><span class="n">seed</span> <span class="o">+</span> <span class="kt">float2</span><span class="p">(</span><span class="n">RP1</span><span class="p">,</span> <span class="n">RP2</span><span class="p">),</span> <span class="nb">min</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="nb">max</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">vec</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">float3</span> <span class="nf">RandomRange23</span><span class="p">(</span><span class="kt">float2</span> <span class="n">seed</span><span class="p">,</span> <span class="kt">float3</span> <span class="nb">min</span><span class="p">,</span> <span class="kt">float3</span> <span class="nb">max</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">float3</span> <span class="n">vec</span><span class="p">;</span>
    <span class="n">vec</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">RandomRange21</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span>                    <span class="nb">min</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="nb">max</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
    <span class="n">vec</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">RandomRange21</span><span class="p">(</span><span class="n">seed</span> <span class="o">+</span> <span class="kt">float2</span><span class="p">(</span><span class="n">RP1</span><span class="p">,</span> <span class="n">RP2</span><span class="p">),</span> <span class="nb">min</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="nb">max</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
    <span class="n">vec</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">RandomRange21</span><span class="p">(</span><span class="n">seed</span> <span class="o">+</span> <span class="kt">float2</span><span class="p">(</span><span class="n">RP2</span><span class="p">,</span> <span class="n">RP1</span><span class="p">),</span> <span class="nb">min</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="nb">max</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">vec</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

</details>
<!-- --------------------------------------------------------------------------- -->

<h1 id="8-방출-기능-구현">8. 방출 기능 구현</h1>
<hr />

<details>
  <summary> 
…
</summary>

  <p><br /></p>

  <p>진공 청소기로 흡수했던 먼지들을 한 번에 뿜어내어 발사하는 기능을 구현한다.</p>

  <p><code class="language-plaintext highlighter-rouge">suctionAngle</code> 각도를 발사 각도로 사용하고,</p>

  <p><code class="language-plaintext highlighter-rouge">suctionForce</code> 값을 발사 강도로 사용한다.</p>

  <p>그리고 각 먼지마다 <code class="language-plaintext highlighter-rouge">0 ~ 1</code> 범위의 난수를 생성하여, 발사 확률을 결정한다.</p>

  <p>발사 확률은 발사되는 먼지 개수를 간접적으로 결정하게 된다.</p>

  <p><br /></p>

  <h2 id="section-20"><strong>[1] 이론 : 발사 방향 설정</strong></h2>

  <h3 id="xy-2d"><strong>[1-1] 무작위 원형 범위 생성(XY 2D)</strong></h3>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135745360-f079511b-62ad-4d71-8890-05e228109b9b.png" alt="image" /></p>

  <p>xy 평면에서 원형 범위를 생성한다.</p>

  <p><code class="language-plaintext highlighter-rouge">θ</code>(각도) 값을 -360 ~ 360도 범위로,</p>

  <p><code class="language-plaintext highlighter-rouge">r</code>(반지름) 값을 0 ~ 1 범위로 난수를 생성한다.</p>

  <p>그러면 위에서 보이는 원 내부의 모든 영역이 xy평면의 발사 방향으로 설정되며,</p>

  <p>이는 발사 방향을 결정하는 원뿔의 밑면이 된다.</p>

  <p><br /></p>

  <h3 id="xy-z-2d"><strong>[1-2] 원뿔 영역 생성(XY-Z 2D)</strong></h3>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135745354-18e23c36-91f5-401e-a164-d3c808e6d1cf.png" alt="image" /></p>

  <p>원뿔의 높이인 <code class="language-plaintext highlighter-rouge">Z</code> 값을 상수 <code class="language-plaintext highlighter-rouge">1</code>로 고정한다.</p>

  <p>그리고 여기서 원뿔의 각도, 즉 발사 각도 <code class="language-plaintext highlighter-rouge">t</code>를 조정하면 3D 공간의 원뿔 영역을 형성할 수 있는데,</p>

  <p>원뿔의 밑면 반지름 <code class="language-plaintext highlighter-rouge">r</code>은 <code class="language-plaintext highlighter-rouge">tan(t)</code>와 같으므로</p>

  <p><code class="language-plaintext highlighter-rouge">tan(t)</code>를 계산하여 <code class="language-plaintext highlighter-rouge">[1-1]</code>의 <code class="language-plaintext highlighter-rouge">r</code> 값에 곱해주면</p>

  <p>최종적인 원뿔 영역을 완성할 수 있다.</p>

  <p>이 때 <code class="language-plaintext highlighter-rouge">t</code>는 청소기 객체의 <code class="language-plaintext highlighter-rouge">suctionAngle</code> 필드이다.</p>

  <p><br /></p>

  <h3 id="section-21"><strong>[1-3] 공간 변환</strong></h3>

  <p>원뿔의 꼭짓점이 원점<code class="language-plaintext highlighter-rouge">(0, 0, 0)</code>, 밑면의 중심 위치가 <code class="language-plaintext highlighter-rouge">(0, 1, 0)</code>인 원뿔 영역을 완성했다.</p>

  <p>그리고 이 영역 내의 모든 점은 각각이 발사 방향 벡터이므로,</p>

  <p>이제 진공 청소기 트랜스폼의 <code class="language-plaintext highlighter-rouge">Local to World</code> 행렬을 여기에 곱하여 공간 변환을 해주면 최종적인 발사 방향 설정이 완료된다.</p>

  <p>그리고 여기에 힘을 곱해주기만 하면 발사 벡터가 완성되며,</p>

  <p>이 때 힘 값은 청소기 객체의 <code class="language-plaintext highlighter-rouge">suctionForce</code>이다.</p>

  <p><br /></p>

  <h2 id="section-22"><strong>[2] 컴퓨트 쉐이더</strong></h2>

  <details>
    <summary> 
DustCompute.compute
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="rouge-code"><pre><span class="cp">#define TAU 6.28318530
</span>
<span class="n">uint</span> <span class="n">maxNumber</span><span class="p">;</span>      <span class="c1">// 먼지 개수</span>
<span class="n">float</span> <span class="n">time</span><span class="p">;</span>          <span class="c1">// Time.time</span>
<span class="n">float</span> <span class="n">blowForce</span><span class="p">;</span>     <span class="c1">// 발사 강도(suctionForce 필드값)</span>
<span class="n">float</span> <span class="n">blowAngleRad</span><span class="p">;</span>  <span class="c1">// 발사 각도(suctionAngle 필드값)</span>
<span class="kt">float4x4</span> <span class="n">headMatrix</span><span class="p">;</span> <span class="c1">// CleanerHead : localToWorld</span>

<span class="c1">// 2 - 죽었던 먼지들 살려서 발사</span>
<span class="p">[</span><span class="nb">numthreads</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
<span class="kt">void</span> <span class="nf">Blow</span> <span class="p">(</span><span class="n">uint3</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">maxNumber</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="c1">// 발사 확률 계산</span>
    <span class="n">float</span> <span class="n">seed</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">time</span><span class="p">)</span> <span class="o">/</span> <span class="mi">79238</span><span class="p">.</span><span class="mi">288</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">r</span> <span class="o">=</span> <span class="n">Random11</span><span class="p">(</span><span class="n">seed</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mo">01</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="c1">// Note : localDir의 z를 1로 고정하고, xy를 tan(blowAngleRad)로 지정함으로써</span>
    <span class="c1">// 발사되는 먼지들이 형성하는 원뿔의 각도를 suctionAngle로 설정하는 효과를 얻는다.</span>
    
    <span class="c1">// r2.x : 각 먼지의 각도 (-360 ~ 360), r2.y : 원의 반지름(원뿔의 각도 결정)</span>
    <span class="n">float</span> <span class="n">seed2</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="mi">82801</span><span class="p">.</span><span class="mi">277</span><span class="p">;</span>
    <span class="kt">float2</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">RandomRange12</span><span class="p">(</span><span class="n">seed2</span><span class="p">,</span> <span class="kt">float2</span><span class="p">(</span><span class="o">-</span><span class="n">TAU</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="kt">float2</span><span class="p">(</span><span class="n">TAU</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
    <span class="kt">float2</span> <span class="n">randomCircle</span> <span class="o">=</span> <span class="kt">float2</span><span class="p">(</span><span class="nb">cos</span><span class="p">(</span><span class="n">r2</span><span class="p">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">sin</span><span class="p">(</span><span class="n">r2</span><span class="p">.</span><span class="n">x</span><span class="p">))</span> <span class="o">*</span> <span class="n">r2</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="nb">tan</span><span class="p">(</span><span class="n">blowAngleRad</span><span class="p">);</span>

    <span class="c1">// 발사 방향 벡터 공간 변환</span>
    <span class="kt">float3</span> <span class="n">localDir</span> <span class="o">=</span> <span class="kt">float3</span><span class="p">(</span><span class="n">randomCircle</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">randomCircle</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="kt">float3</span> <span class="n">worldDir</span> <span class="o">=</span> <span class="nb">mul</span><span class="p">(</span><span class="n">headMatrix</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">localDir</span><span class="p">,</span> <span class="mi">0</span><span class="p">)).</span><span class="n">xyz</span><span class="p">;</span>
    
    <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="o">=</span> <span class="n">headPos</span><span class="p">;</span>           <span class="c1">// 청소기 입구로 위치 이동</span>
    <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">worldDir</span><span class="p">)</span> <span class="o">*</span> <span class="n">blowForce</span><span class="p">;</span> <span class="c1">// 발사 속도 벡터 설정(방향 * 크기)</span>

    <span class="c1">// 먼지 되살리기</span>
    <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="nb">InterlockedAdd</span><span class="p">(</span><span class="n">aliveNumberBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-23"><strong>[3] 먼지 관리 컴포넌트</strong></h2>

  <details>
    <summary> 
DustManager.cs
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre><span class="k">private</span> <span class="kt">int</span> <span class="n">kernelBlowID</span><span class="p">;</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="c1">// 마우스 중앙 버튼 누르면 먼지 발사</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="nf">GetMouseButton</span><span class="p">(</span><span class="m">2</span><span class="p">))</span>
        <span class="nf">BlowDusts</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Init</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="n">kernelBlowID</span> <span class="p">=</span> <span class="n">dustCompute</span><span class="p">.</span><span class="nf">FindKernel</span><span class="p">(</span><span class="s">"Blow"</span><span class="p">);</span>
    
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">SetBuffersToShaders</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernelBlowID</span><span class="p">,</span> <span class="s">"dustBuffer"</span><span class="p">,</span> <span class="n">dustBuffer</span><span class="p">);</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernelBlowID</span><span class="p">,</span> <span class="s">"aliveNumberBuffer"</span><span class="p">,</span> <span class="n">aliveNumberBuffer</span><span class="p">);</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernelBlowID</span><span class="p">,</span> <span class="s">"velocityBuffer"</span><span class="p">,</span> <span class="n">dustVelocityBuffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">BlowDusts</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"time"</span><span class="p">,</span> <span class="n">Time</span><span class="p">.</span><span class="n">time</span><span class="p">);</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"blowForce"</span><span class="p">,</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">SuctionForce</span><span class="p">);</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"blowAngleRad"</span><span class="p">,</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">SuctionAngleRad</span><span class="p">);</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetMatrix</span><span class="p">(</span><span class="s">"headMatrix"</span><span class="p">,</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">localToWorldMatrix</span><span class="p">);</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">Dispatch</span><span class="p">(</span><span class="n">kernelBlowID</span><span class="p">,</span> <span class="n">kernelGroupSizeX</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-24"><strong>[3] 실행 결과</strong></h2>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135729201-b27e7340-fa4b-4eac-91e0-fde0056904bc.gif" alt="2021_1003_Blow Dust1" /> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135729203-47f9f4b3-0d5f-44c8-90e2-68c2cd0a1ff8.gif" alt="2021_1003_Blow Dust2" /></p>

  <p><br /></p>

</details>
<!-- --------------------------------------------------------------------------- -->

<h1 id="9-바닥-평면-충돌-및-탄성-구현">9. 바닥 평면 충돌 및 탄성 구현</h1>
<hr />

<details>
  <summary> 
…
</summary>

  <p><br /></p>

  <p>먼지가 바닥에 부딪힐 경우, 현재는 바로 굴러간다.</p>

  <p>탄성 계수를 추가하고, 바닥에 떨어졌을 때 반사 벡터를 구하여 적당히 튕기도록 구현한다.</p>

  <p><br /></p>

  <h2 id="section-25"><strong>[1] 반사 벡터 계산 최적화</strong></h2>

  <p><code class="language-plaintext highlighter-rouge">reflect(inDir, normal)</code> 함수를 통한 연산은</p>

  <div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>inDir - 2 * dot(inDir, normal) * normal
</pre></td></tr></tbody></table></code></div>  </div>

  <p>내부적으로 위와 같은 연산을 통해 반사 벡터를 계산한다.</p>

  <p>그림으로 나타내면 다음과 같다.</p>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135757693-65045077-0511-415f-a927-8eb573f082b3.png" alt="image" /></p>

  <p><br /></p>

  <p>그런데 <code class="language-plaintext highlighter-rouge">y = 0</code>, <code class="language-plaintext highlighter-rouge">x = 1</code>, <code class="language-plaintext highlighter-rouge">z = 2</code>와 같이</p>

  <p>법선 벡터가 월드 축과 일치하는 평면의 반사 벡터 계산은</p>

  <p>아주 훨씬 저렴하게 이루어질 수 있다.</p>

  <p>예를 들어 월드의 바닥 평면인 <code class="language-plaintext highlighter-rouge">y = 0</code>의 경우,</p>

  <p>입사 벡터의 <code class="language-plaintext highlighter-rouge">y</code> 성분의 부호만 뒤집어주면 된다.</p>

  <p>예를 들어 입사 벡터가 <code class="language-plaintext highlighter-rouge">(a, b, c)</code>일 때 반사 벡터는 <code class="language-plaintext highlighter-rouge">(a, -b, c)</code> 이다.</p>

  <p><br /></p>

  <h2 id="section-26"><strong>[2] 다음 프레임 위치 계산하기</strong></h2>

  <p>평면의 충돌 감지는 사실 아주 간단하다.</p>

  <p>법선 벡터가 <code class="language-plaintext highlighter-rouge">(0, 1, 0)</code>인 평면을 예시로,</p>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135747040-13a54f84-642d-47cf-ba49-fc1ea74ea8f3.png" alt="image" /></p>

  <p>현재 프레임에는 아직 평면에 닿지 않았으나 다음 프레임에는 평면에 접촉, 혹은 평면을 지나가게 된다면 충돌 판정을 해주면 된다.</p>

  <p>그리고 이 때의 속도가 <code class="language-plaintext highlighter-rouge">(a, b, c)</code>라고 한다면, <code class="language-plaintext highlighter-rouge">(a, -b, c)</code>로 바꿔주면 된다.</p>

  <p><br /></p>

  <p>하지만 위와 같이 속도를 변경해주기만 한다면</p>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135747248-041f49b8-3246-40a6-b2ac-fe9d84045720.png" alt="image" /></p>

  <p>이렇게 된다.</p>

  <p>충돌 했다고 가정하고, 그대로 현재 위치에서 반사 벡터를 따라 튕겨져 나간다.</p>

  <p><br /></p>

  <p>따라서 정확한 충돌을 구현하기 위해서는 충돌 지점을 계산하고,</p>

  <p>해당 지점을 기점으로 벡터의 방향을 꺾으며 벡터의 여분 길이를 계산하여</p>

  <p>다음 프레임 위치를 결정하는 방식으로 계산을 해주어야 한다.</p>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135747443-728c80a7-8447-4378-baec-827935a471db.png" alt="image" /></p>

  <p><br /></p>

  <ul>
    <li>참고 : 직선 - 평면 접점 구하기 : <a href="../raycast-to-plane/">Link</a></li>
  </ul>

  <p><br /></p>

  <h2 id="section-27"><strong>[3] 탄성 계수 고려하기</strong></h2>

  <p>물체가 다른 물체에 부딪혀 튕겨 나갈 때 운동량을 일정량 상실한다.</p>

  <p>따라서 이를 결정하는 값을 임의로 <code class="language-plaintext highlighter-rouge">탄성 계수</code>라고 정의하며,</p>

  <p>값이 <code class="language-plaintext highlighter-rouge">1</code>이면 운동량 보존, 값이 <code class="language-plaintext highlighter-rouge">0</code>이면 모든 운동량을 상실한다고 가정한다.</p>

  <p>예를 들어 탄성 계수가 <code class="language-plaintext highlighter-rouge">0.6</code>이면 <code class="language-plaintext highlighter-rouge">40%</code>의 운동량을 상실하여</p>

  <p>충돌 이후 속도가 <code class="language-plaintext highlighter-rouge">40%</code> 감소한다.</p>

  <p><br /></p>

  <h2 id="section-28"><strong>[4] 구현 : 컴퓨트 쉐이더</strong></h2>

  <details>
    <summary> 
DustCompute.compute
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
</pre></td><td class="rouge-code"><pre><span class="n">float</span> <span class="n">elasticity</span><span class="p">;</span> <span class="c1">// 탄성 계수 : CPU에서 값 제공(범위 : 0 ~ 1)</span>

<span class="c1">// 점 A에서 점 B로 레이캐스트하여 평면과 접점 찾기</span>
<span class="kt">float3</span> <span class="nf">RaycastToPlane</span><span class="p">(</span><span class="kt">float3</span> <span class="n">A</span><span class="p">,</span> <span class="kt">float3</span> <span class="n">B</span><span class="p">,</span> <span class="kt">float3</span> <span class="n">P</span><span class="p">,</span> <span class="kt">float3</span> <span class="n">N</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//A = Ray Origin;</span>
    <span class="c1">//B = Ray End;</span>
    <span class="c1">//P = Plane Point;</span>
    <span class="c1">//N = Plane Normal;</span>
    <span class="kt">float3</span> <span class="n">AB</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span> <span class="o">-</span> <span class="n">A</span><span class="p">);</span>
    <span class="kt">float3</span> <span class="n">nAB</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">AB</span><span class="p">);</span>
    
    <span class="n">float</span> <span class="n">d</span> <span class="o">=</span> <span class="nb">dot</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">P</span> <span class="o">-</span> <span class="n">A</span><span class="p">)</span> <span class="o">/</span> <span class="nb">dot</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">nAB</span><span class="p">);</span>
    <span class="kt">float3</span> <span class="n">C</span> <span class="o">=</span> <span class="n">A</span> <span class="o">+</span> <span class="n">nAB</span> <span class="o">*</span> <span class="n">d</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">C</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">float3</span> <span class="nf">ReverseY</span><span class="p">(</span><span class="kt">float3</span> <span class="n">vec</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="kt">float3</span><span class="p">(</span><span class="n">vec</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">vec</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">vec</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 1 - 실시간 업데이트</span>
<span class="p">[</span><span class="nb">numthreads</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
<span class="kt">void</span> <span class="nf">Update</span> <span class="p">(</span><span class="n">uint3</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="c1">// ...</span>
    <span class="kt">float3</span> <span class="n">currPos</span> <span class="o">=</span> <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">;</span>  <span class="c1">// 현재 프레임 먼지 위치</span>
    <span class="c1">// ...</span>
    
    <span class="c1">// ===================================================</span>
    <span class="c1">//              이동 시뮬레이션, 충돌 검사</span>
    <span class="c1">// ===================================================</span>
    <span class="c1">// 다음 프레임 위치 계산 : S = S0 + V * t</span>
    <span class="kt">float3</span> <span class="n">nextPos</span> <span class="o">=</span> <span class="n">currPos</span> <span class="o">+</span> <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">deltaTime</span><span class="p">;</span>

    <span class="c1">// [1] Plane 충돌 (Y = 0)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">nextPos</span><span class="p">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">radius</span><span class="p">)</span> <span class="c1">// 먼지 반지름 고려</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">currPos</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">radius</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">float3</span> <span class="n">currToNext</span> <span class="o">=</span> <span class="n">nextPos</span> <span class="o">-</span> <span class="n">currPos</span><span class="p">;</span>

            <span class="c1">// 평면과의 충돌 지점</span>
            <span class="kt">float3</span> <span class="n">contact</span> <span class="o">=</span> <span class="n">RaycastToPlane</span><span class="p">(</span><span class="n">currPos</span><span class="p">,</span> <span class="n">nextPos</span><span class="p">,</span> <span class="kt">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="kt">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
            <span class="n">float</span> <span class="n">rayLen</span> <span class="o">=</span> <span class="nb">length</span><span class="p">(</span><span class="n">currToNext</span><span class="p">);</span>
            <span class="n">float</span> <span class="n">inLen</span> <span class="o">=</span> <span class="nb">length</span><span class="p">(</span><span class="n">currPos</span> <span class="o">-</span> <span class="n">contact</span><span class="p">);</span>       <span class="c1">// 입사 벡터 길이</span>
            <span class="n">float</span> <span class="n">outLen</span> <span class="o">=</span> <span class="p">(</span><span class="n">rayLen</span> <span class="o">-</span> <span class="n">inLen</span><span class="p">)</span> <span class="o">*</span> <span class="n">elasticity</span><span class="p">;</span>  <span class="c1">// 반사 벡터 길이(운동량 감소)</span>
            <span class="kt">float3</span> <span class="n">outVec</span> <span class="o">=</span> <span class="n">ReverseY</span><span class="p">(</span><span class="n">currToNext</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">outLen</span> <span class="o">/</span> <span class="n">rayLen</span><span class="p">);</span>

            <span class="n">nextPos</span> <span class="o">=</span> <span class="n">contact</span> <span class="o">+</span> <span class="n">outVec</span><span class="p">;</span>
            <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ReverseY</span><span class="p">(</span><span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">elasticity</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">nextPos</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">nextPos</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// [2] 입구로 완전히 빨아들인 경우, 먼지 파괴</span>
    <span class="c1">// ...</span>
    
    <span class="c1">// 다음 위치 적용</span>
    <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="o">=</span> <span class="n">nextPos</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-29"><strong>[5] 실행 결과</strong></h2>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135767238-85ea3b2e-868c-4893-90f4-18be7021ab39.gif" alt="2021_1004_PlaneElastic1" /></p>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135767242-74f96e8c-1a4f-41f3-9f68-78325d068729.gif" alt="2021_1004_PlaneElastic2" /></p>

  <p><br /></p>

</details>
<!-- --------------------------------------------------------------------------- -->

<h1 id="10-월드-영역-제한큐브">10. 월드 영역 제한(큐브)</h1>
<hr />

<details>
  <summary> 
…
</summary>

  <p><br /></p>

  <p>지금까지는 바닥만 제한 영역을 설정했으나,</p>

  <p>월드 전체를 여섯 면이 이루는 큐브 형태로 영역을 제한한다.</p>

  <p>따라서 월드의 제한 영역을 이루는 각 면에 부딪힐 경우 튕겨 나가도록 구현한다.</p>

  <p><br /></p>

  <h2 id="section-30"><strong>[1] 컴퓨트 쉐이더</strong></h2>

  <details>
    <summary> 
Type Definitions
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="c1">// 육면체 영역</span>
<span class="k">struct</span> <span class="n">Bounds</span>
<span class="p">{</span>
    <span class="kt">float3</span> <span class="nb">min</span><span class="p">;</span>
    <span class="kt">float3</span> <span class="nb">max</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// 평면</span>
<span class="k">struct</span> <span class="n">Plane</span>
<span class="p">{</span>
    <span class="kt">float3</span> <span class="n">position</span><span class="p">;</span> <span class="c1">// 평면 위의 한 점</span>
    <span class="kt">float3</span> <span class="n">normal</span><span class="p">;</span>   <span class="c1">// 평면의 법선</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <details>
    <summary> 
Physics Functions
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
</pre></td><td class="rouge-code"><pre><span class="c1">// 점 A에서 점 B로 레이캐스트하여 평면과 접점 찾기</span>
<span class="kt">float3</span> <span class="nf">RaycastToPlane</span><span class="p">(</span><span class="kt">float3</span> <span class="n">A</span><span class="p">,</span> <span class="kt">float3</span> <span class="n">B</span><span class="p">,</span> <span class="n">Plane</span> <span class="n">plane</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//A = Ray Origin;</span>
    <span class="c1">//B = Ray End;</span>
    <span class="c1">//P = Plane Point;</span>
    <span class="c1">//N = Plane Normal;</span>
    <span class="kt">float3</span> <span class="n">AB</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span> <span class="o">-</span> <span class="n">A</span><span class="p">);</span>
    <span class="kt">float3</span> <span class="n">nAB</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">AB</span><span class="p">);</span>
    
    <span class="n">float</span> <span class="n">d</span> <span class="o">=</span> <span class="nb">dot</span><span class="p">(</span><span class="n">plane</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span> <span class="n">plane</span><span class="p">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">A</span><span class="p">)</span> <span class="o">/</span> <span class="nb">dot</span><span class="p">(</span><span class="n">plane</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span> <span class="n">nAB</span><span class="p">);</span>
    <span class="kt">float3</span> <span class="n">C</span> <span class="o">=</span> <span class="n">A</span> <span class="o">+</span> <span class="n">nAB</span> <span class="o">*</span> <span class="n">d</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">C</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define IN_BOUNDS 0
#define OUT_OF_PX 1 // +x
#define OUT_OF_MX 2 // -x
#define OUT_OF_PY 3 // +y
#define OUT_OF_MY 4 // -y
#define OUT_OF_PZ 5 // +z
#define OUT_OF_MZ 6 // -z
</span>
<span class="c1">// 육면체 범위 내로 위치 제한 및 충돌 검사</span>
<span class="c1">// - cur : 현재 프레임에서의 위치</span>
<span class="c1">// - next : 다음 프레임에서의 위치</span>
<span class="c1">// - velocity : 현재 이동 속도</span>
<span class="c1">// - threshold : 입자의 크기</span>
<span class="c1">// - elasticity : 탄성력 계수(0 ~ 1)</span>
<span class="c1">// - bounds : 큐브 영역</span>
<span class="kt">void</span> <span class="nf">ConfineWithinCubeBounds</span><span class="p">(</span><span class="kt">float3</span> <span class="n">cur</span><span class="p">,</span> <span class="k">inout</span> <span class="kt">float3</span> <span class="n">next</span><span class="p">,</span> <span class="k">inout</span> <span class="kt">float3</span> <span class="n">velocity</span><span class="p">,</span> <span class="n">float</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">float</span> <span class="n">elasticity</span><span class="p">,</span> <span class="n">Bounds</span> <span class="n">bounds</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// 1. 큐브 영역 밖에 있는지, 안에 있는지 검사</span>
    <span class="n">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">IN_BOUNDS</span><span class="p">;</span>
         <span class="k">if</span><span class="p">(</span><span class="n">next</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">bounds</span><span class="p">.</span><span class="nb">max</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">threshold</span><span class="p">)</span> <span class="n">status</span> <span class="o">=</span> <span class="n">OUT_OF_PX</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">next</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">bounds</span><span class="p">.</span><span class="nb">min</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">threshold</span><span class="p">)</span> <span class="n">status</span> <span class="o">=</span> <span class="n">OUT_OF_MX</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">next</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">bounds</span><span class="p">.</span><span class="nb">max</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">threshold</span><span class="p">)</span> <span class="n">status</span> <span class="o">=</span> <span class="n">OUT_OF_PY</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">next</span><span class="p">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">bounds</span><span class="p">.</span><span class="nb">min</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">threshold</span><span class="p">)</span> <span class="n">status</span> <span class="o">=</span> <span class="n">OUT_OF_MY</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">next</span><span class="p">.</span><span class="n">z</span> <span class="o">&gt;</span> <span class="n">bounds</span><span class="p">.</span><span class="nb">max</span><span class="p">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">threshold</span><span class="p">)</span> <span class="n">status</span> <span class="o">=</span> <span class="n">OUT_OF_PZ</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">next</span><span class="p">.</span><span class="n">z</span> <span class="o">&lt;</span> <span class="n">bounds</span><span class="p">.</span><span class="nb">min</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">threshold</span><span class="p">)</span> <span class="n">status</span> <span class="o">=</span> <span class="n">OUT_OF_MZ</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">return</span><span class="p">;</span> <span class="c1">// 영역 내부에 있는 경우, 종료</span>

    <span class="n">Plane</span> <span class="n">plane</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">limit</span><span class="p">;</span>
    <span class="kt">float3</span> <span class="n">reversedCurToNext</span><span class="p">;</span>
    <span class="kt">float3</span> <span class="n">reversedVelocity</span><span class="p">;</span>

    <span class="k">switch</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">case</span> <span class="n">OUT_OF_PX</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">.</span><span class="nb">max</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">threshold</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">)</span> <span class="c1">// 외부에서 외부로 이동하는 경우, 단순히 위치만 변경하기</span>
            <span class="p">{</span>
                <span class="n">next</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">next</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">// 내부에서 외부로 이동하는 경우, 반사 벡터 계산을 위한 변수들 초기화</span>
            <span class="n">plane</span><span class="p">.</span><span class="n">normal</span>   <span class="o">=</span> <span class="kt">float3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">plane</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="kt">float3</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">reversedCurToNext</span> <span class="o">=</span> <span class="n">ReverseX</span><span class="p">(</span><span class="n">next</span> <span class="o">-</span> <span class="n">cur</span><span class="p">);</span>
            <span class="n">reversedVelocity</span>  <span class="o">=</span> <span class="n">ReverseX</span><span class="p">(</span><span class="n">velocity</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">OUT_OF_MX</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">.</span><span class="nb">min</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">threshold</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">next</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">next</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">plane</span><span class="p">.</span><span class="n">normal</span>   <span class="o">=</span> <span class="kt">float3</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">plane</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="kt">float3</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">reversedCurToNext</span> <span class="o">=</span> <span class="n">ReverseX</span><span class="p">(</span><span class="n">next</span> <span class="o">-</span> <span class="n">cur</span><span class="p">);</span>
            <span class="n">reversedVelocity</span>  <span class="o">=</span> <span class="n">ReverseX</span><span class="p">(</span><span class="n">velocity</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">OUT_OF_PY</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">.</span><span class="nb">max</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">threshold</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">next</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">next</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">plane</span><span class="p">.</span><span class="n">normal</span>   <span class="o">=</span> <span class="kt">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">plane</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="kt">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">reversedCurToNext</span> <span class="o">=</span> <span class="n">ReverseY</span><span class="p">(</span><span class="n">next</span> <span class="o">-</span> <span class="n">cur</span><span class="p">);</span>
            <span class="n">reversedVelocity</span>  <span class="o">=</span> <span class="n">ReverseY</span><span class="p">(</span><span class="n">velocity</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">OUT_OF_MY</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">.</span><span class="nb">min</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">threshold</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">next</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">next</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">plane</span><span class="p">.</span><span class="n">normal</span>   <span class="o">=</span> <span class="kt">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">plane</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="kt">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">reversedCurToNext</span> <span class="o">=</span> <span class="n">ReverseY</span><span class="p">(</span><span class="n">next</span> <span class="o">-</span> <span class="n">cur</span><span class="p">);</span>
            <span class="n">reversedVelocity</span>  <span class="o">=</span> <span class="n">ReverseY</span><span class="p">(</span><span class="n">velocity</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">OUT_OF_PZ</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">.</span><span class="nb">max</span><span class="p">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">threshold</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="n">z</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">next</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">next</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">plane</span><span class="p">.</span><span class="n">normal</span>   <span class="o">=</span> <span class="kt">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="n">plane</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="kt">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="p">);</span>
            <span class="n">reversedCurToNext</span> <span class="o">=</span> <span class="n">ReverseZ</span><span class="p">(</span><span class="n">next</span> <span class="o">-</span> <span class="n">cur</span><span class="p">);</span>
            <span class="n">reversedVelocity</span>  <span class="o">=</span> <span class="n">ReverseZ</span><span class="p">(</span><span class="n">velocity</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">OUT_OF_MZ</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">.</span><span class="nb">min</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">threshold</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="n">z</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">next</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">next</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">plane</span><span class="p">.</span><span class="n">normal</span>   <span class="o">=</span> <span class="kt">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
            <span class="n">plane</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="kt">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="p">);</span>
            <span class="n">reversedCurToNext</span> <span class="o">=</span> <span class="n">ReverseZ</span><span class="p">(</span><span class="n">next</span> <span class="o">-</span> <span class="n">cur</span><span class="p">);</span>
            <span class="n">reversedVelocity</span>  <span class="o">=</span> <span class="n">ReverseZ</span><span class="p">(</span><span class="n">velocity</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1">// 직선과 평면의 충돌 계산</span>
    <span class="kt">float3</span> <span class="n">currToNext</span> <span class="o">=</span> <span class="n">next</span> <span class="o">-</span> <span class="n">cur</span><span class="p">;</span>
    <span class="kt">float3</span> <span class="n">contact</span> <span class="o">=</span> <span class="n">RaycastToPlane</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">plane</span><span class="p">);</span> <span class="c1">// 이동 벡터와 평면의 접점</span>
    <span class="n">float</span> <span class="n">rayLen</span>   <span class="o">=</span> <span class="nb">length</span><span class="p">(</span><span class="n">currToNext</span><span class="p">);</span>               <span class="c1">// 이동 벡터의 길이</span>
    <span class="n">float</span> <span class="n">inLen</span>    <span class="o">=</span> <span class="nb">length</span><span class="p">(</span><span class="n">cur</span> <span class="o">-</span> <span class="n">contact</span><span class="p">);</span>            <span class="c1">// 입사 벡터 길이</span>
    <span class="n">float</span> <span class="n">outLen</span>   <span class="o">=</span> <span class="p">(</span><span class="n">rayLen</span> <span class="o">-</span> <span class="n">inLen</span><span class="p">)</span> <span class="o">*</span> <span class="n">elasticity</span><span class="p">;</span>    <span class="c1">// 반사 벡터 길이(운동량 감소)</span>
    <span class="kt">float3</span> <span class="n">outVec</span>  <span class="o">=</span> <span class="n">reversedCurToNext</span> <span class="o">*</span> <span class="p">(</span><span class="n">outLen</span> <span class="o">/</span> <span class="n">rayLen</span><span class="p">);</span>

    <span class="c1">// Outputs</span>
    <span class="n">next</span> <span class="o">=</span> <span class="n">contact</span> <span class="o">+</span> <span class="n">outVec</span><span class="p">;</span>                  <span class="c1">// 다음 프레임 위치 변경</span>
    <span class="n">velocity</span> <span class="o">=</span> <span class="n">reversedVelocity</span> <span class="o">*</span> <span class="n">elasticity</span><span class="p">;</span> <span class="c1">// 속도 변경</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <details>
    <summary> 
DustCompute.compute
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="nb">numthreads</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
<span class="kt">void</span> <span class="nf">Update</span> <span class="p">(</span><span class="n">uint3</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="c1">// ===================================================</span>
    <span class="c1">//              이동 시뮬레이션, 충돌 검사</span>
    <span class="c1">// ===================================================</span>
    <span class="c1">// 다음 프레임 위치 계산 : S = S0 + V * t</span>
    <span class="kt">float3</span> <span class="n">nextPos</span> <span class="o">=</span> <span class="n">currPos</span> <span class="o">+</span> <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">deltaTime</span><span class="p">;</span>

    <span class="c1">// [1] Cube 영역 제한</span>
    <span class="n">Bounds</span> <span class="n">bounds</span><span class="p">;</span>
    <span class="n">bounds</span><span class="p">.</span><span class="nb">min</span> <span class="o">=</span> <span class="n">boundsMin</span><span class="p">;</span>
    <span class="n">bounds</span><span class="p">.</span><span class="nb">max</span> <span class="o">=</span> <span class="n">boundsMax</span><span class="p">;</span>
    <span class="n">ConfineWithinCubeBounds</span><span class="p">(</span><span class="n">currPos</span><span class="p">,</span> <span class="n">nextPos</span><span class="p">,</span> <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">radius</span><span class="p">,</span> <span class="n">elasticity</span><span class="p">,</span> <span class="n">bounds</span><span class="p">);</span>
    
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-31"><strong>[2] 실행 결과</strong></h2>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135858930-89c13581-1f58-40f4-bb0c-cf8b74f8b634.gif" alt="2021_1004_CubeLimit1" /></p>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135858942-1c171386-24c0-48ee-b3f5-9872ed8004d8.gif" alt="2021_1004_CubeLimit3" /></p>

  <p><br /></p>

</details>
<!-- --------------------------------------------------------------------------- -->

<h1 id="구조-개편">구조 개편</h1>
<hr />

<details>
  <summary> 
…
</summary>

  <p><br /></p>

  <p>원래는 진공 청소기 기능만 구현하려 했으나, 다양한 기능들을 구현하게 되었으므로</p>

  <p>진공 청소기/방출기/컨트롤러를 분리한다.</p>

  <p><br /></p>

  <h2 id="section-32"><strong>[1] 컴퓨트 쉐이더</strong></h2>

  <ul>
    <li>구조체 정의, 함수 구현을 별도의 <code class="language-plaintext highlighter-rouge">.cginc</code> 파일로 분리하고 <code class="language-plaintext highlighter-rouge">#include</code>로 가져온다.</li>
    <li>진공 청소기 흡수 기능을 <code class="language-plaintext highlighter-rouge">Update</code>에서 분리하여 새로운 커널에 구현한다.</li>
    <li><code class="language-plaintext highlighter-rouge">Update</code> 커널은 물리 업데이트만 담당한다.</li>
    <li><code class="language-plaintext highlighter-rouge">Blow</code>는 <code class="language-plaintext highlighter-rouge">Emit</code>으로 이름을 변경한다.</li>
    <li>변수들도 알맞게 네이밍을 변경한다.</li>
  </ul>

  <p><br /></p>

  <details>
    <summary> 
DustCompute.compute
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre></td><td class="rouge-code"><pre><span class="cp">#pragma kernel Populate
#pragma kernel Update
#pragma kernel VacuumUp
#pragma kernel Emit
</span>
<span class="cp">#include "Type Definitions.cginc"
#include "Math Functions.cginc"
#include "Random Functions.cginc"
#include "Physics Functions.cginc"
</span>
<span class="cm">/*******************************************************************
 *                        Naming Conventions
/*******************************************************************
 - AToB  : B - A
 - ~Dir  : 방향 벡터(크기 1)
 - ~Dist : 두 위치 벡터 사이의 거리(스칼라)
 - ~Len  : 한 벡터의 길이
/*******************************************************************/</span>

<span class="cm">/*******************************************************************
/*                            Definitions
/*******************************************************************/</span>
<span class="cp">#define TRUE 1
#define FALSE 0
#define TAU 6.28318530
</span>
<span class="cm">/*******************************************************************
/*                            Variables
/*******************************************************************/</span>
<span class="kt">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">Dust</span><span class="o">&gt;</span> <span class="n">dustBuffer</span><span class="p">;</span>        <span class="c1">// 먼지 위치, 생존 여부</span>
<span class="kt">RWStructuredBuffer</span><span class="o">&lt;</span><span class="kt">float3</span><span class="o">&gt;</span> <span class="n">velocityBuffer</span><span class="p">;</span>  <span class="c1">// 먼지 속도</span>
<span class="kt">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">uint</span><span class="o">&gt;</span> <span class="n">aliveNumberBuffer</span><span class="p">;</span> <span class="c1">// 생존한 먼지 개수</span>

<span class="cm">/* Common */</span>
<span class="kt">float3</span> <span class="n">spawnBoundsMin</span><span class="p">;</span> <span class="c1">// 먼지 생성 영역 - 최소 지점</span>
<span class="kt">float3</span> <span class="n">spawnBoundsMax</span><span class="p">;</span> <span class="c1">// 먼지 생성 영역 - 최대 지점</span>
<span class="kt">float3</span> <span class="n">worldBoundsMin</span><span class="p">;</span> <span class="c1">// 월드 제한 영역 - 최소 지점</span>
<span class="kt">float3</span> <span class="n">worldBoundsMax</span><span class="p">;</span> <span class="c1">// 월드 제한 영역 - 최대 지점</span>
<span class="n">float</span> <span class="n">deltaTime</span><span class="p">;</span>

<span class="cm">/* Controller */</span>
<span class="kt">float3</span> <span class="n">controllerPos</span><span class="p">;</span>     <span class="c1">// 월드 위치</span>
<span class="kt">float3</span> <span class="n">controllerForward</span><span class="p">;</span> <span class="c1">// 전방 벡터</span>

<span class="cm">/* Vacuum Cleaner */</span>
<span class="n">float</span> <span class="n">cleanerSqrDist</span><span class="p">;</span>       <span class="c1">// 먼지 흡입 범위(반지름) - 제곱</span>
<span class="n">float</span> <span class="n">cleanerSqrDeathRange</span><span class="p">;</span> <span class="c1">// 먼지 소멸 범위(반지름) - 제곱</span>
<span class="n">float</span> <span class="n">cleanerSqrForce</span><span class="p">;</span>      <span class="c1">// 빨아들이는 힘 - 제곱</span>
<span class="n">float</span> <span class="n">cleanerDotThreshold</span><span class="p">;</span>  <span class="c1">// 진공 청소기 원뿔 영역 내적 범위</span>

<span class="cm">/* Emitter */</span>
<span class="n">uint</span> <span class="n">dustCount</span><span class="p">;</span>        <span class="c1">// 먼지 개수</span>
<span class="n">float</span> <span class="n">time</span><span class="p">;</span>            <span class="c1">// Time.time</span>
<span class="n">float</span> <span class="n">emitterForce</span><span class="p">;</span>    <span class="c1">// 방출 강도</span>
<span class="n">float</span> <span class="n">emitterDist</span><span class="p">;</span>     <span class="c1">// 방출 거리</span>
<span class="n">float</span> <span class="n">emitterAngleRad</span><span class="p">;</span> <span class="c1">// 방출 각도</span>
<span class="kt">float4x4</span> <span class="n">controllerMatrix</span><span class="p">;</span> <span class="c1">//  localToWorld</span>

<span class="cm">/* Physics(Update) */</span>
<span class="kt">float3</span> <span class="n">gravity</span><span class="p">;</span>      <span class="c1">// 중력 가속도</span>
<span class="n">float</span> <span class="n">radius</span><span class="p">;</span>        <span class="c1">// 먼지 반지름</span>
<span class="n">float</span> <span class="n">mass</span><span class="p">;</span>          <span class="c1">// 질량</span>
<span class="n">float</span> <span class="n">airResistance</span><span class="p">;</span> <span class="c1">// 공기 저항력</span>
<span class="n">float</span> <span class="n">elasticity</span><span class="p">;</span>    <span class="c1">// 탄성력</span>

<span class="cm">/*******************************************************************
/*                            Functions
/*******************************************************************/</span>
<span class="c1">// 먼지 파괴</span>
<span class="kt">void</span> <span class="nf">DestroyDust</span><span class="p">(</span><span class="n">uint</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="nb">InterlockedAdd</span><span class="p">(</span><span class="n">aliveNumberBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <details>
    <summary> 
Kernel : Update
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="nb">numthreads</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
<span class="kt">void</span> <span class="nf">Update</span> <span class="p">(</span><span class="n">uint3</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">dustCount</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="kt">float3</span> <span class="n">A</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 가속도 합 벡터</span>
    
    <span class="c1">// F = m * a</span>
    <span class="c1">// v = a * t</span>

    <span class="c1">// ===================================================</span>
    <span class="c1">//                    속도 계산</span>
    <span class="c1">// ===================================================</span>
    <span class="c1">//A += F / mass;</span>

    <span class="c1">// [1] 중력</span>
    <span class="n">A</span> <span class="o">+=</span> <span class="n">gravity</span><span class="p">;</span>

    <span class="c1">// [2] 공기 저항</span>
    <span class="n">A</span> <span class="o">-=</span> <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">airResistance</span><span class="p">;</span>

    <span class="c1">// 속도 적용 : V = A * t</span>
    <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">A</span> <span class="o">*</span> <span class="n">deltaTime</span><span class="p">;</span>
    
    <span class="c1">// ===================================================</span>
    <span class="c1">//              이동 시뮬레이션, 충돌 검사</span>
    <span class="c1">// ===================================================</span>
    <span class="c1">// 다음 프레임 위치 계산 : S = S0 + V * t</span>
    <span class="kt">float3</span> <span class="n">currPos</span> <span class="o">=</span> <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">;</span>
    <span class="kt">float3</span> <span class="n">nextPos</span> <span class="o">=</span> <span class="n">currPos</span> <span class="o">+</span> <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">deltaTime</span><span class="p">;</span>

    <span class="c1">// [1] 월드 영역 제한(Cube)</span>
    <span class="n">Bounds</span> <span class="n">bounds</span><span class="p">;</span>
    <span class="n">bounds</span><span class="p">.</span><span class="nb">min</span> <span class="o">=</span> <span class="n">worldBoundsMin</span><span class="p">;</span>
    <span class="n">bounds</span><span class="p">.</span><span class="nb">max</span> <span class="o">=</span> <span class="n">worldBoundsMax</span><span class="p">;</span>
    <span class="n">ConfineWithinCubeBounds</span><span class="p">(</span><span class="n">currPos</span><span class="p">,</span> <span class="n">nextPos</span><span class="p">,</span> <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">radius</span><span class="p">,</span> <span class="n">elasticity</span><span class="p">,</span> <span class="n">bounds</span><span class="p">);</span>

    <span class="c1">// 다음 위치 적용</span>
    <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="o">=</span> <span class="n">nextPos</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <details>
    <summary> 
Kernel : VacuumUp
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="nb">numthreads</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
<span class="kt">void</span> <span class="nf">VacuumUp</span> <span class="p">(</span><span class="n">uint3</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">dustCount</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="kt">float3</span> <span class="n">F</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 힘 합 벡터</span>
    <span class="n">bool</span> <span class="n">flag</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

    <span class="kt">float3</span> <span class="n">currPos</span> <span class="o">=</span> <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">;</span>  <span class="c1">// 현재 프레임 먼지 위치</span>
    <span class="kt">float3</span> <span class="n">currToHead</span> <span class="o">=</span> <span class="p">(</span><span class="n">controllerPos</span> <span class="o">-</span> <span class="n">currPos</span><span class="p">);</span>  <span class="c1">// 청소기 입구 -&gt; 먼지</span>
    <span class="n">float</span> <span class="n">sqrDist</span> <span class="o">=</span> <span class="n">SqrMagnitude</span><span class="p">(</span><span class="n">currToHead</span><span class="p">);</span> <span class="c1">// 청소기 입구 &lt;-&gt; 먼지 사이 거리 제곱</span>

    <span class="c1">// 원뿔 범위 및 힘 계산</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sqrDist</span> <span class="o">&lt;</span> <span class="n">cleanerSqrDist</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">float3</span> <span class="n">dustToHeadDir</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">currToHead</span><span class="p">);</span> <span class="c1">// 먼지 -&gt; 청소기 입구 방향</span>
        <span class="n">float</span> <span class="n">dotValue</span> <span class="o">=</span> <span class="nb">dot</span><span class="p">(</span><span class="n">controllerForward</span><span class="p">,</span> <span class="o">-</span><span class="n">dustToHeadDir</span><span class="p">);</span>

        <span class="c1">// 원뿔 범위 내에 있을 경우 빨아들이기</span>
        <span class="k">if</span><span class="p">(</span><span class="n">dotValue</span> <span class="o">&gt;</span> <span class="n">cleanerDotThreshold</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">float</span> <span class="n">force</span> <span class="o">=</span> <span class="n">cleanerSqrForce</span> <span class="o">/</span> <span class="n">sqrDist</span><span class="p">;</span>

            <span class="c1">// 빨아들이는 힘</span>
            <span class="n">F</span> <span class="o">+=</span> <span class="n">dustToHeadDir</span> <span class="o">*</span> <span class="n">force</span> <span class="o">*</span> <span class="n">dotValue</span><span class="p">;</span>

            <span class="n">flag</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 속도 계산</span>
    <span class="k">if</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 가속도</span>
        <span class="kt">float3</span> <span class="n">A</span> <span class="o">=</span> <span class="n">F</span> <span class="o">/</span> <span class="n">mass</span><span class="p">;</span>

        <span class="c1">// 속도</span>
        <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">A</span> <span class="o">*</span> <span class="n">deltaTime</span><span class="p">;</span>

        <span class="c1">// 다음 프레임 위치 예측 : S = S0 + V * t</span>
        <span class="kt">float3</span> <span class="n">nextPos</span> <span class="o">=</span> <span class="n">currPos</span> <span class="o">+</span> <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">deltaTime</span><span class="p">;</span>

        <span class="kt">float3</span> <span class="n">headToNext</span> <span class="o">=</span> <span class="n">nextPos</span> <span class="o">-</span> <span class="n">controllerPos</span><span class="p">;</span>
        <span class="kt">float3</span> <span class="n">headToCurrDir</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="o">-</span><span class="n">currToHead</span><span class="p">);</span>
        <span class="kt">float3</span> <span class="n">headToNextDir</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">headToNext</span><span class="p">);</span>

        <span class="c1">// 현재 프레임에 먼지가 원뿔 범위 내에 있었다면</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">controllerForward</span><span class="p">,</span> <span class="n">headToCurrDir</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">cleanerDotThreshold</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 다음 프레임에 원뿔 밖으로 나가거나 입구에 근접하면 파괴</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">controllerForward</span><span class="p">,</span> <span class="n">headToNextDir</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">cleanerDotThreshold</span> <span class="o">||</span>
                <span class="n">SqrMagnitude</span><span class="p">(</span><span class="n">headToNext</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">cleanerSqrDeathRange</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">DestroyDust</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <details>
    <summary> 
Kernel : Emit
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="nb">numthreads</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
<span class="kt">void</span> <span class="nf">Emit</span> <span class="p">(</span><span class="n">uint3</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">dustCount</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="c1">// 발사 확률 계산</span>
    <span class="n">float</span> <span class="n">seed</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">time</span><span class="p">)</span> <span class="o">/</span> <span class="mi">79238</span><span class="p">.</span><span class="mi">288</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">r</span> <span class="o">=</span> <span class="n">Random11</span><span class="p">(</span><span class="n">seed</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mo">01</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="c1">// Note : localDir의 z를 1로 고정하고, xy를 tan(emitterAngleRad)로 지정함으로써</span>
    <span class="c1">// 발사되는 먼지들이 형성하는 원뿔의 각도를 suctionAngle로 설정하는 효과를 얻는다.</span>
    
    <span class="c1">// r2.x : 각 먼지의 각도 (-360 ~ 360), r2.y : 원의 반지름(원뿔의 각도 결정)</span>
    <span class="n">float</span> <span class="n">seed2</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="mi">82801</span><span class="p">.</span><span class="mi">277</span><span class="p">;</span>
    <span class="kt">float2</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">RandomRange12</span><span class="p">(</span><span class="n">seed2</span><span class="p">,</span> <span class="kt">float2</span><span class="p">(</span><span class="o">-</span><span class="n">TAU</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="kt">float2</span><span class="p">(</span><span class="n">TAU</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
    <span class="kt">float2</span> <span class="n">randomCircle</span> <span class="o">=</span> <span class="kt">float2</span><span class="p">(</span><span class="nb">cos</span><span class="p">(</span><span class="n">r2</span><span class="p">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">sin</span><span class="p">(</span><span class="n">r2</span><span class="p">.</span><span class="n">x</span><span class="p">))</span> <span class="o">*</span> <span class="n">r2</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="nb">tan</span><span class="p">(</span><span class="n">emitterAngleRad</span><span class="p">);</span>
    
    <span class="c1">// 발사 방향 벡터 공간 변환</span>
    <span class="kt">float3</span> <span class="n">localDir</span> <span class="o">=</span> <span class="kt">float3</span><span class="p">(</span><span class="n">randomCircle</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">randomCircle</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="kt">float3</span> <span class="n">worldDir</span> <span class="o">=</span> <span class="nb">mul</span><span class="p">(</span><span class="n">controllerMatrix</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">localDir</span><span class="p">,</span> <span class="mi">0</span><span class="p">)).</span><span class="n">xyz</span><span class="p">;</span>
    
    <span class="kt">float3</span> <span class="n">F</span> <span class="o">=</span> <span class="n">worldDir</span> <span class="o">*</span> <span class="n">emitterForce</span> <span class="o">*</span> <span class="n">emitterDist</span><span class="p">;</span>
    <span class="kt">float3</span> <span class="n">A</span> <span class="o">=</span> <span class="n">F</span> <span class="o">/</span> <span class="n">mass</span><span class="p">;</span>
    <span class="kt">float3</span> <span class="n">V</span> <span class="o">=</span> <span class="n">A</span> <span class="o">*</span> <span class="n">deltaTime</span><span class="p">;</span>

    <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="o">=</span> <span class="n">controllerPos</span><span class="p">;</span>        <span class="c1">// 청소기 입구로 위치 이동</span>
    <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">V</span><span class="p">;</span>

    <span class="c1">// 먼지 되살리기</span>
    <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="nb">InterlockedAdd</span><span class="p">(</span><span class="n">aliveNumberBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="c-"><strong>[2] C# 스크립트</strong></h2>
  <ul>
    <li>이름 변경 : <code class="language-plaintext highlighter-rouge">VacuumCleanerHead</code> -&gt; <code class="language-plaintext highlighter-rouge">VacuumCleaner</code></li>
    <li>이동 및 회전 기능 분리하여 새로운 클래스 작성 : <code class="language-plaintext highlighter-rouge">PlayerController</code></li>
    <li>원뿔 공통 클래스 작성 : <code class="language-plaintext highlighter-rouge">Cone</code></li>
    <li>방출 기능 담당 클래스 작성 : <code class="language-plaintext highlighter-rouge">DustEmitter</code></li>
  </ul>

  <p><br /></p>

  <h3 id="dustmanager"><strong>DustManager</strong></h3>
  <ul>
    <li>키보드 버튼 1, 2, … : 도구 선택</li>
    <li>마우스 좌클릭 : 현재 선택된 도구 작동</li>
    <li>
      <p>마우스 우클릭 : 마우스 보이기/숨기기</p>
    </li>
    <li>각 도구가 실행될 때만, 해당되는 컴퓨트 쉐이더 커널 실행</li>
    <li>지정한 World Bounds에 따라 기즈모 표시, 게임 시작 시 메시 생성</li>
  </ul>

  <p><br /></p>

</details>
<!-- --------------------------------------------------------------------------- -->

<h1 id="11-blow-기능-구현">11. Blow 기능 구현</h1>
<hr />

<details>
  <summary> 
…
</summary>

  <p><br /></p>

  <p>원뿔 범위에서 바람이 불듯 밀쳐내는 기능을 구현한다.</p>

  <p>새로운 커널 <code class="language-plaintext highlighter-rouge">BlowWind</code>를 작성하며,</p>

  <p>다른 커널과 마찬가지로 사용자의 입력에 따라 독립적으로 실행시킨다.</p>

  <p><code class="language-plaintext highlighter-rouge">VacuumUp</code>과 유사하게 구현하며, 먼지의 진행 방향만 반대로 바꾸면 된다.</p>

  <p><br /></p>
  <h2 id="section-33"><strong>[1] 컴퓨트 쉐이더</strong></h2>

  <details>
    <summary> 
DustCompute.compute
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">BlowWind</span> <span class="p">(</span><span class="n">uint3</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">dustCount</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="kt">float3</span> <span class="n">dustPos</span> <span class="o">=</span> <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">;</span>        <span class="c1">// 현재 프레임 먼지 위치</span>
    <span class="kt">float3</span> <span class="n">headToDust</span> <span class="o">=</span> <span class="p">(</span><span class="n">dustPos</span> <span class="o">-</span> <span class="n">controllerPos</span><span class="p">);</span>  <span class="c1">// 입구 -&gt; 먼지</span>
    <span class="n">float</span> <span class="n">sqrDist</span> <span class="o">=</span> <span class="n">SqrMagnitude</span><span class="p">(</span><span class="n">headToDust</span><span class="p">);</span>       <span class="c1">// 입구&lt;-&gt; 먼지 사이 거리 제곱</span>

    <span class="c1">// 구형 범위 내에 포함되는 경우</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sqrDist</span> <span class="o">&lt;</span> <span class="n">blowerSqrDist</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">float3</span> <span class="n">headToDustDir</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">headToDust</span><span class="p">);</span> <span class="c1">// 입구 -&gt; 먼지 방향</span>
        <span class="n">float</span> <span class="n">dotValue</span> <span class="o">=</span> <span class="nb">dot</span><span class="p">(</span><span class="n">controllerForward</span><span class="p">,</span> <span class="n">headToDustDir</span><span class="p">);</span>

        <span class="c1">// 원뿔 범위 내에 포함되는 경우, 밀쳐내기</span>
        <span class="k">if</span><span class="p">(</span><span class="n">dotValue</span> <span class="o">&gt;</span> <span class="n">blowerDotThreshold</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">float</span> <span class="n">force</span> <span class="o">=</span> <span class="n">blowerSqrForce</span> <span class="o">/</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">sqrDist</span><span class="p">);</span>

            <span class="kt">float3</span> <span class="n">F</span> <span class="o">=</span> <span class="n">headToDustDir</span> <span class="o">*</span> <span class="n">force</span> <span class="o">*</span> <span class="n">dotValue</span><span class="p">;</span>
            <span class="kt">float3</span> <span class="n">A</span> <span class="o">=</span> <span class="n">F</span> <span class="o">/</span> <span class="n">mass</span><span class="p">;</span>
            <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">A</span> <span class="o">*</span> <span class="n">deltaTime</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-34"><strong>[2] 먼지 관리 컴포넌트</strong></h2>

  <details>
    <summary> 
DustManager.cs
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre>
<span class="k">private</span> <span class="kt">int</span> <span class="n">kernelBlowID</span><span class="p">;</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Init</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="n">kernelBlowID</span> <span class="p">=</span> <span class="n">dustCompute</span><span class="p">.</span><span class="nf">FindKernel</span><span class="p">(</span><span class="s">"BlowWind"</span><span class="p">);</span>
    
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">SetBuffersToShaders</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernelBlowID</span><span class="p">,</span> <span class="s">"dustBuffer"</span><span class="p">,</span> <span class="n">dustBuffer</span><span class="p">);</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernelBlowID</span><span class="p">,</span> <span class="s">"velocityBuffer"</span><span class="p">,</span> <span class="n">dustVelocityBuffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateBlower</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(!</span><span class="n">blower</span><span class="p">.</span><span class="n">IsRunning</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"blowerSqrForce"</span><span class="p">,</span> <span class="n">blower</span><span class="p">.</span><span class="n">SqrForce</span><span class="p">);</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"blowerSqrDist"</span><span class="p">,</span> <span class="n">blower</span><span class="p">.</span><span class="n">SqrDistance</span><span class="p">);</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"blowerDotThreshold"</span><span class="p">,</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Cos</span><span class="p">(</span><span class="n">blower</span><span class="p">.</span><span class="n">AngleRad</span><span class="p">));</span>

    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">Dispatch</span><span class="p">(</span><span class="n">kernelBlowID</span><span class="p">,</span> <span class="n">kernelGroupSizeX</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-35"><strong>[3] 실행 결과</strong></h2>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/136383655-c0556655-d3df-4136-b3f5-943ca42336d5.gif" alt="2021_1007_Blow-Explosion" /></p>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/136383660-9566ac43-6a4a-4ec5-96a8-d91e40397f46.gif" alt="2021_1007_Blow2" /></p>

  <p><br /></p>

</details>
<!-- --------------------------------------------------------------------------- -->

<h1 id="12-무작위-색상-설정">12. 무작위 색상 설정</h1>
<hr />

<details>
  <summary> 
…
</summary>

  <p><br /></p>

  <p>두 개의 색상을 지정하여,</p>

  <p>각 먼지가 두 색상 사이에서 랜덤한 색상으로 설정되도록 구현한다.</p>

  <p><br /></p>

  <h2 id="section-36"><strong>[1] 컴퓨트 쉐이더</strong></h2>

  <details>
    <summary> 
DustCompute.compute
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="kt">RWStructuredBuffer</span><span class="o">&lt;</span><span class="kt">half3</span><span class="o">&gt;</span> <span class="n">dustColorBuffer</span><span class="p">;</span>  <span class="c1">// 먼지 색상 RGB</span>

<span class="kt">half3</span> <span class="n">dustColorA</span><span class="p">;</span> <span class="c1">// 무작위 색상 A</span>
<span class="kt">half3</span> <span class="n">dustColorB</span><span class="p">;</span> <span class="c1">// 무작위 색상 B</span>

<span class="kt">void</span> <span class="nf">Populate</span> <span class="p">(</span><span class="n">uint3</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    
    <span class="c1">// [1] 위치</span>
    <span class="n">float</span> <span class="n">width</span> <span class="o">=</span> <span class="n">spawnBoundsMax</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">spawnBoundsMin</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">seed</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">width</span><span class="p">);</span>
    <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="o">=</span> <span class="n">RandomRange13</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">spawnBoundsMin</span><span class="p">,</span> <span class="n">spawnBoundsMax</span><span class="p">);</span>
    <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="c1">// [2] 색상</span>
    <span class="kt">float2</span> <span class="n">seed2d</span> <span class="o">=</span> <span class="kt">float2</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">width</span><span class="p">,</span> <span class="n">i</span> <span class="o">/</span> <span class="n">width</span><span class="p">);</span>
    <span class="n">float</span> <span class="n">t</span> <span class="o">=</span> <span class="n">Random21</span><span class="p">(</span><span class="n">seed2d</span><span class="p">);</span>
    <span class="n">dustColorBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">lerp</span><span class="p">(</span><span class="n">dustColorA</span><span class="p">,</span> <span class="n">dustColorB</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-37"><strong>[2] 먼지 쉐이더</strong></h2>

  <details>
    <summary> 
Dust.shader
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="n">StructuredBuffer</span><span class="p">&lt;</span><span class="n">half3</span><span class="p">&gt;</span> <span class="n">_DustColorBuffer</span><span class="p">;</span>

<span class="k">struct</span> <span class="nc">v2f</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="n">half3</span> <span class="n">dustColor</span> <span class="p">:</span> <span class="n">COLOR0</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">v2f</span> <span class="nf">vert</span> <span class="p">(</span><span class="n">appdata_full</span> <span class="n">v</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">instanceID</span> <span class="p">:</span> <span class="n">SV_InstanceID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>

    <span class="c1">// ...</span>
    <span class="n">o</span><span class="p">.</span><span class="n">dustColor</span> <span class="p">=</span> <span class="n">_DustColorBuffer</span><span class="p">[</span><span class="n">instanceID</span><span class="p">];</span>

    <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">fixed4</span> <span class="nf">frag</span> <span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="p">:</span> <span class="n">SV_Target</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="n">fixed4</span> <span class="n">col</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
    <span class="n">col</span><span class="p">.</span><span class="n">rgb</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="n">dustColor</span> <span class="p">*</span> <span class="n">col</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">col</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-38"><strong>[3] 먼지 관리 컴포넌트</strong></h2>

  <details>
    <summary> 
DustManager.cs
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">Color</span> <span class="n">dustColorA</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">black</span><span class="p">;</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">Color</span> <span class="n">dustColorB</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">gray</span><span class="p">;</span>

<span class="k">private</span> <span class="n">ComputeBuffer</span> <span class="n">dustColorBuffer</span><span class="p">;</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">InitBuffers</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="c1">// Color Buffer</span>
    <span class="n">dustColorBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="n">dustCount</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="p">*</span> <span class="m">3</span><span class="p">);</span>

    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">SetBuffersToShaders</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">dustMaterial</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="s">"_DustBuffer"</span><span class="p">,</span> <span class="n">dustBuffer</span><span class="p">);</span>
    <span class="n">dustMaterial</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="s">"_DustColorBuffer"</span><span class="p">,</span> <span class="n">dustColorBuffer</span><span class="p">);</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernelPopulateID</span><span class="p">,</span> <span class="s">"dustBuffer"</span><span class="p">,</span> <span class="n">dustBuffer</span><span class="p">);</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernelPopulateID</span><span class="p">,</span> <span class="s">"dustColorBuffer"</span><span class="p">,</span> <span class="n">dustColorBuffer</span><span class="p">);</span>

    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">OnDestroy</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">dustColorBuffer</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="n">dustColorBuffer</span><span class="p">.</span><span class="nf">Release</span><span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-39"><strong>[4] 실행 결과</strong></h2>

  <ul>
    <li>지정 색상 : Red, Blue</li>
  </ul>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/136442001-f904827c-626f-4dbc-9f92-d50d6467ec5b.png" alt="image" /></p>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/136442017-2f6636e2-171f-471e-8313-bc487a3ff0e9.png" alt="image" /></p>

  <p><br /></p>

</details>
<!-- --------------------------------------------------------------------------- -->

<h1 id="13-sphere-collision-구현">13. Sphere Collision 구현</h1>
<hr />

<details>
  <summary> 
…
</summary>

  <p><br /></p>

  <p>고정된 위치에 존재하는 Sphere Collider와 먼지의 충돌을 구현한다.</p>

  <p>먼지 역시 반지름이 있는 Sphere이므로,</p>

  <p>먼지와 Sphere Collider의 충돌은 Sphere to Sphere 충돌로 계산되어야 한다.</p>

  <p><br /></p>

  <h2 id="section-40"><strong>[1] 충돌 감지</strong></h2>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/136788162-d8e5fcb3-1599-48b6-b78c-2edd7a11bcd8.png" alt="image" /></p>

  <p>충돌 감지 자체는 어렵지 않다.</p>

  <p>다음 프레임의 먼지 위치를 검사했을 때, 먼지(빨간 구체)와 충돌체(하얀 구체)의 반지름 합이 두 구체 중심 위치 사이의 거리보다 같거나 크다면 충돌로 간주하면 된다.</p>

  <p><br /></p>

  <h2 id="sphere-cast-to-sphere"><strong>[2] Sphere Cast to Sphere</strong></h2>

  <ul>
    <li><a href="../sphere-cast-to-sphere/">Post : Sphere Cast to Sphere</a></li>
    <li>구체를 전진시켜 다른 구체와의 충돌 지점을 찾아낸다.</li>
  </ul>

  <p><br /></p>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/136788363-80517aca-f970-451c-a2eb-1abd2b42345d.png" alt="image" /></p>

  <p>현재 프레임의 먼지 위치에서부터 다음 프레임의 먼지 위치까지 Sphere Cast를 통해 충돌 지점을 찾는다.</p>

  <p><br /></p>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/136788751-8a0537cd-405a-4d44-b325-d049f38d722b.png" alt="image" /></p>

  <p>충돌 지점에서부터 충돌체 중심 위치와 반대 방향을 향하는 법선 벡터를 구하고,</p>

  <p>입사 벡터를 반사시켜 충돌 이후 실제로 먼지가 이동할 다음 프레임의 위치를 계산한다.</p>

  <p><br /></p>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/136789433-338981f3-d5e2-4074-9a8b-3a7b2edc451a.png" alt="image" /></p>

  <p>이 때 <code class="language-plaintext highlighter-rouge">d</code>와 <code class="language-plaintext highlighter-rouge">d'</code>의 길이는 같으며,</p>

  <p>충돌 시 손실되는 운동량을 계산하여 <code class="language-plaintext highlighter-rouge">d'</code>에 곱해주면 된다.</p>

  <p><br /></p>

  <h2 id="section-41"><strong>[3] 컴퓨트 쉐이더 - 계산 함수</strong></h2>

  <details>
    <summary> 
functions
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre></td><td class="rouge-code"><pre><span class="c1">// 구체끼리의 충돌 여부 검사</span>
<span class="c1">// xyz : Position</span>
<span class="c1">// w : Radius</span>
<span class="n">bool</span> <span class="nf">CheckSphereIntersection</span><span class="p">(</span><span class="kt">float4</span> <span class="n">sphereA</span><span class="p">,</span> <span class="kt">float4</span> <span class="n">sphereB</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">SqrMagnitude</span><span class="p">(</span><span class="n">sphereA</span><span class="p">.</span><span class="n">rgb</span> <span class="o">-</span> <span class="n">sphereB</span><span class="p">.</span><span class="n">rgb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Square</span><span class="p">(</span><span class="n">sphereA</span><span class="p">.</span><span class="n">w</span> <span class="o">+</span> <span class="n">sphereB</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// A -&gt; B 위치로 Sphere Cast</span>
<span class="c1">// S : Target Sphere Position</span>
<span class="c1">// r1 : Radius of Casted Sphere</span>
<span class="c1">// r2 : Radius of Target Sphere</span>
<span class="kt">float3</span> <span class="nf">SphereCastToSphere</span><span class="p">(</span><span class="kt">float3</span> <span class="n">A</span><span class="p">,</span> <span class="kt">float3</span> <span class="n">B</span><span class="p">,</span> <span class="kt">float3</span> <span class="n">S</span><span class="p">,</span> <span class="n">float</span> <span class="n">r1</span><span class="p">,</span> <span class="n">float</span> <span class="n">r2</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">float3</span> <span class="n">nAB</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">B</span> <span class="o">-</span> <span class="n">A</span><span class="p">);</span>
    <span class="kt">float3</span> <span class="n">AS</span>  <span class="o">=</span> <span class="p">(</span><span class="n">S</span> <span class="o">-</span> <span class="n">A</span><span class="p">);</span>
    <span class="n">float</span> <span class="n">as2</span> <span class="o">=</span> <span class="n">SqrMagnitude</span><span class="p">(</span><span class="n">AS</span><span class="p">);</span>
    <span class="n">float</span> <span class="n">ad</span>  <span class="o">=</span> <span class="nb">dot</span><span class="p">(</span><span class="n">AS</span><span class="p">,</span> <span class="n">nAB</span><span class="p">);</span>
    <span class="n">float</span> <span class="n">ad2</span> <span class="o">=</span> <span class="n">ad</span> <span class="o">*</span> <span class="n">ad</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">ds2</span> <span class="o">=</span> <span class="n">as2</span> <span class="o">-</span> <span class="n">ad2</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">cs</span>  <span class="o">=</span> <span class="n">r1</span> <span class="o">+</span> <span class="n">r2</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">cs2</span> <span class="o">=</span> <span class="n">cs</span> <span class="o">*</span> <span class="n">cs</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">cd</span>  <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">cs2</span> <span class="o">-</span> <span class="n">ds2</span><span class="p">);</span>
    <span class="n">float</span> <span class="n">ac</span>  <span class="o">=</span> <span class="n">ad</span> <span class="o">-</span> <span class="n">cd</span><span class="p">;</span>

    <span class="kt">float3</span> <span class="n">C</span> <span class="o">=</span> <span class="n">A</span> <span class="o">+</span> <span class="n">nAB</span> <span class="o">*</span> <span class="n">ac</span><span class="p">;</span>            <span class="c1">// 충돌 시 구체 중심 좌표</span>
    <span class="c1">//float3 E = C + (S - C) * r1 / cs; // 충돌 지점 좌표</span>
    <span class="k">return</span> <span class="n">C</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Sphere Collider에 충돌 검사하여 먼지 위치 및 속도 변경</span>
<span class="c1">// - cur  : 현재 프레임에서의 위치</span>
<span class="c1">// - next : 다음 프레임에서의 위치 [INOUT]</span>
<span class="c1">// - velocity : 현재 이동 속도     [INOUT]</span>
<span class="c1">// - sphere : 구체 중심 위치(xyz), 구체 반지름(w)</span>
<span class="c1">// - dustRadius : 먼지 반지름</span>
<span class="c1">// - elasticity : 탄성력 계수(0 ~ 1) : 충돌 시 보존되는 운동량 비율</span>
<span class="kt">void</span> <span class="nf">CalculateSphereCollision</span><span class="p">(</span><span class="kt">float3</span> <span class="n">cur</span><span class="p">,</span> <span class="k">inout</span> <span class="kt">float3</span> <span class="n">next</span><span class="p">,</span> <span class="k">inout</span> <span class="kt">float3</span> <span class="n">velocity</span><span class="p">,</span> <span class="kt">float4</span> <span class="n">sphere</span><span class="p">,</span>
<span class="n">float</span> <span class="n">dustRadius</span><span class="p">,</span> <span class="n">float</span> <span class="n">elasticity</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// 충돌 시 먼지 위치</span>
    <span class="kt">float3</span> <span class="n">contactPos</span> <span class="o">=</span> <span class="n">SphereCastToSphere</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">sphere</span><span class="p">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">dustRadius</span><span class="p">,</span> <span class="n">sphere</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>

    <span class="c1">// 충돌 지점의 노멀 벡터</span>
    <span class="kt">float3</span> <span class="n">contactNormal</span> <span class="o">=</span> <span class="p">(</span><span class="n">contactPos</span> <span class="o">-</span> <span class="n">sphere</span><span class="p">.</span><span class="n">xyz</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">dustRadius</span> <span class="o">+</span> <span class="n">sphere</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>

    <span class="c1">// 충돌 지점에서 원래 다음 위치를 향한 벡터 : 잉여 벡터</span>
    <span class="kt">float3</span> <span class="n">extraVec</span> <span class="o">=</span> <span class="n">next</span> <span class="o">-</span> <span class="n">contactPos</span><span class="p">;</span>

    <span class="c1">// 반사 벡터</span>
    <span class="kt">float3</span> <span class="n">outVec</span> <span class="o">=</span> <span class="nb">reflect</span><span class="p">(</span><span class="n">extraVec</span><span class="p">,</span> <span class="n">contactNormal</span><span class="p">)</span> <span class="o">*</span> <span class="n">elasticity</span><span class="p">;</span>

    <span class="c1">// 다음 프레임 위치 변경</span>
    <span class="n">next</span> <span class="o">=</span> <span class="n">contactPos</span> <span class="o">+</span> <span class="n">outVec</span><span class="p">;</span>

    <span class="c1">// 속도 변경</span>
    <span class="n">velocity</span> <span class="o">=</span> <span class="nb">reflect</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span> <span class="n">contactNormal</span><span class="p">)</span> <span class="o">*</span> <span class="n">elasticity</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="update-"><strong>[4] 컴퓨트 쉐이더 - Update 커널</strong></h2>

  <details>
    <summary> 
DustCompute.compute
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">Update</span> <span class="p">(</span><span class="n">uint3</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">dustCount</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="c1">// ...</span>

    <span class="c1">// ===================================================</span>
    <span class="c1">//                    속도 계산</span>
    <span class="c1">// ===================================================</span>
    <span class="c1">// ...</span>
    
    <span class="c1">// ===================================================</span>
    <span class="c1">//              이동 시뮬레이션, 충돌 검사</span>
    <span class="c1">// ===================================================</span>
    <span class="c1">// 다음 프레임 위치 계산 : S = S0 + V * t</span>
    <span class="kt">float3</span> <span class="n">currPos</span> <span class="o">=</span> <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">;</span>
    <span class="kt">float3</span> <span class="n">nextPos</span> <span class="o">=</span> <span class="n">currPos</span> <span class="o">+</span> <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">deltaTime</span><span class="p">;</span>

    <span class="c1">// [1] 월드 영역 제한(Cube)</span>
    <span class="c1">// ...</span>

    <span class="c1">// [2] Sphere Collider</span>
    <span class="kt">float4</span> <span class="n">sphere</span> <span class="o">=</span> <span class="kt">float4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
    <span class="n">bool</span> <span class="n">sphereCollided</span> <span class="o">=</span> <span class="n">CheckSphereIntersection</span><span class="p">(</span><span class="kt">float4</span><span class="p">(</span><span class="n">nextPos</span><span class="p">,</span> <span class="n">radius</span><span class="p">),</span> <span class="n">sphere</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">sphereCollided</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">CalculateSphereCollision</span><span class="p">(</span><span class="n">currPos</span><span class="p">,</span> <span class="n">nextPos</span><span class="p">,</span> <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sphere</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">elasticity</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="c1">// 다음 위치 적용</span>
    <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="o">=</span> <span class="n">nextPos</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-42"><strong>[5] 실행 결과</strong></h2>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/136793689-f0580362-c211-47dc-8ad4-892f2e331b8a.gif" alt="2021_1011_Sphere Collision 1" /></p>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/136798176-c44b5caf-197e-405e-a65b-d98891c458ed.gif" alt="2021_1011_Sphere Collision 2" /></p>

  <p><br /></p>

</details>
<!-- --------------------------------------------------------------------------- -->

<h1 id="14-여러-개의-sphere-collider-구현">14. 여러 개의 Sphere Collider 구현</h1>
<hr />

<details>
  <summary> 
…
</summary>

  <p><br /></p>

  <p>게임 내에서 직접 여러 개의 Sphere Collider를 배치하고 위치와 반지름을 수정할 수 있도록 구현한다.</p>

  <p>Sphere Collider 데이터들은 하나의 Compute Buffer에 담아 전달하며,</p>

  <p>변동사항이 생길 때마다 Compute Buffer의 데이터 역시 변경해주어야 한다.</p>

  <p><br /></p>

  <h2 id="section-43"><strong>[1] 컴퓨트 쉐이더</strong></h2>

  <details>
    <summary> 
DustCompute.compute
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="cm">/* Colliders */</span>
<span class="kt">RWStructuredBuffer</span><span class="o">&lt;</span><span class="kt">float4</span><span class="o">&gt;</span> <span class="n">sphereColliderBuffer</span><span class="p">;</span>
<span class="n">uint</span> <span class="n">sphereColliderCount</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">Update</span> <span class="p">(</span><span class="n">uint3</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="kt">float3</span> <span class="n">currPos</span> <span class="o">=</span> <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">;</span>
    <span class="kt">float3</span> <span class="n">nextPos</span> <span class="o">=</span> <span class="n">currPos</span> <span class="o">+</span> <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">deltaTime</span><span class="p">;</span>

    <span class="c1">// [1] 월드 영역 제한(Cube)</span>
    <span class="c1">// ...</span>

    <span class="c1">// [2] Sphere Colliders</span>
    <span class="k">for</span><span class="p">(</span><span class="n">uint</span> <span class="n">scIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">scIndex</span> <span class="o">&lt;</span> <span class="n">sphereColliderCount</span><span class="p">;</span> <span class="n">scIndex</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">float4</span> <span class="n">sphere</span> <span class="o">=</span> <span class="n">sphereColliderBuffer</span><span class="p">[</span><span class="n">scIndex</span><span class="p">];</span>
        <span class="n">bool</span> <span class="n">sphereCollided</span> <span class="o">=</span> <span class="n">CheckSphereIntersection</span><span class="p">(</span><span class="kt">float4</span><span class="p">(</span><span class="n">nextPos</span><span class="p">,</span> <span class="n">radius</span><span class="p">),</span> <span class="n">sphere</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">sphereCollided</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">CalculateSphereCollision</span><span class="p">(</span><span class="n">currPos</span><span class="p">,</span> <span class="n">nextPos</span><span class="p">,</span> <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sphere</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">elasticity</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// 다음 위치 적용</span>
    <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="o">=</span> <span class="n">nextPos</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-44"><strong>[2] 구형 충돌체 컴포넌트</strong></h2>

  <details>
    <summary> 
DustSphereCollider.cs
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre><span class="cm">/* public class DustSphereCollider : MonoBehaviour */</span>

<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">Vector3</span> <span class="n">position</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">zero</span><span class="p">;</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">radius</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>

<span class="k">private</span> <span class="n">DustManager</span> <span class="n">dustManager</span><span class="p">;</span>

<span class="k">public</span> <span class="n">Vector4</span> <span class="n">SphereData</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">Vector4</span><span class="p">(</span>
    <span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">position</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">radius</span>
<span class="p">);</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">OnValidate</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nf">ValidateData</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">OnEnable</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dustManager</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="n">dustManager</span> <span class="p">=</span> <span class="n">FindObjectOfType</span><span class="p">&lt;</span><span class="n">DustManager</span><span class="p">&gt;();</span>

    <span class="nf">ValidateData</span><span class="p">();</span>
    <span class="n">dustManager</span><span class="p">.</span><span class="nf">AddSphereCollider</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">OnDisable</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">dustManager</span><span class="p">.</span><span class="nf">RemoveSphereCollider</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">ValidateData</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">radius</span> <span class="p">&lt;</span> <span class="m">0.1f</span><span class="p">)</span>
        <span class="n">radius</span> <span class="p">=</span> <span class="m">0.1f</span><span class="p">;</span>

    <span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">position</span><span class="p">;</span>
    <span class="n">transform</span><span class="p">.</span><span class="n">localScale</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">one</span> <span class="p">*</span> <span class="m">2f</span> <span class="p">*</span> <span class="n">radius</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-45"><strong>[3] 먼지 관리 컴포넌트</strong></h2>

  <details>
    <summary> 
DustManager.cs - SphereColliderSet
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
</pre></td><td class="rouge-code"><pre><span class="k">private</span> <span class="k">class</span> <span class="nc">SphereColliderSet</span>
<span class="p">{</span>
    <span class="cm">/* Collider */</span>
    <span class="k">private</span> <span class="n">ComputeBuffer</span> <span class="n">colliderBuffer</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">DustSphereCollider</span><span class="p">&gt;</span> <span class="n">colliders</span><span class="p">;</span>

    <span class="cm">/* Data */</span>
    <span class="k">private</span> <span class="n">Vector4</span><span class="p">[]</span> <span class="n">dataArray</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">int</span> <span class="n">dataCount</span><span class="p">;</span>

    <span class="cm">/* Compute Shader, Compute Buffer */</span>
    <span class="k">private</span> <span class="n">ComputeShader</span> <span class="n">computeShader</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">int</span> <span class="n">shaderKernel</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="n">bufferName</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="n">countVariableName</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">SphereColliderSet</span><span class="p">(</span><span class="n">ComputeShader</span> <span class="n">computeShader</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shaderKernel</span><span class="p">,</span> <span class="kt">string</span> <span class="n">bufferName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">countVariableName</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">colliders</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">DustSphereCollider</span><span class="p">&gt;(</span><span class="m">4</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="n">dataArray</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector4</span><span class="p">[</span><span class="m">4</span><span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="n">computeShader</span> <span class="p">=</span> <span class="n">computeShader</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">shaderKernel</span> <span class="p">=</span> <span class="n">shaderKernel</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">bufferName</span> <span class="p">=</span> <span class="n">bufferName</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">countVariableName</span> <span class="p">=</span> <span class="n">countVariableName</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">dataCount</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

        <span class="n">colliderBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">4</span><span class="p">);</span> <span class="c1">// 기본 값</span>
        <span class="n">computeShader</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">shaderKernel</span><span class="p">,</span> <span class="n">bufferName</span><span class="p">,</span> <span class="n">colliderBuffer</span><span class="p">);</span>
        <span class="n">computeShader</span><span class="p">.</span><span class="nf">SetInt</span><span class="p">(</span><span class="n">countVariableName</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="p">~</span><span class="nf">SphereColliderSet</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nf">ReleaseBuffer</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">ReleaseBuffer</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">colliderBuffer</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="n">colliderBuffer</span><span class="p">.</span><span class="nf">Release</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">ExpandDataArray</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Vector4</span><span class="p">[]</span> <span class="n">newArray</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector4</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="n">dataArray</span><span class="p">.</span><span class="n">Length</span> <span class="p">*</span> <span class="m">2</span><span class="p">];</span>
        <span class="n">Array</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">dataArray</span><span class="p">,</span> <span class="n">newArray</span><span class="p">,</span> <span class="n">dataCount</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="n">dataArray</span> <span class="p">=</span> <span class="n">newArray</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt; Collider 리스트로부터 Vector4 배열에 데이터 전달 &lt;/summary&gt;</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateDataArray</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dataArray</span><span class="p">.</span><span class="n">Length</span> <span class="p">&lt;</span> <span class="n">dataCount</span><span class="p">)</span>
            <span class="nf">ExpandDataArray</span><span class="p">();</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">dataCount</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="n">dataArray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">colliders</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SphereData</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt; 컴퓨트 버퍼의 데이터를 새롭게 갱신하고 컴퓨트 쉐이더에 전달 &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">UpdateBuffer</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nf">ReleaseBuffer</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dataCount</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

        <span class="nf">UpdateDataArray</span><span class="p">();</span>
        <span class="n">colliderBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="n">dataCount</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="p">*</span> <span class="m">4</span><span class="p">);</span>
        <span class="n">colliderBuffer</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="n">dataArray</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">dataCount</span><span class="p">);</span>
        <span class="n">computeShader</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">shaderKernel</span><span class="p">,</span> <span class="n">bufferName</span><span class="p">,</span> <span class="n">colliderBuffer</span><span class="p">);</span>
        <span class="n">computeShader</span><span class="p">.</span><span class="nf">SetInt</span><span class="p">(</span><span class="n">countVariableName</span><span class="p">,</span> <span class="n">dataCount</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">AddCollider</span><span class="p">(</span><span class="n">DustSphereCollider</span> <span class="n">collider</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">colliders</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">collider</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

        <span class="n">dataCount</span><span class="p">++;</span>
        <span class="n">colliders</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">collider</span><span class="p">);</span>
        <span class="nf">UpdateBuffer</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">RemoveCollider</span><span class="p">(</span><span class="n">DustSphereCollider</span> <span class="n">collider</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">colliders</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">collider</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

        <span class="n">dataCount</span><span class="p">--;</span>
        <span class="n">colliders</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="n">collider</span><span class="p">);</span>
        <span class="nf">UpdateBuffer</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">private</span> <span class="n">SphereColliderSet</span> <span class="n">sphereColliderSet</span><span class="p">;</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">AddSphereCollider</span><span class="p">(</span><span class="n">DustSphereCollider</span> <span class="n">collider</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sphereColliderSet</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">afterInitJobQueue</span><span class="p">.</span><span class="nf">Enqueue</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">sphereColliderSet</span><span class="p">.</span><span class="nf">AddCollider</span><span class="p">(</span><span class="n">collider</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">sphereColliderSet</span><span class="p">.</span><span class="nf">AddCollider</span><span class="p">(</span><span class="n">collider</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">RemoveSphereCollider</span><span class="p">(</span><span class="n">DustSphereCollider</span> <span class="n">collider</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sphereColliderSet</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="n">sphereColliderSet</span><span class="p">.</span><span class="nf">RemoveCollider</span><span class="p">(</span><span class="n">collider</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <details>
    <summary> 
DustManager.cs
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="c1">// 게임 시작 시 초기화 작업 완료 후 처리</span>
<span class="k">private</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">Action</span><span class="p">&gt;</span> <span class="n">afterInitJobQueue</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">Action</span><span class="p">&gt;();</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="nf">InitColliders</span><span class="p">();</span>
    <span class="nf">ProcessInitialJobs</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">InitColliders</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">sphereColliderSet</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SphereColliderSet</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">dustCompute</span><span class="p">,</span> <span class="n">kernelUpdateID</span><span class="p">,</span> <span class="s">"sphereColliderBuffer"</span><span class="p">,</span> <span class="s">"sphereColliderCount"</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-46"><strong>[4] 실행 결과</strong></h2>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/136919803-caff4cc1-c25f-4756-a1d5-d0323f8c9bab.gif" alt="2021_1012_Multiple Sphere Collision" /></p>

  <p><br /></p>

</details>
<!-- --------------------------------------------------------------------------- -->

<h1 id="15-투사체-발사-및-폭발-효과-구현">15. 투사체 발사 및 폭발 효과 구현</h1>
<hr />

<details>
  <summary> 
…
</summary>

  <p><br /></p>

  <p>투사체를 발사하여 충돌체에 닿으면 폭발하는 기능을 구현한다.</p>

  <p><br /></p>

  <h2 id="section-47"><strong>[1] 충돌체 동기화 방식</strong></h2>

  <p>컴퓨트 쉐이더 내에서 World Bounds, Sphere Collider가 구현되어 있다.</p>

  <p>이는 유니티엔진 내에서 사용할 수 있는 물리 엔진의 Collider와는 별개이므로, 두 가지 선택지가 있다.</p>

  <ol>
    <li>투사체의 움직임, 충돌 감지를 모두 컴퓨트 쉐이더 내에서 구현한다.</li>
    <li>컴퓨트 쉐이더 내의 충돌체들을 유니티 엔진 내에서 컴포넌트로 동일하게 생성한다.</li>
  </ol>

  <p><br /></p>

  <p><code class="language-plaintext highlighter-rouge">1번</code>의 방식대로 구현하려면, 일단 현재 사용 중인 <code class="language-plaintext highlighter-rouge">DustCompute</code> 컴퓨트 쉐이더 내에서는 할 수 없다.</p>

  <p><code class="language-plaintext highlighter-rouge">DustCompute</code>에서 실제로 동작하는 각각의 스레드는, 각자 하나의 먼지를 담당하여 동작한다.</p>

  <p>그러니 이 컴퓨트 쉐이더의 수십만 스레드 전부가 투사체의 움직임을 중복해서 계산할 수는 없는 노릇이고,</p>

  <p>그렇다고 투사체의 개수만큼의 스레드를 지정해서 계산토록 하는 것은 병렬처리의 불균형을 초래하므로 바람직하지 않다.</p>

  <p>그래서 또다른 컴퓨트 쉐이더를 구현하자니, 고작 몇 개의 투사체 연산 때문에 컴퓨트 쉐이더를 사용하는건 오히려 낭비이므로 차라리 CPU에서 연산하는 것이 낫다.</p>

  <p><br /></p>

  <p>따라서 <code class="language-plaintext highlighter-rouge">2번</code>을 선택하여, 컴퓨트 쉐이더 내의 충돌체를 CPU, 즉 유니티 월드 내에도 동기화하여 유니티의 물리엔진을 활용하는 것이 낫다.</p>

  <p>어차피 컴퓨트 쉐이더에서 충돌체들을 선언하여 사용하는 것이 아니라, 애초에 CPU에서 충돌체 정보를 정의하여 컴퓨트 쉐이더에 전달해주는 방식이었으므로</p>

  <p>이 충돌체 정보들을 토대로 Collider 컴포넌트들을 추가해주고 투사체의 움직임은 Rigidbody를 기반으로 구현하면 된다.</p>

  <p>다시 말해, CPU에서 정의한 충돌체를 컴퓨트 쉐이더와 유니티 물리엔진이 동기화하여 사용하는 것이다.</p>

  <p><br /></p>

  <h2 id="section-48"><strong>[2] 유니티 엔진에서 충돌체 추가</strong></h2>

  <p>방법은 아주 간단하다.</p>

  <p>월드 영역을 제한하는 <code class="language-plaintext highlighter-rouge">World Bounds</code>는 큐브 형태지만,</p>

  <p>일반적인 큐브 콜라이더와는 달리 충돌 영역이 외부가 아니라 내부를 향한다.</p>

  <p>월드 영역 메시도 폴리곤이 내부를 향하도록 구현되어 있으므로,</p>

  <p>그냥 <code class="language-plaintext highlighter-rouge">Mesh Collider</code> 컴포넌트만 추가해주면 된다.</p>

  <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="cm">/* DustManager.cs */</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">InitWorldBounds</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="k">if</span> <span class="p">(!</span><span class="n">worldGO</span><span class="p">.</span><span class="nf">TryGetComponent</span><span class="p">(</span><span class="k">out</span> <span class="n">MeshCollider</span> <span class="n">_</span><span class="p">))</span>
        <span class="n">worldGO</span><span class="p">.</span><span class="n">AddComponent</span><span class="p">&lt;</span><span class="n">MeshCollider</span><span class="p">&gt;();</span>
    
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>  </div>

  <p><br /></p>

  <p>마찬가지로 <code class="language-plaintext highlighter-rouge">DustSphereCollider</code> 클래스에서도 <code class="language-plaintext highlighter-rouge">SphereCollider</code> 컴포넌트를 추가해준다.</p>

  <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="cm">/* DustSphereCollider.cs */</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">OnEnable</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="k">if</span> <span class="p">(!</span><span class="nf">TryGetComponent</span><span class="p">(</span><span class="k">out</span> <span class="n">SphereCollider</span> <span class="n">_</span><span class="p">))</span>
        <span class="n">gameObject</span><span class="p">.</span><span class="n">AddComponent</span><span class="p">&lt;</span><span class="n">SphereCollider</span><span class="p">&gt;();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>  </div>

  <p><br /></p>

  <p>모든 충돌체 게임오브젝트는 <code class="language-plaintext highlighter-rouge">DustCollider</code> 컴포넌트를 가지며, <code class="language-plaintext highlighter-rouge">"DustCollider"</code> 태그로 설정한다.</p>

  <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">DustCollider</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">ColliderTag</span> <span class="p">=</span> <span class="s">"DustCollider"</span><span class="p">;</span>

    <span class="k">protected</span> <span class="k">void</span> <span class="nf">Awake</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">tag</span> <span class="p">=</span> <span class="n">ColliderTag</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>  </div>

  <p><br /></p>

  <h2 id="section-49"><strong>[3] 투사체 구현</strong></h2>

  <p>발사되는 투사체를 구현한다.</p>

  <p><code class="language-plaintext highlighter-rouge">Rigidbody</code>를 통해 물리엔진 기반으로 이동하며,</p>

  <p><code class="language-plaintext highlighter-rouge">Sphere Collider</code>를 통해 <code class="language-plaintext highlighter-rouge">OnTriggerEnter()</code> 메소드에서 충돌을 감지한다.</p>

  <p><code class="language-plaintext highlighter-rouge">"DustCollider"</code> 태그를 갖는 충돌체를 감지할 경우, 스스로를 파괴하며 <code class="language-plaintext highlighter-rouge">DustManager</code>의 <code class="language-plaintext highlighter-rouge">Explode()</code> 메소드를 실행한다.</p>

  <p><code class="language-plaintext highlighter-rouge">Rigidbody</code>, <code class="language-plaintext highlighter-rouge">Sphere Collider</code> 컴포넌트와 함께 하나의 게임오브젝트에 담아서 미리 프리팹화한다.</p>

  <details>
    <summary> 
CannonBall.cs
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">CannonBall</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">Rigidbody</span> <span class="n">rBody</span><span class="p">;</span>

    <span class="k">private</span> <span class="kt">float</span> <span class="n">explosionSqrRange</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">float</span> <span class="n">explosionForce</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">Init</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rBody</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="n">rBody</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">Rigidbody</span><span class="p">&gt;();</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rBody</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="n">rBody</span> <span class="p">=</span> <span class="n">gameObject</span><span class="p">.</span><span class="n">AddComponent</span><span class="p">&lt;</span><span class="n">Rigidbody</span><span class="p">&gt;();</span>

        <span class="nf">TryGetComponent</span><span class="p">(</span><span class="k">out</span> <span class="n">Collider</span> <span class="n">col</span><span class="p">);</span>
        <span class="n">col</span><span class="p">.</span><span class="n">isTrigger</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Shoot</span><span class="p">(</span><span class="k">in</span> <span class="n">Vector3</span> <span class="n">movement</span><span class="p">,</span> <span class="k">in</span> <span class="kt">float</span> <span class="n">explosionRange</span><span class="p">,</span> <span class="k">in</span> <span class="kt">float</span> <span class="n">explosionForce</span><span class="p">,</span> <span class="k">in</span> <span class="kt">float</span> <span class="n">lifespan</span> <span class="p">=</span> <span class="m">5f</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nf">Init</span><span class="p">();</span>
        <span class="nf">Destroy</span><span class="p">(</span><span class="n">gameObject</span><span class="p">,</span> <span class="n">lifespan</span><span class="p">);</span>
        <span class="n">rBody</span><span class="p">.</span><span class="nf">AddForce</span><span class="p">(</span><span class="n">movement</span><span class="p">,</span> <span class="n">ForceMode</span><span class="p">.</span><span class="n">Impulse</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="n">explosionSqrRange</span> <span class="p">=</span> <span class="n">explosionRange</span> <span class="p">*</span> <span class="n">explosionRange</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">explosionForce</span> <span class="p">=</span> <span class="n">explosionForce</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">OnTriggerEnter</span><span class="p">(</span><span class="n">Collider</span> <span class="n">other</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="nf">CompareTag</span><span class="p">(</span><span class="n">DustCollider</span><span class="p">.</span><span class="n">ColliderTag</span><span class="p">)</span> <span class="p">==</span> <span class="k">false</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

        <span class="n">DustManager</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="nf">Explode</span><span class="p">(</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">,</span> <span class="n">explosionSqrRange</span><span class="p">,</span> <span class="n">explosionForce</span><span class="p">);</span>
        <span class="nf">Destroy</span><span class="p">(</span><span class="n">gameObject</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-50"><strong>[4] 발사대 구현</strong></h2>

  <p><code class="language-plaintext highlighter-rouge">Cone</code> 클래스를 상속받는 <code class="language-plaintext highlighter-rouge">Cannon</code> 클래스를 정의한다.</p>

  <p>발사 쿨타임을 설정하며, 쿨타임이 돌아왔을 때 <code class="language-plaintext highlighter-rouge">isRunning</code> 필드가 <code class="language-plaintext highlighter-rouge">true</code> 값을 갖게될 경우 포탄 프리팹을 복제하여 발사한다.</p>

  <details>
    <summary> 
Cannon.cs
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">Cannon</span> <span class="p">:</span> <span class="n">Cone</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">Header</span><span class="p">(</span><span class="s">"Cannon Options"</span><span class="p">)]</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">GameObject</span> <span class="n">cannonBallPrefab</span><span class="p">;</span>

    <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">200f</span><span class="p">)]</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">explosionRange</span> <span class="p">=</span> <span class="m">25f</span><span class="p">;</span>

    <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">100f</span><span class="p">,</span> <span class="m">10000f</span><span class="p">)]</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">explosionForce</span> <span class="p">=</span> <span class="m">3000f</span><span class="p">;</span>

    <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0.1f</span><span class="p">,</span> <span class="m">2f</span><span class="p">)]</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">shootingInterval</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>

    <span class="k">private</span> <span class="kt">float</span> <span class="n">currentCooldown</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">currentCooldown</span> <span class="p">&gt;</span> <span class="m">0f</span><span class="p">)</span>
            <span class="n">currentCooldown</span> <span class="p">-=</span> <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span><span class="p">;</span>

        <span class="c1">// 발사</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">isRunning</span> <span class="p">&amp;&amp;</span> <span class="n">currentCooldown</span> <span class="p">&lt;=</span> <span class="m">0f</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">currentCooldown</span> <span class="p">=</span> <span class="n">shootingInterval</span><span class="p">;</span>
            <span class="nf">Shoot</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Shoot</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">GameObject</span> <span class="n">clone</span> <span class="p">=</span> <span class="nf">Instantiate</span><span class="p">(</span><span class="n">cannonBallPrefab</span><span class="p">,</span> <span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">,</span> <span class="n">Quaternion</span><span class="p">.</span><span class="n">identity</span><span class="p">);</span>
        <span class="n">CannonBall</span> <span class="n">ball</span> <span class="p">=</span> <span class="n">clone</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">CannonBall</span><span class="p">&gt;();</span>

        <span class="n">ball</span><span class="p">.</span><span class="nf">Shoot</span><span class="p">(</span><span class="n">transform</span><span class="p">.</span><span class="n">forward</span> <span class="p">*</span> <span class="n">force</span><span class="p">,</span> <span class="n">explosionRange</span><span class="p">,</span> <span class="n">explosionForce</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="explode--"><strong>[5] Explode 커널 구현</strong></h2>

  <p>폭발 중심 위치로부터 구 범위 내의 먼지를 밀쳐내는 기능을 별도의 커널로 작성한다.</p>

  <details>
    <summary> 
DustCompute.compute
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="cp">#pragma kernel Explode
</span>
<span class="cm">/* Explode */</span>
<span class="kt">float3</span> <span class="n">explosionPosition</span><span class="p">;</span> <span class="c1">// 폭발 중심 위치</span>
<span class="n">float</span> <span class="n">explosionSqrRange</span><span class="p">;</span>  <span class="c1">// 폭발 반지름 - 제곱</span>
<span class="n">float</span> <span class="n">explosionForce</span><span class="p">;</span>     <span class="c1">// 폭발 힘</span>

<span class="kt">void</span> <span class="nf">Explode</span> <span class="p">(</span><span class="n">uint3</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">dustCount</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="kt">float3</span> <span class="n">dustPos</span> <span class="o">=</span> <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">;</span>             <span class="c1">// 현재 프레임 먼지 위치</span>
    <span class="kt">float3</span> <span class="n">centerToDust</span> <span class="o">=</span> <span class="p">(</span><span class="n">dustPos</span> <span class="o">-</span> <span class="n">explosionPosition</span><span class="p">);</span> <span class="c1">// 폭발 중심 -&gt; 먼지</span>
    <span class="n">float</span> <span class="n">sqrDist</span> <span class="o">=</span> <span class="n">SqrMagnitude</span><span class="p">(</span><span class="n">centerToDust</span><span class="p">);</span>          <span class="c1">// 폭발 중심&lt;-&gt; 먼지 사이 거리 제곱</span>

    <span class="c1">// 구형 범위 내에 포함되는 경우</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sqrDist</span> <span class="o">&lt;</span> <span class="n">explosionSqrRange</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">float</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">sqrDist</span> <span class="o">/</span> <span class="n">explosionSqrRange</span><span class="p">);</span>
        <span class="n">float</span> <span class="n">f</span> <span class="o">=</span> <span class="n">t</span> <span class="o">*</span> <span class="n">explosionForce</span><span class="p">;</span>
        <span class="kt">float3</span> <span class="n">dir</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">centerToDust</span><span class="p">);</span>

        <span class="kt">float3</span> <span class="n">F</span> <span class="o">=</span> <span class="n">dir</span> <span class="o">*</span> <span class="n">f</span><span class="p">;</span>
        <span class="kt">float3</span> <span class="n">A</span> <span class="o">=</span> <span class="n">F</span> <span class="o">/</span> <span class="n">mass</span><span class="p">;</span>
        <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">A</span> <span class="o">*</span> <span class="n">deltaTime</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-51"><strong>[6] 먼지 관리 컴포넌트</strong></h2>

  <p>우선, 편의상 싱글톤 클래스로 정의한다.</p>

  <p>그리고 다른 <code class="language-plaintext highlighter-rouge">Cone</code>들과 마찬가지로 <code class="language-plaintext highlighter-rouge">Cannon</code> 필드를 작성하며,</p>

  <p>키보드 <code class="language-plaintext highlighter-rouge">4</code> 키를 눌러 선택할 수 있게 한다.</p>

  <p><code class="language-plaintext highlighter-rouge">Cannon</code>에 의해 투사체를 발사하는 메소드 <code class="language-plaintext highlighter-rouge">Explode()</code>를 작성하며,</p>

  <p>이 메소드 내에서는 <code class="language-plaintext highlighter-rouge">Explode</code> 커널에 필요한 변수 값들을 전달하고, 해당 커널을 실행한다.</p>

  <details>
    <summary> 
DustManager.cs
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="c1">// 싱글톤</span>
<span class="k">public</span> <span class="k">static</span> <span class="n">DustManager</span> <span class="n">Instance</span> <span class="p">=&gt;</span> <span class="n">_instance</span><span class="p">;</span>
<span class="k">private</span> <span class="k">static</span> <span class="n">DustManager</span> <span class="n">_instance</span><span class="p">;</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Awake</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">_instance</span> <span class="p">=</span> <span class="k">this</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 다른 커널들과 동일한 방식의 kernelID 등의 내용은 생략 //</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">Explode</span><span class="p">(</span><span class="k">in</span> <span class="n">Vector3</span> <span class="n">position</span><span class="p">,</span> <span class="k">in</span> <span class="kt">float</span> <span class="n">sqrRange</span><span class="p">,</span> <span class="k">in</span> <span class="kt">float</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetVector</span><span class="p">(</span><span class="s">"explosionPosition"</span><span class="p">,</span> <span class="n">position</span><span class="p">);</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"explosionSqrRange"</span><span class="p">,</span> <span class="n">sqrRange</span><span class="p">);</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"explosionForce"</span><span class="p">,</span> <span class="n">force</span><span class="p">);</span>
    <span class="n">dustCompute</span><span class="p">.</span><span class="nf">Dispatch</span><span class="p">(</span><span class="n">kernelExplode</span><span class="p">,</span> <span class="n">kernelGroupSizeX</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-52"><strong>[7] 실행 결과</strong></h2>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/137156908-aa1c7406-0689-4bcf-ac31-8641dce9b52e.gif" alt="2021_1013_Explode 1" /></p>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/137156928-9bb4c1fc-b0b8-4c06-a3c8-cf7df9294d2d.gif" alt="2021_1013_Explode 2" /></p>

  <p><br /></p>

  <h2 id="section-53"><strong>[8] 폭발 이펙트 추가</strong></h2>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/137484005-87074c6c-a9b7-4d5d-b6c8-52d045694381.gif" alt="2021_1015_Exposion and Flash" /></p>

  <p><br /></p>

</details>
<!-- --------------------------------------------------------------------------- -->

<h1 id="16-boxaabb-collision-구현">16. Box(AABB) Collision 구현</h1>
<hr />

<details>
  <summary> 
…
</summary>

  <p><br /></p>

  <p><strong>Sphere Collider</strong>의 정의에 필요한 데이터는 위치(<code class="language-plaintext highlighter-rouge">float3</code>)와 반지름(<code class="language-plaintext highlighter-rouge">float</code>)이다.</p>

  <p>반면 <strong>Box Collider</strong>를 정의하기 위해 필요한 데이터는 위치(<code class="language-plaintext highlighter-rouge">float3</code>)와 크기(<code class="language-plaintext highlighter-rouge">float3</code>) 또는 최소 지점(<code class="language-plaintext highlighter-rouge">float3</code>)과 최대 지점(<code class="language-plaintext highlighter-rouge">float3</code>)이다.</p>

  <p>이 중에서 최소 지점과 최대 지점을 통해 <strong>Box Collider</strong>를 정의한다.</p>

  <p><br /></p>

  <h2 id="dustcollider--"><strong>[1] DustCollider 클래스 수정</strong></h2>

  <p>컴퓨트 쉐이더에서 전달할 데이터를 제네릭을 통해 콜라이더마다 정의할 수 있도록, 아래와 같이 수정한다.</p>

  <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">DustCollider</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">abstract</span> <span class="n">T</span> <span class="n">Data</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>  </div>

  <p><br /></p>

  <h2 id="dustboxcollider--"><strong>[2] DustBoxCollider 클래스 작성</strong></h2>

  <p>유니티 엔진의 <code class="language-plaintext highlighter-rouge">Bounds</code> 구조체와 호환되는 <code class="language-plaintext highlighter-rouge">MinMaxBounds</code> 구조체를 작성하고,</p>

  <p>이를 <code class="language-plaintext highlighter-rouge">Data</code>로 사용하는 <code class="language-plaintext highlighter-rouge">DustBoxCollider</code> 클래스를 작성한다.</p>

  <p>트랜스폼의 스케일을 기반으로 콜라이더 영역이 정의된다.</p>

  <details>
    <summary> 
DustBoxCollider.cs
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="c1">/// &lt;summary&gt; </span>
<span class="c1">/// Box Collider를 위한 Min-Max 데이터</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">struct</span> <span class="nc">MinMaxBounds</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">Vector3</span> <span class="n">min</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">Vector3</span> <span class="n">max</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">MinMaxBounds</span> <span class="nf">FromBounds</span><span class="p">(</span><span class="k">in</span> <span class="n">Bounds</span> <span class="n">bounds</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">MinMaxBounds</span> <span class="n">mmb</span> <span class="p">=</span> <span class="k">default</span><span class="p">;</span>
        <span class="n">mmb</span><span class="p">.</span><span class="n">min</span> <span class="p">=</span> <span class="n">bounds</span><span class="p">.</span><span class="n">min</span><span class="p">;</span>
        <span class="n">mmb</span><span class="p">.</span><span class="n">max</span> <span class="p">=</span> <span class="n">bounds</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">mmb</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">DustBoxCollider</span> <span class="p">:</span> <span class="n">DustCollider</span><span class="p">&lt;</span><span class="n">MinMaxBounds</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">override</span> <span class="n">MinMaxBounds</span> <span class="n">Data</span>
    <span class="p">{</span>
        <span class="k">get</span>
        <span class="p">{</span>
            <span class="n">Bounds</span> <span class="n">b</span> <span class="p">=</span> <span class="k">default</span><span class="p">;</span>
            <span class="n">b</span><span class="p">.</span><span class="n">center</span> <span class="p">=</span> <span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">;</span>
            <span class="n">b</span><span class="p">.</span><span class="n">extents</span> <span class="p">=</span> <span class="n">transform</span><span class="p">.</span><span class="n">lossyScale</span> <span class="p">*</span> <span class="m">0.5f</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">MinMaxBounds</span><span class="p">.</span><span class="nf">FromBounds</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="colliderset--"><strong>[3] 제네릭 ColliderSet 클래스 작성</strong></h2>

  <p>기존의 <code class="language-plaintext highlighter-rouge">SphereColliderSet</code> 클래스를 제네릭화하여,</p>

  <p><code class="language-plaintext highlighter-rouge">Data</code>를 정의하기만 하면 앞으로 작성할 모든 콜라이더를 같은 방식으로 관리할 수 있도록 한다.</p>

  <details>
    <summary> 
DustManager.cs
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
</pre></td><td class="rouge-code"><pre><span class="k">private</span> <span class="k">class</span> <span class="nc">ColliderSet</span><span class="p">&lt;</span><span class="n">TCol</span><span class="p">,</span> <span class="n">TData</span><span class="p">&gt;</span> <span class="k">where</span> <span class="n">TCol</span> <span class="p">:</span> <span class="n">DustCollider</span><span class="p">&lt;</span><span class="n">TData</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="cm">/* Collider */</span>
    <span class="k">private</span> <span class="n">ComputeBuffer</span> <span class="n">colliderBuffer</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">TCol</span><span class="p">&gt;</span> <span class="n">colliders</span><span class="p">;</span>

    <span class="cm">/* Data */</span>
    <span class="k">private</span> <span class="n">TData</span><span class="p">[]</span> <span class="n">dataArray</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">int</span> <span class="n">dataCount</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">int</span> <span class="n">dataStride</span><span class="p">;</span>

    <span class="cm">/* Compute Shader, Compute Buffer */</span>
    <span class="k">private</span> <span class="n">ComputeShader</span> <span class="n">computeShader</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">int</span> <span class="n">shaderKernel</span><span class="p">;</span> <span class="c1">// Update Kernel</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="n">bufferName</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="n">countVariableName</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">ColliderSet</span><span class="p">(</span><span class="n">ComputeShader</span> <span class="n">computeShader</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shaderKernel</span><span class="p">,</span> <span class="kt">string</span> <span class="n">bufferName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">countVariableName</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dataStride</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">colliders</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">TCol</span><span class="p">&gt;(</span><span class="m">4</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="n">dataArray</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TData</span><span class="p">[</span><span class="m">4</span><span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="n">computeShader</span> <span class="p">=</span> <span class="n">computeShader</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">shaderKernel</span> <span class="p">=</span> <span class="n">shaderKernel</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">bufferName</span> <span class="p">=</span> <span class="n">bufferName</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">countVariableName</span> <span class="p">=</span> <span class="n">countVariableName</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">dataStride</span> <span class="p">=</span> <span class="n">dataStride</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">dataCount</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

        <span class="n">colliderBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">4</span><span class="p">);</span> <span class="c1">// 기본 값</span>
        <span class="n">computeShader</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">shaderKernel</span><span class="p">,</span> <span class="n">bufferName</span><span class="p">,</span> <span class="n">colliderBuffer</span><span class="p">);</span>
        <span class="n">computeShader</span><span class="p">.</span><span class="nf">SetInt</span><span class="p">(</span><span class="n">countVariableName</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="p">~</span><span class="nf">ColliderSet</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nf">ReleaseBuffer</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">ReleaseBuffer</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">colliderBuffer</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="n">colliderBuffer</span><span class="p">.</span><span class="nf">Release</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">ExpandDataArray</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">TData</span><span class="p">[]</span> <span class="n">newArray</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TData</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="n">dataArray</span><span class="p">.</span><span class="n">Length</span> <span class="p">*</span> <span class="m">2</span><span class="p">];</span>
        <span class="n">Array</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">dataArray</span><span class="p">,</span> <span class="n">newArray</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">dataArray</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="n">dataArray</span> <span class="p">=</span> <span class="n">newArray</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt; 컴퓨트 버퍼의 데이터를 새롭게 갱신하고 컴퓨트 쉐이더에 전달 &lt;/summary&gt;</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">ReallocateBuffer</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nf">ReleaseBuffer</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dataCount</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

        <span class="n">colliderBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="n">dataCount</span><span class="p">,</span> <span class="n">dataStride</span><span class="p">);</span>
        <span class="n">computeShader</span><span class="p">.</span><span class="nf">SetInt</span><span class="p">(</span><span class="n">countVariableName</span><span class="p">,</span> <span class="n">dataCount</span><span class="p">);</span>
        <span class="nf">UpdateColliderData</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt; 배열 내부의 콜라이더 데이터만 갱신하여 컴퓨트 쉐이더에 전달 &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">UpdateColliderData</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dataArray</span><span class="p">.</span><span class="n">Length</span> <span class="p">&lt;</span> <span class="n">dataCount</span><span class="p">)</span>
            <span class="nf">ExpandDataArray</span><span class="p">();</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">dataCount</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="n">dataArray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">colliders</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Data</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">colliderBuffer</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="n">dataArray</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">dataCount</span><span class="p">);</span>
        <span class="n">computeShader</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">shaderKernel</span><span class="p">,</span> <span class="n">bufferName</span><span class="p">,</span> <span class="n">colliderBuffer</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">AddCollider</span><span class="p">(</span><span class="n">TCol</span> <span class="n">collider</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">colliders</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">collider</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

        <span class="n">dataCount</span><span class="p">++;</span>
        <span class="n">colliders</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">collider</span><span class="p">);</span>
        <span class="nf">ReallocateBuffer</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">RemoveCollider</span><span class="p">(</span><span class="n">TCol</span> <span class="n">collider</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">colliders</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">collider</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

        <span class="n">dataCount</span><span class="p">--;</span>
        <span class="n">colliders</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="n">collider</span><span class="p">);</span>
        <span class="nf">ReallocateBuffer</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="collider-api-"><strong>[4] Collider API 작성</strong></h2>

  <p>콜라이더에서 호출하기 위한 <code class="language-plaintext highlighter-rouge">DustManager</code>의 메소드들을 공통 기능 <code class="language-plaintext highlighter-rouge">Add</code>, <code class="language-plaintext highlighter-rouge">Update</code>, <code class="language-plaintext highlighter-rouge">Remove</code>로 묶어 제네릭화한다.</p>

  <p>그리고 각 콜라이더 메소드에서는 간단히 호출할 수 있도록 한 줄씩만 작성해주면 된다.</p>

  <details>
    <summary> 
DustManager.cs
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
</pre></td><td class="rouge-code"><pre><span class="k">private</span> <span class="n">ColliderSet</span><span class="p">&lt;</span><span class="n">DustSphereCollider</span><span class="p">,</span> <span class="n">Vector4</span><span class="p">&gt;</span> <span class="n">sphereColliderSet</span><span class="p">;</span>
<span class="k">private</span> <span class="n">ColliderSet</span><span class="p">&lt;</span><span class="n">DustBoxCollider</span><span class="p">,</span> <span class="n">MinMaxBounds</span><span class="p">&gt;</span> <span class="n">boxColliderSet</span><span class="p">;</span>


<span class="cm">/* Generic Collider Methods */</span>

<span class="k">private</span> <span class="k">void</span> <span class="n">AddCollider</span><span class="p">&lt;</span><span class="n">TCol</span><span class="p">,</span> <span class="n">TData</span><span class="p">&gt;(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">ColliderSet</span><span class="p">&lt;</span><span class="n">TCol</span><span class="p">,</span> <span class="n">TData</span><span class="p">&gt;&gt;</span> <span class="n">getter</span><span class="p">,</span> <span class="n">TCol</span> <span class="n">collider</span><span class="p">)</span> <span class="k">where</span> <span class="n">TCol</span> <span class="p">:</span> <span class="n">DustCollider</span><span class="p">&lt;</span><span class="n">TData</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">colSet</span> <span class="p">=</span> <span class="nf">getter</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">colSet</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">afterInitJobQueue</span><span class="p">.</span><span class="nf">Enqueue</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nf">getter</span><span class="p">().</span><span class="nf">AddCollider</span><span class="p">(</span><span class="n">collider</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">colSet</span><span class="p">.</span><span class="nf">AddCollider</span><span class="p">(</span><span class="n">collider</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">/// &lt;summary&gt; ColliderSet의 내부 컴퓨트 버퍼 갱신 &lt;/summary&gt;</span>
<span class="k">private</span> <span class="k">void</span> <span class="n">UpdateCollider</span><span class="p">&lt;</span><span class="n">TCol</span><span class="p">,</span> <span class="n">TData</span><span class="p">&gt;(</span><span class="n">ColliderSet</span><span class="p">&lt;</span><span class="n">TCol</span><span class="p">,</span> <span class="n">TData</span><span class="p">&gt;</span> <span class="k">set</span><span class="p">)</span> <span class="k">where</span> <span class="n">TCol</span> <span class="p">:</span> <span class="n">DustCollider</span><span class="p">&lt;</span><span class="n">TData</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">set</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="k">set</span><span class="p">.</span><span class="nf">UpdateColliderData</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">/// &lt;summary&gt; ColliderSet에서 Collider 제거 &lt;/summary&gt;</span>
<span class="k">private</span> <span class="k">void</span> <span class="n">RemoveCollider</span><span class="p">&lt;</span><span class="n">TCol</span><span class="p">,</span> <span class="n">TData</span><span class="p">&gt;(</span><span class="n">ColliderSet</span><span class="p">&lt;</span><span class="n">TCol</span><span class="p">,</span> <span class="n">TData</span><span class="p">&gt;</span> <span class="k">set</span><span class="p">,</span> <span class="n">TCol</span> <span class="n">collider</span><span class="p">)</span> <span class="k">where</span> <span class="n">TCol</span> <span class="p">:</span> <span class="n">DustCollider</span><span class="p">&lt;</span><span class="n">TData</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">set</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="k">set</span><span class="p">.</span><span class="nf">RemoveCollider</span><span class="p">(</span><span class="n">collider</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Sphere Collider */</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">AddSphereCollider</span><span class="p">(</span><span class="n">DustSphereCollider</span> <span class="n">collider</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nf">AddCollider</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">sphereColliderSet</span><span class="p">,</span> <span class="n">collider</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">UpdateSphereCollider</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nf">UpdateCollider</span><span class="p">(</span><span class="n">sphereColliderSet</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">RemoveSphereCollider</span><span class="p">(</span><span class="n">DustSphereCollider</span> <span class="n">collider</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nf">RemoveCollider</span><span class="p">(</span><span class="n">sphereColliderSet</span><span class="p">,</span> <span class="n">collider</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Box Collider */</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">AddBoxCollider</span><span class="p">(</span><span class="n">DustBoxCollider</span> <span class="n">collider</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nf">AddCollider</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">boxColliderSet</span><span class="p">,</span> <span class="n">collider</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">UpdateBoxCollider</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nf">UpdateCollider</span><span class="p">(</span><span class="n">boxColliderSet</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">RemoveBoxCollider</span><span class="p">(</span><span class="n">DustBoxCollider</span> <span class="n">collider</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nf">RemoveCollider</span><span class="p">(</span><span class="n">boxColliderSet</span><span class="p">,</span> <span class="n">collider</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="aabb--"><strong>[5] AABB 충돌 감지</strong></h2>

  <p>AABB와 Dust(Sphere)의 충돌 감지는 간단하다.</p>

  <ul>
    <li><a href="../sphere-aabb-intersection/">Post : Sphere-AABB Intersection</a></li>
  </ul>

  <details>
    <summary> 
DustCompute.compute
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="c1">// 구체와 육면체(AABB)의 충돌 여부 검사</span>
<span class="c1">// AABB : Axis Aligned Bounding Box</span>
<span class="c1">// S : 구체의 위치</span>
<span class="c1">// r : 구체의 반지름</span>
<span class="n">bool</span> <span class="nf">SphereToAABBIntersection</span><span class="p">(</span><span class="kt">float3</span> <span class="n">S</span><span class="p">,</span> <span class="n">float</span> <span class="n">r</span><span class="p">,</span> <span class="n">Bounds</span> <span class="n">aabb</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Future Works : 최적화</span>

    <span class="c1">// [1] AABB까지의 최단지점 계산</span>
    <span class="kt">float3</span> <span class="n">C</span> <span class="o">=</span> <span class="n">S</span><span class="p">;</span>
    <span class="k">if</span>      <span class="p">(</span><span class="n">C</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">aabb</span><span class="p">.</span><span class="nb">min</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="n">C</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">aabb</span><span class="p">.</span><span class="nb">min</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">C</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">aabb</span><span class="p">.</span><span class="nb">max</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="n">C</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">aabb</span><span class="p">.</span><span class="nb">max</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="k">if</span>      <span class="p">(</span><span class="n">C</span><span class="p">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">aabb</span><span class="p">.</span><span class="nb">min</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="n">C</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">aabb</span><span class="p">.</span><span class="nb">min</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">C</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">aabb</span><span class="p">.</span><span class="nb">max</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="n">C</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">aabb</span><span class="p">.</span><span class="nb">max</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
    <span class="k">if</span>      <span class="p">(</span><span class="n">C</span><span class="p">.</span><span class="n">z</span> <span class="o">&lt;</span> <span class="n">aabb</span><span class="p">.</span><span class="nb">min</span><span class="p">.</span><span class="n">z</span><span class="p">)</span> <span class="n">C</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">aabb</span><span class="p">.</span><span class="nb">min</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">C</span><span class="p">.</span><span class="n">z</span> <span class="o">&gt;</span> <span class="n">aabb</span><span class="p">.</span><span class="nb">max</span><span class="p">.</span><span class="n">z</span><span class="p">)</span> <span class="n">C</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">aabb</span><span class="p">.</span><span class="nb">max</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>

    <span class="c1">// [2] 거리 비교</span>
    <span class="k">return</span> <span class="n">SqrMagnitude</span><span class="p">(</span><span class="n">C</span> <span class="o">-</span> <span class="n">S</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="aabb---1"><strong>[6] AABB 충돌 처리</strong></h2>

  <p><strong>AABB</strong>를 먼지의 반지름만큼 각 면을 확장시켜, 레이캐스트를 통해 검사한다.</p>

  <ul>
    <li><a href="../raycast-to-aabb/">Post : Sphere-AABB Intersection</a></li>
  </ul>

  <p>그리고 <strong>Sphere Collider</strong>와 마찬가지로 반사 벡터를 계산하여</p>

  <p>먼지의 다음 프레임 위치와 속도를 변경 적용한다.</p>

  <details>
    <summary> 
DustCompute.compute
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre></td><td class="rouge-code"><pre><span class="c1">// Box(AABB) Collider에 충돌 검사하여 먼지 위치 및 속도 변경</span>
<span class="c1">// - cur  : 현재 프레임에서의 위치</span>
<span class="c1">// - next : 다음 프레임에서의 위치 [INOUT]</span>
<span class="c1">// - velocity   : 현재 이동 속도   [INOUT]</span>
<span class="c1">// - dustRadius : 먼지 반지름</span>
<span class="c1">// - box        : Box 영역 범위</span>
<span class="c1">// - elasticity : 탄성력 계수(0 ~ 1) : 충돌 시 보존되는 운동량 비율</span>
<span class="kt">void</span> <span class="nf">DustToAABBCollision</span><span class="p">(</span><span class="kt">float3</span> <span class="n">cur</span><span class="p">,</span> <span class="k">inout</span> <span class="kt">float3</span> <span class="n">next</span><span class="p">,</span> <span class="k">inout</span> <span class="kt">float3</span> <span class="n">velocity</span><span class="p">,</span>
<span class="n">float</span> <span class="n">dustRadius</span><span class="p">,</span> <span class="n">Bounds</span> <span class="n">box</span><span class="p">,</span> <span class="n">float</span> <span class="n">elasticity</span><span class="p">,</span> <span class="k">inout</span> <span class="n">bool</span> <span class="n">handled</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/*
        [흐름]
        1. 레이의 xyz 성분 각각 부호를 판단하여 큐브의 평면 후보 6개를 3개로 줄인다.
        2. 레이를 평면 3개(먼지 반지름 고려하여 확장)에 차례로 캐스트하여 접점을 구한다.
        3. 얻은 접점이 각각의 면 범위 내에 있다면 해당 위치를 충돌지점으로 결정한다.
        4. 레이와 속도 벡터에 대해 반사 벡터와 반사 속도를 구한다.
        5. 탄성력을 적용하여 다음 위치와 다음 속도를 결정한다.
    */</span>
    
    <span class="c1">// 먼지 반지름 고려하기</span>
    <span class="kt">float3</span> <span class="n">boxMin</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="nb">min</span> <span class="o">-</span> <span class="n">dustRadius</span><span class="p">;</span>
    <span class="kt">float3</span> <span class="n">boxMax</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="nb">max</span> <span class="o">+</span> <span class="n">dustRadius</span><span class="p">;</span>
    
    <span class="cm">/* 지역변수 */</span>
    <span class="kt">float3</span> <span class="n">ray</span>     <span class="o">=</span> <span class="n">next</span> <span class="o">-</span> <span class="n">cur</span><span class="p">;</span>
    <span class="kt">float3</span> <span class="n">contact</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">half3</span>  <span class="n">raySign</span> <span class="o">=</span> <span class="p">(</span><span class="n">ray</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">int</span>    <span class="n">flag</span>    <span class="o">=</span> <span class="n">FLAG_ERROR</span><span class="p">;</span> <span class="c1">// XYZ 선택 플래그</span>

    <span class="cm">/* 큐브 6면에 캐스트하여 충돌 지점 구하기 */</span>
    <span class="c1">//if(flag == FLAG_ERROR)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">raySign</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">contact</span> <span class="o">=</span> <span class="n">RaycastToPlaneYZ</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">boxMin</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
        <span class="k">else</span>              <span class="n">contact</span> <span class="o">=</span> <span class="n">RaycastToPlaneYZ</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">boxMax</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">InRange2</span><span class="p">(</span><span class="n">contact</span><span class="p">.</span><span class="n">yz</span><span class="p">,</span> <span class="n">boxMin</span><span class="p">.</span><span class="n">yz</span><span class="p">,</span> <span class="n">boxMax</span><span class="p">.</span><span class="n">yz</span><span class="p">))</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">FLAG_X</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="n">FLAG_ERROR</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">raySign</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">contact</span> <span class="o">=</span> <span class="n">RaycastToPlaneXZ</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">boxMin</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
        <span class="k">else</span>              <span class="n">contact</span> <span class="o">=</span> <span class="n">RaycastToPlaneXZ</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">boxMax</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">InRange2</span><span class="p">(</span><span class="n">contact</span><span class="p">.</span><span class="n">xz</span><span class="p">,</span> <span class="n">boxMin</span><span class="p">.</span><span class="n">xz</span><span class="p">,</span> <span class="n">boxMax</span><span class="p">.</span><span class="n">xz</span><span class="p">))</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">FLAG_Y</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="n">FLAG_ERROR</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">raySign</span><span class="p">.</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">contact</span> <span class="o">=</span> <span class="n">RaycastToPlaneXY</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">boxMin</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
        <span class="k">else</span>              <span class="n">contact</span> <span class="o">=</span> <span class="n">RaycastToPlaneXY</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">boxMax</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">InRange2</span><span class="p">(</span><span class="n">contact</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">boxMin</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">boxMax</span><span class="p">.</span><span class="n">xy</span><span class="p">))</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">FLAG_Z</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="cm">/* 최종 계산 */</span>
    <span class="n">float</span> <span class="n">rayLen</span> <span class="o">=</span> <span class="nb">length</span><span class="p">(</span><span class="n">ray</span><span class="p">);</span>
    <span class="n">float</span> <span class="n">inLen</span>  <span class="o">=</span> <span class="nb">length</span><span class="p">(</span><span class="n">contact</span> <span class="o">-</span> <span class="n">cur</span><span class="p">);</span>                 <span class="c1">// 입사 벡터 길이</span>
    <span class="n">float</span> <span class="n">rfLen</span>  <span class="o">=</span> <span class="p">(</span><span class="n">rayLen</span> <span class="o">-</span> <span class="n">inLen</span><span class="p">)</span> <span class="o">*</span> <span class="n">elasticity</span><span class="p">;</span>         <span class="c1">// 반사 벡터 길이(탄성 적용)</span>
    
    <span class="kt">float3</span> <span class="n">rfRay</span> <span class="o">=</span> <span class="n">Reverse</span><span class="p">(</span><span class="n">ray</span><span class="p">,</span> <span class="n">flag</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">rfLen</span> <span class="o">/</span> <span class="n">rayLen</span><span class="p">);</span> <span class="c1">// 반사 벡터</span>
    <span class="kt">float3</span> <span class="n">rfVel</span> <span class="o">=</span> <span class="n">Reverse</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span> <span class="n">flag</span><span class="p">)</span> <span class="o">*</span> <span class="n">elasticity</span><span class="p">;</span>  <span class="c1">// 반사 속도 벡터(탄성 적용)</span>
    
    <span class="cm">/* 변경사항 적용 */</span>
    <span class="n">next</span>     <span class="o">=</span> <span class="n">contact</span> <span class="o">+</span> <span class="n">rfRay</span><span class="p">;</span>
    <span class="n">velocity</span> <span class="o">=</span> <span class="n">rfVel</span><span class="p">;</span>

    <span class="n">handled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="update--"><strong>[7] Update 커널 수정</strong></h2>

  <p><strong>Sphere Collider</strong>와 마찬가지로, 반복문을 이용해 <strong>Box Collider</strong>들의 충돌을 계산한다.</p>

  <p>여기서 한 가지 처리를 더해주는데, 바로 <code class="language-plaintext highlighter-rouge">bool</code> 타입의 <strong>CollisionFlag</strong>이다.</p>

  <p>기존에는 한 프레임 내에서 여러 콜라이더에 의해 충돌이 발생할 수 있었지만</p>

  <p>그렇게 되면 콜라이더가 겹친 위치에서 양측 콜라이더의 충돌 처리에 의해</p>

  <p>서로 반대 방향으로 동일한 속도로 이동하려고 하다보니</p>

  <p>두 방향 중 어느쪽으로도 완전히 이동하지 못하고 제자리에서 무한히 진동하는 현상이 발생한다.</p>

  <p><br /></p>

  <p>따라서 이를 막기 위해 충돌 시 <strong>CollisionFlag</strong>를 <code class="language-plaintext highlighter-rouge">true</code>로 설정하고</p>

  <p>이번 프레임에 충돌 처리가 발생했는지 여부를 검사하여</p>

  <p>한 프레임 내에서는 단 하나의 콜라이더에 의한 충돌이 가능하도록 수정한다.</p>

  <details>
    <summary> 
DustCompute.compute
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="rouge-code"><pre><span class="kt">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">bool</span><span class="o">&gt;</span> <span class="n">collisionFlagBuffer</span><span class="p">;</span> <span class="c1">// 이번 프레임 충돌 처리 여부</span>
<span class="kt">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">Bounds</span><span class="o">&gt;</span> <span class="n">boxColliderBuffer</span><span class="p">;</span>
<span class="n">uint</span> <span class="n">boxColliderCount</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">Update</span> <span class="p">(</span><span class="n">uint3</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="kt">float3</span> <span class="n">currPos</span> <span class="o">=</span> <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">;</span>
    <span class="kt">float3</span> <span class="n">nextPos</span> <span class="o">=</span> <span class="n">currPos</span> <span class="o">+</span> <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">deltaTime</span><span class="p">;</span>

    <span class="c1">// 이번 프레임 충돌 처리 완료 여부 초기화</span>
    <span class="n">collisionFlagBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

    <span class="c1">// [1] Sphere Colliders</span>
    <span class="k">for</span><span class="p">(</span><span class="n">uint</span> <span class="n">scIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">scIndex</span> <span class="o">&lt;</span> <span class="n">sphereColliderCount</span><span class="p">;</span> <span class="n">scIndex</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 이번 프레임에 이미 충돌한 경우, 더이상 충돌 처리하지 않음</span>
        <span class="k">if</span><span class="p">(</span><span class="n">collisionFlagBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
        
        <span class="c1">// ...</span>
    <span class="p">}</span>

    <span class="c1">// [2] Box Colliders</span>
    <span class="k">for</span><span class="p">(</span><span class="n">uint</span> <span class="n">bcIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bcIndex</span> <span class="o">&lt;</span> <span class="n">boxColliderCount</span><span class="p">;</span> <span class="n">bcIndex</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">collisionFlagBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

        <span class="n">Bounds</span> <span class="n">box</span> <span class="o">=</span> <span class="n">boxColliderBuffer</span><span class="p">[</span><span class="n">bcIndex</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="n">CheckBoxIntersection</span><span class="p">(</span><span class="n">nextPos</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">box</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">CalculateBoxCollision</span><span class="p">(</span><span class="n">currPos</span><span class="p">,</span> <span class="n">nextPos</span><span class="p">,</span> <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">radius</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">elasticity</span><span class="p">,</span> <span class="n">collisionFlagBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// [Last] 월드 영역 제한(Box)</span>
    <span class="c1">// ...</span>

    <span class="c1">// 다음 위치 적용</span>
    <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="o">=</span> <span class="n">nextPos</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-54"><strong>[8] 실행 결과</strong></h2>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/138950077-acf1ba33-b4f9-454d-bde3-678ce002c7e0.gif" alt="2021_1018_Box Collision 1" /></p>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/138950087-330f48c1-950b-463b-ab50-2178427655fd.gif" alt="2021_1018_Box Collision_Pyramid" /></p>

  <p><br /></p>

</details>
<!-- --------------------------------------------------------------------------- -->

<h1 id="추가--타임스케일-변경-기능-deltatime-수정">추가 : 타임스케일 변경 기능, deltaTime 수정</h1>
<hr />

<details>
  <summary> 
…
</summary>

  <p><br /></p>

  <h2 id="dustmanager-1"><strong>[1] DustManager</strong></h2>

  <p><code class="language-plaintext highlighter-rouge">DustManager</code> 컴포넌트에 게임 진행 속도를 조절할 수 있는 기능을 추가한다.</p>

  <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="nf">Header</span><span class="p">(</span><span class="s">"Game"</span><span class="p">)]</span>
<span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">1f</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">timescale</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Time</span><span class="p">.</span><span class="n">timeScale</span> <span class="p">=</span> <span class="n">timescale</span><span class="p">;</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>  </div>

  <p><br /></p>

  <h2 id="section-55"><strong>[2] 컴퓨트 쉐이더</strong></h2>

  <p>게임 진행 속도가 다르더라도 물리 시뮬레이션은 일관성 있게 진행되어야 한다.</p>

  <p>지금까지 가속도에 의한 속도 계산은 모두 \(v = a \cdot \Delta t\) 꼴로 작성되어 있는데,</p>

  <p>‘순간적 충격에 의한 속도 변화’의 경우 이는 일관성 없는 결과를 보여주게 된다.</p>

  <p>예를 들어 폭발 기능을 구현하는 <code class="language-plaintext highlighter-rouge">Explode</code> 커널의 경우</p>

  <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">Explode</span> <span class="p">(</span><span class="n">uint3</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">sqrDist</span> <span class="o">&lt;</span> <span class="n">explosionSqrRange</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="kt">float3</span> <span class="n">F</span> <span class="o">=</span> <span class="n">dir</span> <span class="o">*</span> <span class="n">f</span><span class="p">;</span>
        <span class="kt">float3</span> <span class="n">A</span> <span class="o">=</span> <span class="n">F</span> <span class="o">/</span> <span class="n">mass</span><span class="p">;</span>
        <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">A</span> <span class="o">*</span> <span class="n">deltaTime</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>  </div>

  <p>위와 같이 <code class="language-plaintext highlighter-rouge">Δv = a * deltaTime</code> 꼴인데,</p>

  <p>이건 사실 타임스케일 변동이 없더라도 문제가 될수 있는 부분이다.</p>

  <p>게임 루프의 <code class="language-plaintext highlighter-rouge">deltaTime</code>에 의존하기 때문에</p>

  <p>극단적인 예시로 <code class="language-plaintext highlighter-rouge">deltaTime = 0.0001</code>인 경우에 <code class="language-plaintext highlighter-rouge">Explode</code>가 발생하면</p>

  <p>먼지는 아주 미세하게 움직일 수 있다.</p>

  <p><br /></p>

  <p>따라서 순간적 충격이 발생하는 물리 연산의 경우,</p>

  <p><code class="language-plaintext highlighter-rouge">deltaTime</code> 대신 고정된 임의의 <code class="language-plaintext highlighter-rouge">Δt</code>를 정의하여 사용하도록 한다.</p>

  <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="cp">#define CONSTANT_DELTA_TIME 0.02
</span></pre></td></tr></tbody></table></code></div>  </div>

  <p><br /></p>

  <p>현재 물리 연산을 구현하는 커널 목록은 다음과 같다.</p>

  <ol>
    <li><code class="language-plaintext highlighter-rouge">Update()</code>   : 프레임 기반 실시간 가속도/속도/이동 계산</li>
    <li><code class="language-plaintext highlighter-rouge">VacuumUp()</code> : 원뿔 범위 먼지 흡수</li>
    <li><code class="language-plaintext highlighter-rouge">Emit()</code>     : 먼지 방출(발사)</li>
    <li><code class="language-plaintext highlighter-rouge">BlowWind()</code> : 먼지 밀쳐내기</li>
    <li><code class="language-plaintext highlighter-rouge">Explode()</code>  : 구형 범위 순간 폭발</li>
  </ol>

  <p><br /></p>

  <p>이 중에서 일시적인 가속에 의한 순간 속도 변화가 발생하는 커널은</p>

  <p><code class="language-plaintext highlighter-rouge">Emit</code>, <code class="language-plaintext highlighter-rouge">BlowWind</code>, <code class="language-plaintext highlighter-rouge">Explode</code> 커널로,</p>

  <p>해당 커널 함수들 내의 <code class="language-plaintext highlighter-rouge">A * deltaTime</code> 계산을 모두 <code class="language-plaintext highlighter-rouge">A * CONST_DELTA_TIME</code>으로 변경한다.</p>

  <p><br /></p>

  <h2 id="section-56"><strong>[3] 실행 결과</strong></h2>

  <h3 id="deltatime-timescale--1"><strong>[3-1] deltaTime, timescale = 1</strong></h3>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/139041660-eb69832c-ef26-4524-b461-22159aec9c0d.gif" alt="2021_1027_Explode_Timescale_1" /></p>

  <h3 id="deltatime-timescale--02"><strong>[3-2] deltaTime, timescale = 0.2</strong></h3>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/139041670-6244e9dd-5062-40a8-a89a-c7269f026812.gif" alt="2021_1027_Explode_Timescale_0_2" /></p>

  <h3 id="constdeltatime-timescale--02"><strong>[3-3] CONST_DELTA_TIME, timescale = 0.2</strong></h3>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/139041677-0dfa2820-d56b-41b5-99eb-b2b54afc710e.gif" alt="2021_1027_Explode_Timescale_0_2_cons" /></p>

  <p><br /></p>

</details>
<!-- --------------------------------------------------------------------------- -->

<h1 id="17-boxobb-collision-구현">17. Box(OBB) Collision 구현</h1>
<hr />

<details>
  <summary> 
…
</summary>

  <p><br /></p>

  <h2 id="obb"><strong>[1] OBB란?</strong></h2>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/140696122-54d720a7-89a5-40ab-a8e5-d67e3733e556.png" alt="image" /></p>

  <p><strong>OBB</strong>는 <strong>Oriented Bounding Box</strong>의 약자로,</p>

  <p><strong>AABB</strong>처럼 마주보는 두 면끼리는 서로 평행하지만</p>

  <p>모든 면이 공간의 축에 평행한 <strong>AABB</strong>와는 다르게 자유롭게 회전이 적용된 상자의 형태를 지닌다.</p>

  <p>쉽게 말해, 회전 변환이 적용된 <strong>AABB</strong>라고 보면 된다.</p>

  <p><br /></p>

  <h2 id="obb---"><strong>[2] OBB 충돌 구현 방법</strong></h2>

  <p><strong>OBB</strong>는 <strong>AABB</strong>보다 구현이 어렵다.</p>

  <p>특히나 3차원에서는 2차원보다 더 어렵고 번거롭다.</p>

  <p>그래서 이걸 비교적 간단하게 구현할 수 있는 방법이 있는데,</p>

  <p>바로 공간 변환을 이용하는 것이다.</p>

  <p><br /></p>

  <p>큐브의 기본 형태는 중심 좌표가 <code class="language-plaintext highlighter-rouge">(0, 0, 0)</code>, 모든 모서리의 길이가 <code class="language-plaintext highlighter-rouge">1</code>인 <strong>AABB</strong>이다.</p>

  <p>모든 <strong>OBB</strong>는 이 기본 큐브를 위치, 회전, 크기 변환을 수행하여 만들 수 있다.</p>

  <p>그러므로 <strong>OBB</strong> 충돌체의 데이터는 변환 행렬만 있으면 된다.</p>

  <p><br /></p>

  <p>먼지를 <strong>AABB</strong>에 충돌시킬 때,</p>

  <p>입력은 현재 프레임의 먼지 위치 벡터, 다음 프레임의 먼지 위치 벡터, 속도 벡터,</p>

  <p>출력은 다음 프레임의 먼지 위치 벡터, 속도 벡터다.</p>

  <p>세 개의 입력 벡터를 월드-로컬 공간 변환하여 콜라이더의 로컬 공간에서 <strong>AABB</strong> 충돌을 계산하고,</p>

  <p>얻어낸 두 개의 출력 벡터를 다시 로컬-월드 공간변환하는 방식으로</p>

  <p>기존의 <strong>AABB</strong> 충돌 계산을 이용해 <strong>OBB</strong> 충돌을 구현할 수 있다.</p>

  <p><br /></p>

  <h2 id="section-57"><strong>[3] 클래스 수정</strong></h2>

  <p>제네릭으로 구현했던 <code class="language-plaintext highlighter-rouge">ColliderSet</code> 클래스에서 제네릭을 제거한다.</p>

  <p>대신 모든 콜라이더가 컴퓨트 버퍼로 전달할 데이터를 변환 행렬로 통일한다.</p>

  <p>컴퓨트 쉐이더의 각 스레드에서 매번 역행렬을 계산하는 것은 굉장히 손해이므로,</p>

  <p>로컬-월드 변환 행렬과 월드-로컬 변환 행렬을 모두 전달한다.</p>

  <p>그리고 충돌을 계산하는 콜라이더의 로컬 공간에서 먼지의 스케일을 재조정할 필요가 있는데,</p>

  <p>변환 행렬에서 스케일을 따로 추출하기 위해 계산하는 것 역시 손해이므로 스케일 값도 함께 전달한다.</p>

  <p><br /></p>

  <details>
    <summary>
ColliderSet.cs
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
</pre></td><td class="rouge-code"><pre><span class="k">private</span> <span class="k">class</span> <span class="nc">ColliderSet</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">struct</span> <span class="nc">ColliderData</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="n">Matrix4x4</span> <span class="n">localToWorld</span><span class="p">;</span>
        <span class="k">public</span> <span class="n">Matrix4x4</span> <span class="n">worldToLocal</span><span class="p">;</span>
        <span class="k">public</span> <span class="n">Vector3</span> <span class="n">scale</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">ColliderData</span><span class="p">(</span><span class="n">DustCollider</span> <span class="n">collider</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">localToWorld</span> <span class="p">=</span> <span class="n">collider</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">localToWorldMatrix</span><span class="p">;</span>
            <span class="n">worldToLocal</span> <span class="p">=</span> <span class="n">collider</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">worldToLocalMatrix</span><span class="p">;</span>
            <span class="n">scale</span> <span class="p">=</span> <span class="n">collider</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">lossyScale</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* Collider */</span>
    <span class="k">private</span> <span class="n">ComputeBuffer</span> <span class="n">colliderBuffer</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">DustCollider</span><span class="p">&gt;</span> <span class="n">colliders</span><span class="p">;</span>

    <span class="cm">/* Data */</span>
    <span class="k">private</span> <span class="n">ColliderData</span><span class="p">[]</span> <span class="n">dataArray</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">int</span> <span class="n">dataCount</span><span class="p">;</span>

    <span class="cm">/* Compute Shader, Compute Buffer */</span>
    <span class="k">private</span> <span class="n">ComputeShader</span> <span class="n">computeShader</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">int</span> <span class="n">shaderKernel</span><span class="p">;</span> <span class="c1">// Update Kernel</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="n">bufferName</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="n">countVariableName</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">ColliderSet</span><span class="p">(</span><span class="n">ComputeShader</span> <span class="n">computeShader</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shaderKernel</span><span class="p">,</span> <span class="kt">string</span> <span class="n">bufferName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">countVariableName</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">colliders</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">DustCollider</span><span class="p">&gt;(</span><span class="m">4</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="n">dataArray</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ColliderData</span><span class="p">[</span><span class="m">4</span><span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="n">computeShader</span> <span class="p">=</span> <span class="n">computeShader</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">shaderKernel</span> <span class="p">=</span> <span class="n">shaderKernel</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">bufferName</span> <span class="p">=</span> <span class="n">bufferName</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">countVariableName</span> <span class="p">=</span> <span class="n">countVariableName</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">dataCount</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

        <span class="n">colliderBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">4</span><span class="p">);</span> <span class="c1">// 기본 값</span>
        <span class="n">computeShader</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">shaderKernel</span><span class="p">,</span> <span class="n">bufferName</span><span class="p">,</span> <span class="n">colliderBuffer</span><span class="p">);</span>
        <span class="n">computeShader</span><span class="p">.</span><span class="nf">SetInt</span><span class="p">(</span><span class="n">countVariableName</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="p">~</span><span class="nf">ColliderSet</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nf">ReleaseBuffer</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">ReleaseBuffer</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">colliderBuffer</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="n">colliderBuffer</span><span class="p">.</span><span class="nf">Release</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">ExpandDataArray</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">ColliderData</span><span class="p">[]</span> <span class="n">newArray</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ColliderData</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="n">dataArray</span><span class="p">.</span><span class="n">Length</span> <span class="p">*</span> <span class="m">2</span><span class="p">];</span>
        <span class="n">Array</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">dataArray</span><span class="p">,</span> <span class="n">newArray</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">dataArray</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="n">dataArray</span> <span class="p">=</span> <span class="n">newArray</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt; 컴퓨트 버퍼의 데이터를 새롭게 갱신하고 컴퓨트 쉐이더에 전달 &lt;/summary&gt;</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">ReallocateBuffer</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nf">ReleaseBuffer</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dataCount</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

        <span class="n">colliderBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="n">dataCount</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="p">*</span> <span class="m">35</span><span class="p">);</span>
        <span class="n">computeShader</span><span class="p">.</span><span class="nf">SetInt</span><span class="p">(</span><span class="n">countVariableName</span><span class="p">,</span> <span class="n">dataCount</span><span class="p">);</span>
        <span class="nf">UpdateColliderData</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt; 배열 내부의 콜라이더 데이터만 갱신하여 컴퓨트 쉐이더에 전달 &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">UpdateColliderData</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dataArray</span><span class="p">.</span><span class="n">Length</span> <span class="p">&lt;</span> <span class="n">dataCount</span><span class="p">)</span>
            <span class="nf">ExpandDataArray</span><span class="p">();</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">dataCount</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="n">dataArray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ColliderData</span><span class="p">(</span><span class="n">colliders</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="n">colliderBuffer</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="n">dataArray</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">dataCount</span><span class="p">);</span>
        <span class="n">computeShader</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">shaderKernel</span><span class="p">,</span> <span class="n">bufferName</span><span class="p">,</span> <span class="n">colliderBuffer</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">AddCollider</span><span class="p">(</span><span class="n">DustCollider</span> <span class="n">collider</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">colliders</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">collider</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

        <span class="n">dataCount</span><span class="p">++;</span>
        <span class="n">colliders</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">collider</span><span class="p">);</span>
        <span class="nf">ReallocateBuffer</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">RemoveCollider</span><span class="p">(</span><span class="n">DustCollider</span> <span class="n">collider</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">colliders</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">collider</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

        <span class="n">dataCount</span><span class="p">--;</span>
        <span class="n">colliders</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="n">collider</span><span class="p">);</span>
        <span class="nf">ReallocateBuffer</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <details>
    <summary>
DustManager.cs
</summary>

    <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="k">private</span> <span class="n">ColliderSet</span> <span class="n">sphereColliderSet</span><span class="p">;</span>
<span class="k">private</span> <span class="n">ColliderSet</span> <span class="n">boxColliderSet</span><span class="p">;</span>

<span class="c1">/// &lt;summary&gt; ColliderSet에 새로운 Collider 추가 &lt;/summary&gt;</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">AddCollider</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">ColliderSet</span><span class="p">&gt;</span> <span class="n">getter</span><span class="p">,</span> <span class="n">DustCollider</span> <span class="n">collider</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">colSet</span> <span class="p">=</span> <span class="nf">getter</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">colSet</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">afterInitJobQueue</span><span class="p">.</span><span class="nf">Enqueue</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nf">getter</span><span class="p">().</span><span class="nf">AddCollider</span><span class="p">(</span><span class="n">collider</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">colSet</span><span class="p">.</span><span class="nf">AddCollider</span><span class="p">(</span><span class="n">collider</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">/// &lt;summary&gt; ColliderSet의 내부 컴퓨트 버퍼 갱신 &lt;/summary&gt;</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateCollider</span><span class="p">(</span><span class="n">ColliderSet</span> <span class="k">set</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">set</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="k">set</span><span class="p">.</span><span class="nf">UpdateColliderData</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">/// &lt;summary&gt; ColliderSet에서 Collider 제거 &lt;/summary&gt;</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">RemoveCollider</span><span class="p">(</span><span class="n">ColliderSet</span> <span class="k">set</span><span class="p">,</span> <span class="n">DustCollider</span> <span class="n">collider</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">set</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="k">set</span><span class="p">.</span><span class="nf">RemoveCollider</span><span class="p">(</span><span class="n">collider</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-58"><strong>[4] 컴퓨트 쉐이더 수정</strong></h2>

  <details>
    <summary>
DustCompute.compute
</summary>

    <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">ColliderTransform</span>
<span class="p">{</span>
    <span class="kt">float4x4</span> <span class="n">localToWorld</span><span class="p">;</span>
    <span class="kt">float4x4</span> <span class="n">worldToLocal</span><span class="p">;</span>
    <span class="kt">float3</span> <span class="n">scale</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">ColliderTransform</span><span class="o">&gt;</span> <span class="n">sphereColliderBuffer</span><span class="p">;</span>
<span class="n">uint</span> <span class="n">sphereColliderCount</span><span class="p">;</span>

<span class="kt">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">ColliderTransform</span><span class="o">&gt;</span> <span class="n">boxColliderBuffer</span><span class="p">;</span>
<span class="n">uint</span> <span class="n">boxColliderCount</span><span class="p">;</span>

<span class="c1">// AABB로 근사시킨 먼지를 기본 AABB(-0.5 ~ 0.5)와 교차 검사</span>
<span class="n">bool</span> <span class="nf">DustToDefaultAABBIntersection</span><span class="p">(</span><span class="kt">float3</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">float3</span> <span class="n">scale</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">scale</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">scale</span><span class="p">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">scale</span><span class="p">.</span><span class="n">z</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">scale</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span>  <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">scale</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;</span>  <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">scale</span><span class="p">.</span><span class="n">z</span> <span class="o">&gt;</span>  <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">Update</span> <span class="p">(</span><span class="n">uint3</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="kt">float3</span> <span class="n">currPos</span> <span class="o">=</span> <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">;</span>
    <span class="kt">float3</span> <span class="n">nextPos</span> <span class="o">=</span> <span class="n">currPos</span> <span class="o">+</span> <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">deltaTime</span><span class="p">;</span>

    <span class="c1">// 이번 프레임 충돌 처리 완료 여부 초기화</span>
    <span class="n">collisionFlagBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

    <span class="c1">// [1] Sphere Colliders</span>
    <span class="k">for</span><span class="p">(</span><span class="n">uint</span> <span class="n">scIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">scIndex</span> <span class="o">&lt;</span> <span class="n">sphereColliderCount</span><span class="p">;</span> <span class="n">scIndex</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">collisionFlagBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

        <span class="kt">float4</span> <span class="n">sphere</span><span class="p">;</span>
        <span class="n">sphere</span><span class="p">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="nb">mul</span><span class="p">(</span><span class="n">sphereColliderBuffer</span><span class="p">[</span><span class="n">scIndex</span><span class="p">].</span><span class="n">localToWorld</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="n">xyz</span><span class="p">;</span>
        <span class="n">sphere</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">sphereColliderBuffer</span><span class="p">[</span><span class="n">scIndex</span><span class="p">].</span><span class="n">scale</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="n">SphereToSphereIntersection</span><span class="p">(</span><span class="kt">float4</span><span class="p">(</span><span class="n">nextPos</span><span class="p">,</span> <span class="n">radius</span><span class="p">),</span> <span class="n">sphere</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">DustToSphereCollision</span><span class="p">(</span><span class="n">currPos</span><span class="p">,</span> <span class="n">nextPos</span><span class="p">,</span> <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">radius</span><span class="p">,</span> <span class="n">sphere</span><span class="p">,</span> <span class="n">bounciness</span><span class="p">,</span> <span class="n">collisionFlagBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// [2] Box Colliders(OBB)</span>
    <span class="k">for</span><span class="p">(</span><span class="n">uint</span> <span class="n">bcIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bcIndex</span> <span class="o">&lt;</span> <span class="n">boxColliderCount</span><span class="p">;</span> <span class="n">bcIndex</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">collisionFlagBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
    
        <span class="n">Bounds</span> <span class="n">box</span> <span class="o">=</span> <span class="n">DEFAULT_BOX_COLLIDER</span><span class="p">;</span>
        <span class="kt">float4x4</span> <span class="n">WtL</span> <span class="o">=</span> <span class="n">boxColliderBuffer</span><span class="p">[</span><span class="n">bcIndex</span><span class="p">].</span><span class="n">worldToLocal</span><span class="p">;</span>
        
        <span class="kt">float3</span> <span class="n">localNextPos</span>    <span class="o">=</span> <span class="nb">mul</span><span class="p">(</span><span class="n">WtL</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">nextPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="n">xyz</span><span class="p">;</span>

        <span class="c1">// 박스 로컬 스페이스에서의 먼지 스케일 계산</span>
        <span class="kt">float3</span> <span class="n">localDustRadius</span> <span class="o">=</span> <span class="n">radius</span><span class="p">.</span><span class="n">xxx</span> <span class="o">/</span> <span class="n">boxColliderBuffer</span><span class="p">[</span><span class="n">bcIndex</span><span class="p">].</span><span class="n">scale</span><span class="p">;</span>
        
        <span class="c1">// 박스 콜라이더의 로컬 스페이스에서 먼지 교차 검사(AABB-AABB)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">DustToDefaultAABBIntersection</span><span class="p">(</span><span class="n">localNextPos</span><span class="p">,</span> <span class="n">localDustRadius</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="kt">float3</span> <span class="n">localCurrPos</span>  <span class="o">=</span> <span class="nb">mul</span><span class="p">(</span><span class="n">WtL</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">currPos</span><span class="p">,</span>           <span class="mi">1</span><span class="p">)).</span><span class="n">xyz</span><span class="p">;</span>
            <span class="kt">float3</span> <span class="n">localVelocity</span> <span class="o">=</span> <span class="nb">mul</span><span class="p">(</span><span class="n">WtL</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">)).</span><span class="n">xyz</span><span class="p">;</span>

            <span class="c1">// 박스 콜라이더의 로컬 스페이스에서 충돌 처리</span>
            <span class="n">DustToAABBCollision</span><span class="p">(</span><span class="n">localCurrPos</span><span class="p">,</span> <span class="n">localNextPos</span><span class="p">,</span> <span class="n">localVelocity</span><span class="p">,</span> <span class="n">localDustRadius</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">bounciness</span><span class="p">,</span> <span class="n">collisionFlagBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
            
            <span class="kt">float4x4</span> <span class="n">LtW</span> <span class="o">=</span> <span class="n">boxColliderBuffer</span><span class="p">[</span><span class="n">bcIndex</span><span class="p">].</span><span class="n">localToWorld</span><span class="p">;</span>
            <span class="n">nextPos</span>           <span class="o">=</span> <span class="nb">mul</span><span class="p">(</span><span class="n">LtW</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">localNextPos</span><span class="p">,</span>  <span class="mi">1</span><span class="p">)).</span><span class="n">xyz</span><span class="p">;</span>
            <span class="n">velocityBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">mul</span><span class="p">(</span><span class="n">LtW</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">localVelocity</span><span class="p">,</span> <span class="mi">0</span><span class="p">)).</span><span class="n">xyz</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// [Last] 월드 영역 제한(Box)</span>
    <span class="c1">// ...</span>

    <span class="c1">// 다음 위치 적용</span>
    <span class="n">dustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="o">=</span> <span class="n">nextPos</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>

  </details>

  <p><br /></p>

  <h2 id="section-59"><strong>[5] 실행 결과</strong></h2>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/139092386-6106f21b-a9f0-4d30-9086-8fdd3f65c478.gif" alt="2021_1027_OBB_02" /></p>

  <p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/139092392-1076ca4a-1b26-479c-9935-ff4e13cd13a8.gif" alt="2021_1027_OBB_03" /></p>

  <p><br /></p>

</details>
<!-- --------------------------------------------------------------------------- -->

<h1 id="0-글로벌-효과-구현">0. 글로벌 효과 구현</h1>
<hr />

<details>
  <summary> 
…
</summary>

  <p><br /></p>

  <ul>
    <li>월드 내에 존재하는 모든 먼지에 적용되는 효과</li>
    <li>바람</li>
    <li>용권풍</li>
    <li>..</li>
  </ul>

  <p><br /></p>

</details>
<!-- --------------------------------------------------------------------------- -->

<h1 id="0-조작-개선">0. 조작 개선</h1>
<hr />

<details>
  <summary> 
…
</summary>

  <p><br /></p>

  <ul>
    <li>WASD  이동</li>
    <li>Shift 달리기</li>
    <li>Ctrl  하강</li>
    <li>Space 상승</li>
    <li>Tab   모드 변경(흡수/방출/폭발 투사체), 원뿔 색상도 변경(Cyan/Yellow)/원기둥(Red)?</li>
    <li>Q/E   각도 변경</li>
    <li>Z/C   힘 변경</li>
    <li>
      <p>ESC   옵션 GUI 표시/미표시</p>
    </li>
    <li>옵션을 모두 조절할 수 있는 GUI 제공</li>
    <li>중력을 3D로 조절할 수 있게 변경</li>
  </ul>

  <p><br /></p>

</details>
<!-- --------------------------------------------------------------------------- -->

<h1 id="0-예쁘게-만들기">0. 예쁘게 만들기</h1>
<hr />

<details>
  <summary> 
…
</summary>

  <p><br /></p>

  <ul>
    <li>예쁜 방 꾸미기</li>
    <li>예쁜 모델링 적용하기</li>
    <li>미니 게임 만들기</li>
  </ul>

  <p><br /></p>

</details>
<!-- --------------------------------------------------------------------------- -->

<h1 id="github-link">Github Link</h1>
<hr />
<ul>
  <li><a href="https://github.com/rito15/Unity-Million-Dust">https://github.com/rito15/Unity-Million-Dust</a></li>
</ul>

<p><br /></p>

<!-- --------------------------------------------------------------------------- -->

<h1 id="references">References</h1>
<hr />
<ul>
  <li><a href="https://www.youtube.com/watch?v=PGk0rnyTa1U">https://www.youtube.com/watch?v=PGk0rnyTa1U</a></li>
  <li><a href="https://docs.unity3d.com/ScriptReference/Graphics.DrawMeshInstancedIndirect.html">https://docs.unity3d.com/ScriptReference/Graphics.DrawMeshInstancedIndirect.html</a></li>
  <li><a href="https://github.com/ColinLeung-NiloCat/UnityURP-MobileDrawMeshInstancedIndirectExample">https://github.com/ColinLeung-NiloCat/UnityURP-MobileDrawMeshInstancedIndirectExample</a></li>
</ul>

<!-- 
https://github.com/SebLague/Super-Chore-Man/blob/main/Assets/Scripts/Particles/DustCompute.compute
-->

<!-- 복붙


## **[1] 컴퓨트 쉐이더**

<details>
<summary markdown="span"> 
DustCompute.compute
</summary>

```hlsl

```

</details>

<br>


## **[2] 먼지 관리 컴포넌트**

<details>
<summary markdown="span"> 
DustManager.cs
</summary>

```cs

```

</details>

<br>


## **[3] 실행 결과**



<br>



-->


      </div>

      <div class="post-tail-wrapper text-muted">

        <!-- categories -->
        
        <div class="post-meta mb-3">
          <i class="far fa-folder-open fa-fw mr-1"></i>
          
            <a href='/categories/unity/'>Unity</a>,
            <a href='/categories/unity-study/'>Unity Study</a>
        </div>
        

        <!-- tags -->
        
        <div class="post-tags">
          <i class="fa fa-tags fa-fw mr-1"></i>
          
          <a href="/tags/unity/"
            class="post-tag no-text-decoration" >unity</a>
          
          <a href="/tags/csharp/"
            class="post-tag no-text-decoration" >csharp</a>
          
          </div>
        

        <div class="post-tail-bottom
          d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
          
          <div class="license-wrapper">
            This post is licensed under
            <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>
            by the author.
          </div>
          

          <!--
 Post sharing snippet

 v2.1
 https://github.com/cotes2020/jekyll-theme-chirpy
 © 2019 Cotes Chung
 Published under the MIT License
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons">
    
    

    
      
        <a href="https://twitter.com/intent/tweet?text=유니티 - 물리 기반 먼지 시뮬레이션 - Rito15&url=https://rito15.github.io/posts/unity-million-dust-simulation/" data-toggle="tooltip" data-placement="top"
          title="Twitter" target="_blank" rel="noopener" aria-label="Twitter">
          <i class="fa-fw fab fa-twitter"></i>
        </a>
    
      
        <a href="https://www.facebook.com/sharer/sharer.php?title=유니티 - 물리 기반 먼지 시뮬레이션 - Rito15&u=https://rito15.github.io/posts/unity-million-dust-simulation/" data-toggle="tooltip" data-placement="top"
          title="Facebook" target="_blank" rel="noopener" aria-label="Facebook">
          <i class="fa-fw fab fa-facebook-square"></i>
        </a>
    
      
        <a href="https://telegram.me/share?text=유니티 - 물리 기반 먼지 시뮬레이션 - Rito15&url=https://rito15.github.io/posts/unity-million-dust-simulation/" data-toggle="tooltip" data-placement="top"
          title="Telegram" target="_blank" rel="noopener" aria-label="Telegram">
          <i class="fa-fw fab fa-telegram"></i>
        </a>
    

    <i class="fa-fw fas fa-link small" onclick="copyLink()"
        data-toggle="tooltip" data-placement="top" title="Copy link"></i>

  </span>
</div>


        </div><!-- .post-tail-bottom -->

      </div><!-- div.post-tail -->

    </div> <!-- .post -->


  </div> <!-- #post-wrapper -->

  

  

  <!--
  The Pannel on right side (Desktop views)
  v2.0
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2017-2019 Cotes Chung
  MIT License
-->

<div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down">

  <div class="access">

  














  

    <div id="access-lastmod" class="post">
      <span>Recent Update</span>
      <ul class="post-content pl-0 pb-1 ml-1 mt-2">

      
        
        
        
        <li><a href="/posts/unity-rigidbody-move-and-jump/">유니티 - 키보드 입력을 통한 리지드바디 이동, 회전, 점프 기본 코드</a></li>
      
        
        
        
        <li><a href="/posts/cs-string-stringbuilder-and-zstring/">C# String, StringBuilder, ZString</a></li>
      
        
        
        
        <li><a href="/posts/unity-infinite-horizontal-scroll-ui/">Infinite Horizontal Scroll (무한 횡스크롤) UI</a></li>
      
        
        
        
        <li><a href="/posts/unity-memo-useful-links/">유니티 - 유용한 정보, 링크 모음</a></li>
      
        
        
        
        <li><a href="/posts/unity-quaternion/">유니티 - Quaternion</a></li>
      

      </ul>
    </div> <!-- #access-lastmod -->

  

  















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  
    <div id="access-tags">
      <span>Trending Tags</span>
      <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

      
        
        <a class="post-tag" href="/tags/csharp/">csharp</a>
      
        
        <a class="post-tag" href="/tags/unity/">unity</a>
      
        
        <a class="post-tag" href="/tags/editor/">editor</a>
      
        
        <a class="post-tag" href="/tags/shader/">shader</a>
      
        
        <a class="post-tag" href="/tags/memo/">memo</a>
      
        
        <a class="post-tag" href="/tags/graphics/">graphics</a>
      
        
        <a class="post-tag" href="/tags/opengl/">opengl</a>
      
        
        <a class="post-tag" href="/tags/thread/">thread</a>
      
        
        <a class="post-tag" href="/tags/amplify/">amplify</a>
      
        
        <a class="post-tag" href="/tags/plugin/">plugin</a>
      

      </div>
    </div>
  
  </div> <!-- .access -->

  
    <div id="toc-wrapper" class="pl-0 pr-4 mb-5">
      <span class="pl-3 pt-2 mb-2">Contents</span>
      <nav id="toc" data-toggle="toc"></nav>
    </div>
  

</div> <!-- #panel-wrapper -->


</div> <!-- .row -->

<div class="row">
  <div class="col-12 col-lg-11 col-xl-8">
    <div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

    <!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.

 v2.0
 https://github.com/cotes2020/jekyll-theme-chirpy
 © 2019 Cotes Chung
 Published under the MIT License
-->

<!-- The total size of related posts  -->


<!-- An random integer that bigger than 0  -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy}  -->








  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  
    
  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  








<!-- Fill with the other newlest posts  -->






  <div id="related-posts" class="mt-5 mb-2 mb-sm-4">
    <h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3>
    <div class="card-deck mb-4">
    
      
      
      <div class="card">
        <a href="/posts/unity-serialize-tree-object/">
          <div class="card-body">
            <!--
  Date format snippet

  v2.4.1
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2020 Cotes Chung
  MIT License
-->
<span class="timeago small"
  >

  
  

  
    Sep  6
  

  <i class="unloaded">2021-09-06T23:23:00+09:00</i>

</span>
            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>유니티 - 트리 구조 데이터 직렬화하기</h3>
            <div class="text-muted small">
              <p>
                





                트리(Tree) 자료구조


1
2
3
4
class TreeNode
{
    public TreeNode[] children;
}


위와 같이 자기 타입의 배열 또는 컬렉션을 필드로 갖는 구조를 트리 자료구조라고 한다.

자식 및 하위 노드들을 순회하기 위해 재귀적 호출을 많이 사용한다.





직렬화(Serialization)


데이터를 저...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/behavior-tree/">
          <div class="card-body">
            <!--
  Date format snippet

  v2.4.1
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2020 Cotes Chung
  MIT License
-->
<span class="timeago small"
  >

  
  

  
    Jan  5
  

  <i class="unloaded">2021-01-05T00:26:00+09:00</i>

</span>
            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>유니티 - 비헤이비어 트리(Behavior Tree)</h3>
            <div class="text-muted small">
              <p>
                





                개념


  FSM (Finite State Machine)의 단점을 보완하기 위해 만들어진 기법
  FSM에서는 상태 전이 조건을 모두 각각의 상태에서 검사하지만, BT에서는 상태 동작 뿐만 아니라 전이 조건도 노드로 관리한다.
  노드 그래프를 통해 시각화하거나 params, 빌더 패턴 등을 활용하여 스크립트 내에서도 가독성 좋게 구성할 수 있다....
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/ray-marching/">
          <div class="card-body">
            <!--
  Date format snippet

  v2.4.1
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2020 Cotes Chung
  MIT License
-->
<span class="timeago small"
  >

  
  

  
    Jan 19
  

  <i class="unloaded">2021-01-19T23:15:00+09:00</i>

</span>
            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>레이 마칭(Ray Marching)</h3>
            <div class="text-muted small">
              <p>
                





                레이 마칭이란?



  
    메시 데이터를 이용하는 기존의 3D 렌더링 방식과는 달리, 거리 함수(SDF)를 통해 오브젝트의 표면을 정의한다.
  
  
    카메라로부터 스크린 픽셀들을 향해 레이를 전진시키고(Ray Marching), 해당 픽셀의 레이가 오브젝트 표면에 닿으면 그 픽셀에 오브젝트 표면을 렌더링하는 방식을 사용한다.
  


...
              </p>
            </div>
          </div>
        </a>
      </div>
    
    </div> <!-- .card-deck -->
  </div> <!-- #related-posts -->



    <!--
  Navigation buttons at the bottom of the post.

  v2.1
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2020 Cotes Chung
  MIT License
-->

<div class="post-navigation d-flex justify-content-between">
  
  <a href="/posts/unity-shader-random-functions/" class="btn btn-outline-primary">
    <p>유니티 쉐이더 - 랜덤 함수들</p>
  </a>
  

  
  <a href="/posts/unity-srgb-linear-gamma-color-space/" class="btn btn-outline-primary">
    <p>유니티 - sRGB, Linear, Gamma 컬러 스페이스</p>
  </a>
  

</div>

    

    </div> <!-- #post-extend-wrapper -->

  </div> <!-- .col-* -->

</div> <!-- .row -->



<script>
/* 코드 블록 우측 상단 Copy 버튼 */
const codes = document.querySelectorAll('.code-button-header + .highlighter-rouge .rouge-code');
const copyCodeButtons = document.querySelectorAll('.copy-code-button');

copyCodeButtons.forEach((copyCodeButton, index) => {
  copyCodeButton.addEventListener('click', () => {
    window.navigator.clipboard.writeText(codes[index].innerText.slice(0, -1));
    copyCodeButton.classList.add('copied');

    setTimeout(() => {
      copyCodeButton.classList.remove('copied');
    }, 2000);
  });
});
</script>


  <!-- image lazy load: https://github.com/ApoorvSaxena/lozad.js -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script>

<script type="text/javascript">
  const imgs = document.querySelectorAll('.post-content img');
  const observer = lozad(imgs);
  observer.observe();
</script>




        <!--
  The Footer
  v2.0
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2017-2019 Cotes Chung
  MIT License
-->

<footer class="d-flex w-100 justify-content-center">
  <div class="d-flex justify-content-between align-items-center">
    <div class="footer-left">
      <p class="mb-0">
        © 2021
        <a href="https://github.com/rito15">Rito15</a>.
        
        <span data-toggle="tooltip" data-placement="top"
          title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span>
        
      </p>
    </div>

    <div class="footer-right">
      <p class="mb-0">
        Powered by
        <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
        with
        <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a>
        theme.
      </p>
    </div>

  </div> <!-- div.d-flex -->
</footer>


      </div>

      <!--
  The Search results
  v2.0
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2017-2019 Cotes Chung
  MIT License
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-xl-11 post-content">
    <div id="search-hints">
      <h4 class="text-muted mb-4">Trending Tags</h4>

      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



      
        
        <a class="post-tag" href="/tags/csharp/">csharp</a>
      
        
        <a class="post-tag" href="/tags/unity/">unity</a>
      
        
        <a class="post-tag" href="/tags/editor/">editor</a>
      
        
        <a class="post-tag" href="/tags/shader/">shader</a>
      
        
        <a class="post-tag" href="/tags/memo/">memo</a>
      
        
        <a class="post-tag" href="/tags/graphics/">graphics</a>
      
        
        <a class="post-tag" href="/tags/opengl/">opengl</a>
      
        
        <a class="post-tag" href="/tags/thread/">thread</a>
      
        
        <a class="post-tag" href="/tags/amplify/">amplify</a>
      
        
        <a class="post-tag" href="/tags/plugin/">plugin</a>
      

    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    
      <!--
  mermaid-js loader
-->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
  $(function() {
    let initTheme = "default";

    if ($("html[mode=dark]").length > 0
      || ($("html[mode]").length == 0
        && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) {
      initTheme = "dark";
    }

    let mermaidConf = {
      theme: initTheme  /* <default|dark|forest|neutral> */
    };

    /* Markdown converts to HTML */
    $("pre").has("code.language-mermaid").each(function() {
      let svgCode = $(this).children().html();
      $(this).addClass("unloaded");
      $(this).after(`<div class=\"mermaid\">${svgCode}</div>`);
    });

    mermaid.initialize(mermaidConf);
  });
</script>

    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    <!--
  Jekyll Simple Search loader
  v2.0
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2017-2019 Cotes Chung
  MIT License
-->





<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="https://rito15.github.io{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    <div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div>    <div><i class="fa fa-tag fa-fw"></i>{tags}</div>  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No result founds.</p>'
});
</script>


    <!-- 2021-06-29 추가 : 애널리틱스 적용 -->
    <!--
  The GA snippet
  v2.0
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2017-2019 Cotes Chung
  MIT License
-->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-200391565-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-200391565-1');
</script>


  </body>

</html>

